<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <meta name="theme-color" content="#0b0f14" />

  <link rel="stylesheet" href="assets/app.css" />
</head>

<body class="dark">
  <div class="topbar">
    <div class="brand">
      <div class="logo-badge">F</div>
      <div class="brand-text">
        <div class="brand-title">Client Portal</div>
        <div class="brand-sub">Agreements • Signatures • Delivery</div>
      </div>
    </div>

    <div class="topbar-actions">
      <a class="btn btn-ghost" href="create.html">New Agreement</a>
      <button class="btn btn-ghost" id="logoutBtn">Logout</button>
    </div>
  </div>

  <main class="container">
    <div class="page-head">
      <h1>Dashboard</h1>
      <p>Manage agreements, view audit history, and send documents.</p>
    </div>

    <div class="grid-2">
      <!-- LEFT -->
      <section class="card">
        <h2 class="card-title">Active Agreement</h2>
        <p class="card-sub">Current envelope and status.</p>

        <div id="docBox" class="info-box"></div>

        <div class="actions">
          <a class="btn btn-primary" href="create.html">Create / Edit</a>
          <a class="btn btn-outline" href="sign.html">Fill + Sign</a>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <h2 class="card-title">Audit Trail</h2>
        <p class="card-sub">Recent events for the envelope.</p>

        <div id="auditBox" class="audit-list"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px;">
      <h2 class="card-title">Completed Document</h2>
      <p class="card-sub">If the PDF has been signed, you can preview and download it here.</p>

      <div id="signedPanel" class="signed-panel"></div>
    </section>
  </main>

  <!-- Load app.js as a script, not a link -->
  <script src="assets/app.js"></script>

  <script>
    // Guard: must be logged in
    FSS.guard();

    // Ensure doc exists
    if(!FSS.loadDocState()){
      FSS.resetDoc();
      FSS.logAudit("Envelope created (auto).");
    }

    // Populate active doc
    const d = FSS.loadDocState();
    const docBox = document.getElementById("docBox");

    docBox.innerHTML = `
      <div class="kv">
        <div><span>Envelope ID</span><strong>${FSS.escape(d.id)}</strong></div>
        <div><span>Status</span><strong class="pill">${FSS.escape(d.status)}</strong></div>
        <div><span>Template</span><strong>${FSS.escape(d.template)}</strong></div>
      </div>

      <div class="divider"></div>

      <div class="kv">
        <div><span>Sender</span><strong>${FSS.escape(d.parties.aName || "—")}</strong></div>
        <div><span>Sender Email</span><strong>${FSS.escape(d.parties.aEmail || "—")}</strong></div>
        <div><span>Recipient</span><strong>${FSS.escape(d.parties.bName || "—")}</strong></div>
        <div><span>Recipient Email</span><strong>${FSS.escape(d.parties.bEmail || "—")}</strong></div>
      </div>
    `;

    // Populate audit
    const audit = FSS.loadAudit();
    const auditBox = document.getElementById("auditBox");

    if(!audit || audit.length === 0){
      auditBox.innerHTML = `<div class="muted">No activity yet.</div>`;
    } else {
      auditBox.innerHTML = audit.slice(0, 10).map(a => `
        <div class="audit-row">
          <div class="audit-time">${FSS.escape(a.at)}</div>
          <div class="audit-msg">${FSS.escape(a.msg)}</div>
        </div>
      `).join("");
    }

    // Signed PDF preview + download
    const signedPanel = document.getElementById("signedPanel");

    if(FSS.hasSignedPDF()){
      const b64 = FSS.getSignedBase64();
      const url = "data:application/pdf;base64," + b64;

      signedPanel.innerHTML = `
        <div class="signed-actions">
          <a class="btn btn-primary" href="${url}" download="signed_${FSS.escape(d.template)}">Download Signed PDF</a>
          <a class="btn btn-outline" href="${url}" target="_blank" rel="noreferrer">Open in New Tab</a>
        </div>
        <div class="pdf-frame">
          <iframe src="${url}" title="Signed PDF Preview"></iframe>
        </div>
      `;
    } else {
      signedPanel.innerHTML = `
        <div class="muted">
          No signed PDF yet. Go to <strong>Fill + Sign</strong> to complete the document.
        </div>
      `;
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });
  </script>
</body>
</html>
