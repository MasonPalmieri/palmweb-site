<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Demo • Create</title>

  <!-- Keep your theme -->
  <link rel="stylesheet" href="assets/app.css" />
</head>

<body class="app">
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo-badge">FSS</div>
        <div class="brand-text">
          <strong>Client Demo</strong>
          <span>Fill → Sign → Send</span>
        </div>
      </div>

      <nav class="topnav">
        <a class="toplink" href="dashboard.html">Dashboard</a>
        <a class="toplink active" href="create.html">Create</a>
        <a class="toplink" href="sign.html">Sign</a>
        <a class="toplink" href="success.html">Completed</a>
      </nav>

      <div class="topbar-right">
        <span class="pill" id="userPill">—</span>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="page-inner two-col">
      <!-- LEFT: NDA Express style builder -->
      <section class="panel left">
        <div class="panel-head">
          <h1>Create</h1>
          <p class="sub">
            Choose a template, upload a PDF, or build from scratch (NDA Express style).
          </p>
        </div>

        <div class="card">
          <div class="segmented">
            <button class="seg-btn active" id="tabScratch" type="button">Build from scratch</button>
            <button class="seg-btn" id="tabTemplate" type="button">Template</button>
            <button class="seg-btn" id="tabUpload" type="button">Upload PDF</button>
          </div>

          <!-- SCRATCH (default) -->
          <div class="seg-panel show" id="panelScratch">
            <div class="form-grid">
              <label class="field full">
                Agreement Title
                <input id="scratchTitle" type="text" placeholder="Example: Mutual Non-Disclosure Agreement" />
              </label>

              <div class="divider"></div>

              <div class="section-title">Parties</div>

              <label class="field">
                Party A Name
                <input id="aName" type="text" placeholder="Example: Company A, Inc." />
              </label>
              <label class="field">
                Party A Email
                <input id="aEmail" type="email" placeholder="a@company.com" />
              </label>

              <label class="field">
                Party B Name
                <input id="bName" type="text" placeholder="Example: Company B, LLC" />
              </label>
              <label class="field">
                Party B Email
                <input id="bEmail" type="email" placeholder="b@company.com" />
              </label>

              <div class="divider"></div>

              <div class="section-title">Rules / Options (NDA Express style)</div>

              <div class="checks">
                <label class="check"><input id="optMutual" type="checkbox" /> Mutual NDA</label>
                <label class="check"><input id="optOneWay" type="checkbox" /> One-way NDA</label>
                <label class="check"><input id="optNoCompete" type="checkbox" /> Include non-compete</label>
                <label class="check"><input id="optNoSolicit" type="checkbox" /> Include non-solicit</label>
                <label class="check"><input id="optInjunctive" type="checkbox" /> Injunctive relief</label>
                <label class="check"><input id="optReturnDestroy" type="checkbox" /> Return/Destroy confidential info</label>
              </div>

              <div class="form-grid">
                <label class="field">
                  Term (months)
                  <input id="optTerm" type="number" min="1" step="1" placeholder="12" />
                </label>

                <label class="field">
                  Governing Law (State)
                  <input id="optLaw" type="text" placeholder="Massachusetts" />
                </label>

                <label class="field full">
                  Purpose / Relationship
                  <input id="optPurpose" type="text" placeholder="Example: evaluating a potential partnership" />
                </label>
              </div>

              <div class="divider"></div>

              <div class="section-title">Agreement Body</div>

              <label class="field full">
                Clauses / Text
                <textarea id="scratchBody" rows="10" placeholder="Write the agreement text here… (or paste clauses)"></textarea>
              </label>

              <div class="hint">
                Tip: Use the Rules / Options above like NDA Express — then we auto-generate a clean PDF for signing.
              </div>
            </div>
          </div>

          <!-- TEMPLATE -->
          <div class="seg-panel" id="panelTemplate">
            <label class="field full">
              Template PDF
              <select id="templateSelect">
                <option value="nda.pdf">nda.pdf</option>
                <option value="confidentiality-agreement.pdf">confidentiality-agreement.pdf</option>
                <option value="non-compete-agreement.pdf">non-compete-agreement.pdf</option>
                <option value="release-of-liability.pdf">release-of-liability.pdf</option>
              </select>
            </label>

            <div class="hint">Templates are loaded from <code>/pdfs</code>.</div>
          </div>

          <!-- UPLOAD -->
          <div class="seg-panel" id="panelUpload">
            <label class="field full">
              Upload PDF
              <input id="uploadInput" type="file" accept="application/pdf" />
            </label>
            <div class="hint">Uploads are stored locally in your browser (Base64).</div>
          </div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn btn-primary" id="previewBtn" type="button">Preview PDF</button>
            <button class="btn btn-outline" id="saveBtn" type="button">Save & Go to Sign</button>
            <button class="btn btn-outline" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="status" id="statusBox" style="display:none;"></div>
        </div>
      </section>

      <!-- RIGHT: PDF Preview -->
      <section class="panel right">
        <div class="pdf-shell">
          <div class="pdf-toolbar">
            <div class="pdf-title">
              <span class="pill">PDF</span>
              <strong id="pdfLabel">Preview</strong>
            </div>

            <div class="pdf-tools">
              <button class="btn btn-outline btn-small" id="openBtn" type="button">Open</button>
              <button class="btn btn-outline btn-small" id="refreshBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="pdf-view">
            <iframe id="pdfFrame" title="PDF Preview"></iframe>
          </div>

          <div class="pdf-foot" id="pdfFoot">No PDF selected. Choose Template, Upload, or Scratch.</div>
        </div>
      </section>
    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    // ============ Helpers ============
    const $ = (id) => document.getElementById(id);

    function showStatus(msg, good=false){
      const box = $("statusBox");
      box.style.display = "";
      box.className = "status " + (good ? "good" : "bad");
      box.textContent = msg;
    }
    function clearStatus(){
      const box = $("statusBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function setActiveTab(which){
      const tabs = {
        scratch: $("tabScratch"),
        template: $("tabTemplate"),
        upload: $("tabUpload")
      };
      const panels = {
        scratch: $("panelScratch"),
        template: $("panelTemplate"),
        upload: $("panelUpload")
      };

      Object.keys(tabs).forEach(k=>{
        tabs[k].classList.toggle("active", k === which);
        panels[k].classList.toggle("show", k === which);
      });
    }

    // ============ Guard ============
    if(!window.FSS){
      alert("FSS app.js failed to load. Check /assets/app.js path.");
      throw new Error("FSS missing");
    }
    FSS.guard();

    // Show user pill
    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    $("userPill").textContent = auth.email || "demo@client.com";

    // Ensure doc exists
    let doc = FSS.loadDocState();
    if(!doc) doc = FSS.resetDoc();
    FSS.setStage("create");

    // ============ Controls ============
    const frame = $("pdfFrame");
    const pdfLabel = $("pdfLabel");
    const pdfFoot = $("pdfFoot");

    const templateSelect = $("templateSelect");
    const uploadInput = $("uploadInput");

    // Load stored values
    templateSelect.value = doc.template || "nda.pdf";
    $("aName").value  = doc.parties?.aName || "";
    $("aEmail").value = doc.parties?.aEmail || "";
    $("bName").value  = doc.parties?.bName || "";
    $("bEmail").value = doc.parties?.bEmail || "";

    if(doc.builder){
      $("scratchTitle").value = doc.builder.title || "";
      $("scratchBody").value  = doc.builder.text || "";
      // Try to restore options if present
      const o = doc.builder.options || {};
      $("optMutual").checked = !!o.mutual;
      $("optOneWay").checked = !!o.oneway;
      $("optNoCompete").checked = !!o.nocompete;
      $("optNoSolicit").checked = !!o.nosolicit;
      $("optInjunctive").checked = !!o.injunctive;
      $("optReturnDestroy").checked = !!o.returndestroy;
      $("optTerm").value = o.term || "";
      $("optLaw").value = o.law || "";
      $("optPurpose").value = o.purpose || "";
    }

    // Default to scratch (NDA Express style)
    setActiveTab("scratch");

    // ============ Preview logic ============
    async function refreshPreview(){
      clearStatus();

      try{
        const d = FSS.loadDocState() || doc;

        // Uploaded?
        const upB64 = localStorage.getItem("fss_uploaded_pdf_b64");
        if(upB64 && $("panelUpload").classList.contains("show")){
          frame.src = FSS.base64ToBlobURL(upB64);
          pdfLabel.textContent = "Uploaded PDF";
          pdfFoot.textContent = "Showing uploaded PDF.";
          return;
        }

        // Scratch?
        if($("panelScratch").classList.contains("show")){
          // Create a builder object on the fly for preview
          const tmp = structuredClone(d);
          tmp.builder = {
            title: ($("scratchTitle").value || "Agreement").trim(),
            text: buildScratchText(),
            options: getOptionsSnapshot()
          };
          FSS.saveDocState(tmp);

          const bytes = await FSS.generateBuilderPDFBytes();
          if(!bytes) throw new Error("Builder PDF generation failed (pdf-lib).");

          // Convert bytes to base64 so we can blob it
          const b64 = (function arrayBufferToBase64(buffer){
            let binary = "";
            const bytes = new Uint8Array(buffer);
            for(let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
          })(bytes);

          frame.src = FSS.base64ToBlobURL(b64);
          pdfLabel.textContent = "Scratch Agreement";
          pdfFoot.textContent = "Showing scratch-built PDF (NDA Express style).";
          return;
        }

        // Template
        const tpl = templateSelect.value || "nda.pdf";
        frame.src = `pdfs/${encodeURIComponent(tpl)}`;
        pdfLabel.textContent = tpl;
        pdfFoot.textContent = "Showing template PDF.";
      }catch(err){
        console.error(err);
        showStatus("Preview failed. Open DevTools → Console for the exact error.");
      }
    }

    function getOptionsSnapshot(){
      return {
        mutual: $("optMutual").checked,
        oneway: $("optOneWay").checked,
        nocompete: $("optNoCompete").checked,
        nosolicit: $("optNoSolicit").checked,
        injunctive: $("optInjunctive").checked,
        returndestroy: $("optReturnDestroy").checked,
        term: ($("optTerm").value || "").trim(),
        law: ($("optLaw").value || "").trim(),
        purpose: ($("optPurpose").value || "").trim()
      };
    }

    // Builds NDA Express style preamble based on checkboxes
    function buildScratchText(){
      const title = ($("scratchTitle").value || "Agreement").trim();
      const a = ($("aName").value || "Party A").trim();
      const b = ($("bName").value || "Party B").trim();
      const o = getOptionsSnapshot();

      const mutualText = o.mutual ? "Mutual NDA (both parties disclose)." : "";
      const oneWayText = o.oneway ? "One-way NDA (one party discloses)." : "";
      const purpose = o.purpose ? `Purpose: ${o.purpose}` : "Purpose: business discussions.";
      const term = o.term ? `Term: ${o.term} months.` : "Term: 12 months.";
      const law = o.law ? `Governing law: ${o.law}.` : "Governing law: Massachusetts.";

      const extras = [];
      if(o.nocompete) extras.push("Non-compete included.");
      if(o.nosolicit) extras.push("Non-solicit included.");
      if(o.injunctive) extras.push("Injunctive relief included.");
      if(o.returndestroy) extras.push("Return/Destroy confidential information clause included.");

      const rulesLine = [mutualText, oneWayText].filter(Boolean).join(" ");
      const extrasLine = extras.length ? `Additional terms: ${extras.join(" ")}` : "";

      const body = ($("scratchBody").value || "").trim();

      return `
${title}

This Agreement is entered into by and between ${a} and ${b}.

${purpose}
${rulesLine}
${term}
${law}
${extrasLine}

${body || "1. Confidential Information. The parties agree to protect confidential information disclosed during discussions.\n\n2. Use Restrictions. Confidential information may only be used for the stated purpose.\n\n3. Return/Destruction. Upon request, each party will return or destroy confidential information.\n\n4. Miscellaneous. This Agreement is the entire agreement between the parties."}
      `.trim();
    }

    // ============ Tab handlers ============
    $("tabScratch").addEventListener("click", () => { setActiveTab("scratch"); refreshPreview(); });
    $("tabTemplate").addEventListener("click", () => {
      setActiveTab("template");
      // clear upload + builder when choosing template
      localStorage.removeItem("fss_uploaded_pdf_b64");
      localStorage.removeItem("fss_uploaded_pdf_name");
      const d = FSS.loadDocState() || doc;
      d.builder = null;
      d.template = templateSelect.value;
      FSS.saveDocState(d);
      refreshPreview();
    });
    $("tabUpload").addEventListener("click", () => { setActiveTab("upload"); refreshPreview(); });

    templateSelect.addEventListener("change", () => {
      const d = FSS.loadDocState() || doc;
      d.template = templateSelect.value;
      d.builder = null;
      FSS.saveDocState(d);
      refreshPreview();
    });

    uploadInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      try{
        const buf = await file.arrayBuffer();
        let binary = "";
        const bytes = new Uint8Array(buf);
        for(let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
        const b64 = btoa(binary);

        localStorage.setItem("fss_uploaded_pdf_b64", b64);
        localStorage.setItem("fss_uploaded_pdf_name", file.name);

        // Upload overrides builder
        const d = FSS.loadDocState() || doc;
        d.builder = null;
        FSS.saveDocState(d);

        setActiveTab("upload");
        refreshPreview();
      }catch(err){
        console.error(err);
        showStatus("Upload failed. Check console for details.");
      }
    });

    // ============ Actions ============
    $("previewBtn").addEventListener("click", refreshPreview);
    $("refreshBtn").addEventListener("click", refreshPreview);

    $("openBtn").addEventListener("click", () => {
      if(frame.src) window.open(frame.src, "_blank");
    });

    $("saveBtn").addEventListener("click", async () => {
      clearStatus();

      const d = FSS.loadDocState() || doc;

      // Save parties
      d.parties = d.parties || {};
      d.parties.aName = $("aName").value.trim();
      d.parties.aEmail = $("aEmail").value.trim();
      d.parties.bName = $("bName").value.trim();
      d.parties.bEmail = $("bEmail").value.trim();

      if($("panelScratch").classList.contains("show")){
        d.builder = {
          title: ($("scratchTitle").value || "Agreement").trim(),
          text: buildScratchText(),
          options: getOptionsSnapshot(),
          selectedClauseIds: [],
          customClauses: []
        };
        // Scratch overrides template/upload
        d.template = null;
        localStorage.removeItem("fss_uploaded_pdf_b64");
        localStorage.removeItem("fss_uploaded_pdf_name");
      }

      if($("panelTemplate").classList.contains("show")){
        d.template = templateSelect.value;
        d.builder = null;
      }

      if($("panelUpload").classList.contains("show")){
        // d.builder already null; upload stored separately
        d.template = null;
      }

      FSS.saveDocState(d);

      // Reset sign artifacts
      FSS.saveFields([]);
      FSS.saveValues({});
      FSS.setSignedBase64(null);

      await refreshPreview();
      location.href = "sign.html";
    });

    $("resetBtn").addEventListener("click", () => {
      FSS.resetDoc();
      localStorage.removeItem("fss_uploaded_pdf_b64");
      localStorage.removeItem("fss_uploaded_pdf_name");
      location.reload();
    });

    $("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    // Initial preview
    refreshPreview();
  </script>
</body>
</html>