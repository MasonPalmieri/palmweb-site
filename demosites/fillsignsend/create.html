<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Demo • Create</title>

  <!-- Your real app stylesheet -->
  <link rel="stylesheet" href="assets/app.css" />

  <!-- Fallback styles so NOTHING goes invisible if app.css fails -->
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70);
      --blue:#43cbff; --green:#60ff9d;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(67,203,255,.16), transparent 60%),
        radial-gradient(1200px 700px at 90% 0%, rgba(96,255,157,.12), transparent 60%),
        var(--bg);
      color: var(--text);
    }
    a{ color:inherit; }
    code{ background: rgba(0,0,0,.35); padding:2px 6px; border-radius:8px; }
    .wrap{ max-width: 1180px; margin:0 auto; padding: 22px 18px 70px; }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:16px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 950;
    }
    .brand strong{ display:block; font-weight:950; }
    .brand span{ display:block; font-size:12px; color:var(--muted); font-weight:800; }

    .grid{ display:grid; grid-template-columns: .95fr 1.05fr; gap:14px; align-items:start; }
    @media(max-width:980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      padding: 16px;
      backdrop-filter: blur(12px);
    }
    h2{ margin:0 0 6px; font-size:16px; font-weight:950; letter-spacing:-.2px; }
    .muted{ margin:0 0 12px; color:var(--muted); font-weight:750; font-size:13px; line-height:1.45; }

    /* Minimal buttons if app.css is missing */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight: 900;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn-primary{
      background: linear-gradient(135deg, var(--blue), var(--green));
      border-color: transparent;
      color:#04101a;
      box-shadow: 0 16px 40px rgba(67,203,255,.14);
    }
    .btn-outline{ background: rgba(255,255,255,.06); }

    label{ display:flex; flex-direction:column; gap:6px; font-weight:900; font-size:13px; color: rgba(255,255,255,.86); }
    input, select, textarea{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.95);
      outline:none;
      font-size: 14px;
      font-weight: 850;
    }
    textarea{ min-height: 130px; resize: vertical; }

    .seg{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 12px; }
    .seg button{ flex:1 1 auto; min-width:140px; }

    .panel{
      display:none;
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .panel.show{ display:block; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hint{ margin-top: 10px; font-size: 12px; color: rgba(255,255,255,.60); font-weight: 750; line-height: 1.45; }

    .preview{
      padding:0;
      overflow:hidden;
      height: min(72vh, 760px);
      display:flex;
      flex-direction:column;
    }
    .preview-bar{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      white-space: nowrap;
    }
    iframe{ width:100%; height:100%; border:0; background:#111; display:block; flex: 1 1 auto; }

    .error-banner{
      display:none;
      margin-bottom: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,79,99,.35);
      background: rgba(255,79,99,.12);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      line-height: 1.45;
    }
    .error-banner.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="error-banner" id="errBanner"></div>

    <div class="top">
      <div class="brand">
        <div class="logo">FSS</div>
        <div>
          <strong>Client Demo</strong>
          <span>Create • Template / Upload / Scratch</span>
        </div>
      </div>

      <div class="row" style="flex: 0 0 auto;">
        <a class="btn btn-outline" href="dashboard.html">Dashboard</a>
        <a class="btn btn-outline" href="sign.html">Sign</a>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Create an Agreement</h2>
        <p class="muted">
          Choose a template, upload a PDF, or build an agreement from scratch.
        </p>

        <div class="seg">
          <button class="btn btn-primary" id="tabTemplate" type="button">Template</button>
          <button class="btn btn-outline" id="tabUpload" type="button">Upload PDF</button>
          <button class="btn btn-outline" id="tabScratch" type="button">Build from scratch</button>
        </div>

        <!-- TEMPLATE -->
        <div class="panel show" id="panelTemplate">
          <label>
            Template PDF
            <select id="templateSelect">
              <option value="nda.pdf">nda.pdf</option>
              <option value="non-compete-agreement.pdf">non-compete-agreement.pdf</option>
              <option value="release-of-liability.pdf">release-of-liability.pdf</option>
              <option value="confidentiality-agreement.pdf">confidentiality-agreement.pdf</option>
            </select>
          </label>

          <div class="hint">Templates live in <code>/pdfs</code>.</div>
        </div>

        <!-- UPLOAD -->
        <div class="panel" id="panelUpload">
          <label>
            Upload a PDF
            <input id="uploadInput" type="file" accept="application/pdf" />
          </label>
          <div class="hint">Uploads are stored locally (Base64 in localStorage).</div>
        </div>

        <!-- SCRATCH -->
        <div class="panel" id="panelScratch">
          <label>
            Agreement Title
            <input id="scratchTitle" type="text" placeholder="Example: Mutual NDA Agreement" />
          </label>

          <label style="margin-top:10px;">
            Agreement Body (editable)
            <textarea id="scratchBody" placeholder="Start typing the agreement text..."></textarea>
          </label>

          <div class="hint">
            This generates a real PDF (pdf-lib) so signing works like templates.
          </div>
        </div>

        <hr style="border:0; height:1px; background: rgba(255,255,255,.08); margin: 14px 0;" />

        <h2>Parties</h2>
        <p class="muted">These values flow into signing (demo).</p>

        <label>Sender Name <input id="aName" type="text" placeholder="Sender full name" /></label>
        <label>Sender Email <input id="aEmail" type="email" placeholder="sender@email.com" /></label>

        <label style="margin-top:10px;">Recipient Name <input id="bName" type="text" placeholder="Recipient full name" /></label>
        <label>Recipient Email <input id="bEmail" type="email" placeholder="recipient@email.com" /></label>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-primary" id="saveBtn" type="button">Save & Continue</button>
          <button class="btn btn-outline" id="resetBtn" type="button">Reset Envelope</button>
        </div>

        <div class="hint">
          After saving, go to Sign to place Signature / Date / Text fields.
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card preview">
        <div class="preview-bar">
          <span class="pill" id="previewPill">PDF • Preview</span>
          <div class="row" style="flex:0 0 auto;">
            <button class="btn btn-outline" id="openPdfBtn" type="button">Open</button>
            <button class="btn btn-outline" id="refreshBtn" type="button">Refresh</button>
          </div>
        </div>
        <iframe id="pdfFrame" title="PDF Preview"></iframe>
      </div>
    </div>
  </div>

  <!-- IMPORTANT: defer prevents timing issues -->
  <script src="assets/app.js" defer></script>

  <script>
    // Run AFTER app.js loads (or show a clear error)
    window.addEventListener("DOMContentLoaded", () => {
      const errBanner = document.getElementById("errBanner");

      function fail(msg){
        errBanner.classList.add("show");
        errBanner.innerHTML =
          msg +
          `<div style="margin-top:8px; font-weight:800; opacity:.9;">
            Check these URLs:
            <div>• <code>${location.origin + location.pathname.replace(/create\\.html$/,'')}assets/app.js</code></div>
            <div>• <code>${location.origin + location.pathname.replace(/create\\.html$/,'')}assets/app.css</code></div>
          </div>`;
      }

      if(!window.FSS){
        fail("❌ <strong>app.js did not load</strong> (FSS is undefined). None of the buttons can work until that is fixed.");
        return;
      }

      // ========= NORMAL APP =========
      FSS.guard();

      const doc = FSS.loadDocState() || FSS.resetDoc();
      FSS.setStage("create");

      // Tabs
      const tabTemplate = document.getElementById("tabTemplate");
      const tabUpload   = document.getElementById("tabUpload");
      const tabScratch  = document.getElementById("tabScratch");

      const panelTemplate = document.getElementById("panelTemplate");
      const panelUpload   = document.getElementById("panelUpload");
      const panelScratch  = document.getElementById("panelScratch");

      function showPanel(which){
        panelTemplate.classList.remove("show");
        panelUpload.classList.remove("show");
        panelScratch.classList.remove("show");

        tabTemplate.classList.remove("btn-primary"); tabTemplate.classList.add("btn-outline");
        tabUpload.classList.remove("btn-primary");   tabUpload.classList.add("btn-outline");
        tabScratch.classList.remove("btn-primary");  tabScratch.classList.add("btn-outline");

        if(which === "template"){
          panelTemplate.classList.add("show");
          tabTemplate.classList.add("btn-primary"); tabTemplate.classList.remove("btn-outline");
        }
        if(which === "upload"){
          panelUpload.classList.add("show");
          tabUpload.classList.add("btn-primary"); tabUpload.classList.remove("btn-outline");
        }
        if(which === "scratch"){
          panelScratch.classList.add("show");
          tabScratch.classList.add("btn-primary"); tabScratch.classList.remove("btn-outline");
        }
      }

      tabTemplate.addEventListener("click", () => showPanel("template"));
      tabUpload.addEventListener("click", () => showPanel("upload"));
      tabScratch.addEventListener("click", () => showPanel("scratch"));

      // Inputs
      const templateSelect = document.getElementById("templateSelect");
      const uploadInput    = document.getElementById("uploadInput");
      const scratchTitle   = document.getElementById("scratchTitle");
      const scratchBody    = document.getElementById("scratchBody");

      const aName = document.getElementById("aName");
      const aEmail= document.getElementById("aEmail");
      const bName = document.getElementById("bName");
      const bEmail= document.getElementById("bEmail");

      // Load stored values
      templateSelect.value = doc.template || "nda.pdf";
      aName.value  = doc.parties?.aName || "";
      aEmail.value = doc.parties?.aEmail || "";
      bName.value  = doc.parties?.bName || "";
      bEmail.value = doc.parties?.bEmail || "";
      if(doc.builder){
        scratchTitle.value = doc.builder.title || "";
        scratchBody.value  = doc.builder.text || "";
      }

      // Preview iframe
      const frame = document.getElementById("pdfFrame");
      const previewPill = document.getElementById("previewPill");

      async function refreshPreview(){
        try{
          const d = FSS.loadDocState() || doc;

          if(d.builder && d.builder.text){
            const bytes = await FSS.generateBuilderPDFBytes();
            if(!bytes) throw new Error("Builder PDF generation failed.");
            const b64 = (function arrayBufferToBase64(buffer){
              let binary = "";
              const bytes = new Uint8Array(buffer);
              for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
              return btoa(binary);
            })(bytes);
            frame.src = FSS.base64ToBlobURL(b64);
            previewPill.textContent = "PDF • Scratch-built";
            return;
          }

          const upB64 = localStorage.getItem("fss_uploaded_pdf_b64");
          if(upB64){
            frame.src = FSS.base64ToBlobURL(upB64);
            previewPill.textContent = "PDF • Uploaded";
            return;
          }

          const tpl = d.template || "nda.pdf";
          frame.src = `pdfs/${encodeURIComponent(tpl)}`;
          previewPill.textContent = `PDF • Template: ${tpl}`;
        }catch(err){
          console.error(err);
          previewPill.textContent = "PDF • Preview failed (console)";
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", refreshPreview);
      document.getElementById("openPdfBtn").addEventListener("click", () => frame.src && window.open(frame.src, "_blank"));

      // Template change
      templateSelect.addEventListener("change", () => {
        const d = FSS.loadDocState() || doc;
        d.template = templateSelect.value;
        d.builder = null;

        localStorage.removeItem("fss_uploaded_pdf_b64");
        localStorage.removeItem("fss_uploaded_pdf_name");

        FSS.saveDocState(d);
        refreshPreview();
      });

      // Upload
      uploadInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        const buf = await file.arrayBuffer();
        const b64 = (function arrayBufferToBase64(buffer){
          let binary = "";
          const bytes = new Uint8Array(buffer);
          for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
          return btoa(binary);
        })(buf);

        localStorage.setItem("fss_uploaded_pdf_b64", b64);
        localStorage.setItem("fss_uploaded_pdf_name", file.name);

        const d = FSS.loadDocState() || doc;
        d.builder = null;
        FSS.saveDocState(d);

        showPanel("upload");
        refreshPreview();
      });

      // Save
      document.getElementById("saveBtn").addEventListener("click", async () => {
        const d = FSS.loadDocState() || doc;

        d.parties = d.parties || {};
        d.parties.aName  = aName.value.trim();
        d.parties.aEmail = aEmail.value.trim();
        d.parties.bName  = bName.value.trim();
        d.parties.bEmail = bEmail.value.trim();

        if(panelScratch.classList.contains("show")){
          d.builder = {
            title: (scratchTitle.value || "Agreement").trim(),
            text: (scratchBody.value || "").trim(),
            selectedClauseIds: [],
            customClauses: []
          };
          localStorage.removeItem("fss_uploaded_pdf_b64");
          localStorage.removeItem("fss_uploaded_pdf_name");
        }

        if(panelTemplate.classList.contains("show")){
          d.template = templateSelect.value;
          d.builder = null;
          localStorage.removeItem("fss_uploaded_pdf_b64");
          localStorage.removeItem("fss_uploaded_pdf_name");
        }

        FSS.saveDocState(d);
        FSS.saveFields([]);
        FSS.saveValues({});
        FSS.setSignedBase64(null);

        await refreshPreview();
        location.href = "sign.html";
      });

      // Reset
      document.getElementById("resetBtn").addEventListener("click", () => {
        FSS.resetDoc();
        location.reload();
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        FSS.logout();
        location.href = "index.html";
      });

      // Default tab
      (function initTab(){
        const hasUpload = !!localStorage.getItem("fss_uploaded_pdf_b64");
        const d = FSS.loadDocState() || doc;
        if(hasUpload) showPanel("upload");
        else if(d.builder && d.builder.text) showPanel("scratch");
        else showPanel("template");
      })();

      refreshPreview();
    });
  </script>
</body>
</html>