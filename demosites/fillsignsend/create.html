<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Agreement • FSS Demo</title>

  <link rel="stylesheet" href="assets/app.css" />

  <!-- pdf-lib to generate scratch PDFs -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 12px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      padding: 14px;
    }

    h1{
      margin: 0 0 6px;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:-.2px;
    }
    p{
      margin:0;
      color: rgba(255,255,255,.72);
      font-weight: 750;
      font-size: 13px;
      line-height: 1.5;
    }

    label{
      display:block;
      font-weight: 900;
      font-size: 13px;
      margin-top: 10px;
      color: rgba(255,255,255,.86);
    }

    input, select, textarea{
      width:100%;
      margin-top: 6px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight: 750;
    }

    select option{
      background: #0b0f18;
      color: rgba(255,255,255,.92);
    }

    textarea{
      min-height: 250px;
      resize: vertical;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .btn-row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.84);
    }
    .status.good{ border-color: rgba(96,255,157,.30); background: rgba(96,255,157,.08); }
    .status.warn{ border-color: rgba(255,196,82,.30); background: rgba(255,196,82,.08); }
    .status.bad{ border-color: rgba(255,79,99,.30); background: rgba(255,79,99,.08); }

    .tiny{
      font-size: 12px;
      color: rgba(255,255,255,.60);
      margin-top: 8px;
      font-weight: 750;
      line-height: 1.4;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="app">
  <header class="app-top">
    <div class="app-top-inner">
      <a class="app-brand" href="dashboard.html">
        <span class="logo-badge">FSS</span>
        <div class="brand-text">
          <strong>Client Demo</strong>
          <span>Fill → Sign → Send</span>
        </div>
      </a>

      <div class="app-nav">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link active" href="create.html">Create</a>
        <a class="nav-link" href="sign.html">Sign</a>
        <a class="nav-link" href="success.html">Completed</a>
      </div>

      <div class="app-user">
        <span id="userEmail" class="user-pill">—</span>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1>Create an Agreement</h1>
    <p>Choose a template, upload your own PDF, or build an agreement from scratch.</p>

    <div class="grid">
      <!-- LEFT: Parties + Template -->
      <section class="card">
        <h2 style="margin:0;font-size:14px;font-weight:950;">Template + Parties</h2>
        <p class="tiny">Template dropdown is fixed and readable. Upload or builder overrides template.</p>

        <label>Template PDF</label>
        <select id="templateSelect">
          <option value="">Select a template…</option>
          <option value="nda.pdf">nda.pdf</option>
          <option value="consulting_agreement.pdf">consulting_agreement.pdf</option>
          <option value="event-accident-waiver.pdf">event-accident-waiver.pdf</option>
          <option value="lease-waiver.pdf">lease-waiver.pdf</option>
          <option value="Photo-Release.pdf">Photo-Release.pdf</option>
          <option value="non-compete-agreement.pdf">non-compete-agreement.pdf</option>
          <option value="real-estate-agreement.pdf">real-estate-agreement.pdf</option>
        </select>

        <label>Upload PDF (optional)</label>
        <input id="uploadPdf" type="file" accept="application/pdf" />

        <div class="tiny">
          Uploading a PDF will override the template selection.
        </div>

        <div style="height:10px;"></div>

        <label>Sender name</label>
        <input id="aName" placeholder="Sender full name" />

        <label>Sender email</label>
        <input id="aEmail" type="email" placeholder="sender@email.com" />

        <label>Recipient name</label>
        <input id="bName" placeholder="Recipient full name" />

        <label>Recipient email</label>
        <input id="bEmail" type="email" placeholder="recipient@email.com" />

        <div class="btn-row">
          <button class="btn btn-primary" id="saveBtn" type="button">Save & Continue</button>
          <button class="btn btn-outline" id="resetBtn" type="button">Reset</button>
        </div>

        <div class="status warn" id="statusBox" style="display:none;"></div>
      </section>

      <!-- RIGHT: Scratch builder -->
      <section class="card">
        <h2 style="margin:0;font-size:14px;font-weight:950;">Build from scratch</h2>
        <p class="tiny">
          Write your agreement text here. Click Generate PDF to create a real PDF stored in-browser.
        </p>

        <label>Agreement title</label>
        <input id="scratchTitle" placeholder="Confidential Agreement" />

        <label>Agreement body</label>
        <textarea id="scratchBody" placeholder="Type your agreement terms here..."></textarea>

        <div class="btn-row">
          <button class="btn btn-muted" id="generateScratchBtn" type="button">Generate PDF from scratch</button>
          <button class="btn btn-outline" id="clearScratchBtn" type="button">Clear</button>
        </div>

        <div class="tiny">
          Tip: keep it ~1–2 pages for best demo flow.
        </div>
      </section>
    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    FSS.guard();

    const user = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userEmail").textContent = user.email || "demo@client.com";

    const statusBox = document.getElementById("statusBox");
    function showStatus(type, msg){
      statusBox.style.display = "";
      statusBox.className = "status " + type;
      statusBox.textContent = msg;
    }
    function clearStatus(){
      statusBox.style.display = "none";
      statusBox.textContent = "";
    }

    let doc = FSS.loadDocState();
    if(!doc){
      FSS.resetDoc();
      doc = FSS.loadDocState();
    }

    const templateSelect = document.getElementById("templateSelect");
    const uploadPdf = document.getElementById("uploadPdf");

    const aName = document.getElementById("aName");
    const aEmail = document.getElementById("aEmail");
    const bName = document.getElementById("bName");
    const bEmail = document.getElementById("bEmail");

    // preload existing
    templateSelect.value = doc.template || "";
    aName.value = doc.parties?.aName || "";
    aEmail.value = doc.parties?.aEmail || "";
    bName.value = doc.parties?.bName || "";
    bEmail.value = doc.parties?.bEmail || "";

    function fileToBase64(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result).split(",")[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    uploadPdf.addEventListener("change", async () => {
      clearStatus();
      const file = uploadPdf.files?.[0];
      if(!file) return;

      try{
        const b64 = await fileToBase64(file);

        doc = FSS.loadDocState() || {};
        doc.customPdfBase64 = b64;
        doc.template = ""; // override templates
        doc.customPdfName = file.name || "uploaded.pdf";
        FSS.saveDocState(doc);

        // reset signing artifacts
        FSS.removeSigned?.();
        FSS.saveFields([]);

        showStatus("good", `✅ Uploaded PDF stored: ${file.name}`);
      }catch(err){
        console.error(err);
        showStatus("bad", "Upload failed. Try again.");
      }
    });

    // Scratch builder PDF generation
    function wrapText(text, maxLen){
      const words = text.split(/\s+/);
      const lines = [];
      let line = "";
      for(const w of words){
        if((line + " " + w).trim().length > maxLen){
          lines.push(line.trim());
          line = w;
        } else {
          line += " " + w;
        }
      }
      if(line.trim()) lines.push(line.trim());
      return lines;
    }

    function uint8ToBase64(uint8){
      let binary = "";
      const chunk = 0x8000;
      for(let i=0;i<uint8.length;i+=chunk){
        const sub = uint8.subarray(i, i+chunk);
        binary += String.fromCharCode(...sub);
      }
      return btoa(binary);
    }

    document.getElementById("generateScratchBtn").addEventListener("click", async () => {
      clearStatus();

      const title = document.getElementById("scratchTitle").value.trim() || "Agreement";
      const body = document.getElementById("scratchBody").value.trim();

      if(!body){
        showStatus("warn", "Add agreement text first.");
        return;
      }

      try{
        if(!window.PDFLib){
          showStatus("bad", "pdf-lib not loaded. Check network.");
          return;
        }

        const { PDFDocument, StandardFonts, rgb } = window.PDFLib;

        const pdfDoc = await PDFDocument.create();
        const page = pdfDoc.addPage([612, 792]);
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

        const margin = 54;
        let y = 740;

        page.drawText(title, {
          x: margin,
          y,
          size: 18,
          font,
          color: rgb(0.1,0.1,0.1)
        });

        y -= 26;

        const lines = wrapText(body, 90);
        for(const line of lines){
          if(y < 90){
            // new page
            const p = pdfDoc.addPage([612, 792]);
            y = 740;
            p.drawText(line, { x: margin, y, size: 12, font, color: rgb(0.15,0.15,0.15) });
            y -= 18;
            continue;
          }
          page.drawText(line, { x: margin, y, size: 12, font, color: rgb(0.15,0.15,0.15) });
          y -= 18;
        }

        // Add simple signature lines at bottom
        const sigY = 120;
        page.drawText("Sender Signature: ______________________", { x: margin, y: sigY, size: 12, font });
        page.drawText("Date: ______________________", { x: margin, y: sigY - 22, size: 12, font });

        const bytes = await pdfDoc.save();
        const b64 = uint8ToBase64(bytes);

        doc = FSS.loadDocState() || {};
        doc.customPdfBase64 = b64;
        doc.customPdfName = `${title.replace(/\s+/g,"-").toLowerCase()}.pdf`;
        doc.template = "";
        FSS.saveDocState(doc);

        // reset signing artifacts
        FSS.removeSigned?.();
        FSS.saveFields([]);

        showStatus("good", `✅ Scratch PDF generated: ${doc.customPdfName}`);
      }catch(err){
        console.error(err);
        showStatus("bad", "Scratch PDF generation failed. Check console.");
      }
    });

    document.getElementById("clearScratchBtn").addEventListener("click", () => {
      document.getElementById("scratchTitle").value = "";
      document.getElementById("scratchBody").value = "";
      clearStatus();
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
      clearStatus();

      const t = templateSelect.value;
      const A = aName.value.trim();
      const AE = aEmail.value.trim();
      const B = bName.value.trim();
      const BE = bEmail.value.trim();

      if(!A || !B){
        showStatus("warn", "Please enter sender + recipient names.");
        return;
      }

      doc = FSS.loadDocState() || {};
      doc.parties = { aName: A, aEmail: AE, bName: B, bEmail: BE };

      // only set template if no custom PDF exists
      if(!doc.customPdfBase64){
        if(!t){
          showStatus("warn", "Choose a template OR upload/build a PDF.");
          return;
        }
        doc.template = t;
      }

      doc.status = "draft";
      if(!doc.id) doc.id = Date.now().toString();
      FSS.saveDocState(doc);

      // reset prior signing info when creating new
      FSS.removeSigned?.();
      FSS.saveFields([]);

      showStatus("good", "✅ Saved. Redirecting to Sign…");
      setTimeout(() => location.href="sign.html", 600);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      if(!confirm("Reset and clear the current agreement?")) return;
      FSS.resetDoc();
      FSS.saveFields([]);
      FSS.removeSigned?.();
      location.reload();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });
  </script>
</body>
</html>
