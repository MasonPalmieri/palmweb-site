<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create ‚Ä¢ Client Demo</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    .wrap{ max-width: 1200px; margin:0 auto; padding: 18px 18px 46px; }

    .page-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .page-head h1{
      margin: 0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -0.2px;
    }
    .page-head p{
      margin: 6px 0 0;
      font-size: 13px;
      color: rgba(255,255,255,.70);
      font-weight: 750;
      max-width: 80ch;
      line-height: 1.5;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      padding: 14px;
    }

    .card h2{
      margin: 0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: -0.1px;
    }

    .muted{
      margin: 8px 0 0;
      color: rgba(255,255,255,.70);
      font-weight: 750;
      font-size: 13px;
      line-height: 1.5;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .tab{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .tab:hover{ background: rgba(255,255,255,.10); }
    .tab.active{
      border-color: rgba(255,73,128,.45);
      background: rgba(255,73,128,.12);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 10px;
    }
    @media(max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.60);
      display:block;
      margin-bottom: 6px;
    }

    input, select, textarea{
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      font-weight: 850;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,73,128,.55);
      box-shadow: 0 0 0 4px rgba(255,73,128,.10);
    }

    /* üî• Fix invisible dropdown options */
    select option{
      background: #141416;
      color: #fff;
    }

    textarea{
      min-height: 140px;
      resize: vertical;
      line-height: 1.5;
      font-weight: 800;
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
      justify-content:flex-end;
    }

    .btn{
      border-radius: 14px;
      font-weight: 950;
      padding: 12px 16px;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      border: 0;
      background: linear-gradient(135deg, rgba(255,73,128,.95), rgba(255,126,73,.95));
      color: #0a0a0a;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.84);
      display:none;
    }
    .status.good{ display:block; border-color: rgba(96,255,157,.30); background: rgba(96,255,157,.08); }
    .status.warn{ display:block; border-color: rgba(255,196,82,.30); background: rgba(255,196,82,.08); }
    .status.bad { display:block; border-color: rgba(255,79,99,.30); background: rgba(255,79,99,.08); }

    /* Scratch builder */
    .builder{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media(max-width: 980px){
      .builder{ grid-template-columns: 1fr; }
    }

    .clauseList{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .clauseItem{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      cursor:pointer;
    }
    .clauseItem:hover{ background: rgba(255,255,255,.06); }
    .clauseItem input{ width:auto; margin-top: 2px; }
    .clauseItem strong{
      display:block;
      font-weight: 950;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      margin-bottom: 4px;
    }
    .clauseItem span{
      display:block;
      font-weight: 750;
      font-size: 12px;
      color: rgba(255,255,255,.65);
      line-height: 1.45;
    }

    .previewBox{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
      padding: 12px;
      max-height: 520px;
      overflow:auto;
    }
    .previewBox h3{
      margin:0 0 8px;
      font-size: 14px;
      font-weight: 950;
    }
    .previewText{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 13px;
      font-weight: 750;
      color: rgba(255,255,255,.82);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      width: fit-content;
      white-space: nowrap;
    }
    .pill .dot{ width: 9px; height: 9px; border-radius: 999px; background: rgba(255,196,82,.95); }

    .smallNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.58);
      font-weight: 750;
      line-height: 1.45;
    }
  </style>
</head>

<body class="app">
  <header class="app-top">
    <div class="app-top-inner">
      <a class="app-brand" href="dashboard.html">
        <span class="logo-badge">FSS</span>
        <div class="brand-text">
          <strong>Client Demo</strong>
          <span>Fill ‚Üí Sign ‚Üí Send</span>
        </div>
      </a>

      <div class="app-nav">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link active" href="create.html">Create</a>
        <a class="nav-link" href="sign.html">Sign</a>
        <a class="nav-link" href="success.html">Completed</a>
      </div>

      <div class="app-user">
        <span id="userEmail" class="user-pill">‚Äî</span>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1>Create Agreement</h1>
        <p>
          Choose a template, upload your own PDF, or build an agreement from scratch (NDA Express style).
          Then add Party A and Party B details and continue to signing.
        </p>
      </div>
      <div class="pill" id="modePill"><span class="dot"></span><span id="modeLabel">Template</span></div>
    </div>

    <div class="layout">
      <!-- SOURCE / MODE -->
      <section class="card">
        <h2>Agreement Source</h2>
        <p class="muted">
          Pick one option below. This becomes the agreement ‚Äúenvelope‚Äù stored in your browser for the demo.
        </p>

        <div class="tabs">
          <button class="tab active" id="tabTemplate" type="button">üìÑ Template PDF</button>
          <button class="tab" id="tabUpload" type="button">‚¨ÜÔ∏è Upload PDF</button>
          <button class="tab" id="tabScratch" type="button">‚ú® Build From Scratch</button>
        </div>

        <div class="divider"></div>

        <!-- TEMPLATE MODE -->
        <div id="panelTemplate">
          <div class="grid2">
            <div>
              <label for="templateSelect">Template PDF</label>
              <select id="templateSelect">
                <option value="nda.pdf">nda.pdf</option>
                <option value="consulting_agreement.pdf">consulting_agreement.pdf</option>
                <option value="non-compete-agreement.pdf">non-compete-agreement.pdf</option>
                <option value="lease-waiver.pdf">lease-waiver.pdf</option>
                <option value="event-accident-waiver.pdf">event-accident-waiver.pdf</option>
                <option value="real-estate-agreement.pdf">real-estate-agreement.pdf</option>
                <option value="Photo-Release.pdf">Photo-Release.pdf</option>
              </select>
              <div class="smallNote">
                These must exist under <strong>/pdfs/</strong> in your site folder.
              </div>
            </div>

            <div class="previewBox">
              <h3>What happens next?</h3>
              <div class="previewText">
1) Choose a template
2) Enter Party A + Party B
3) Continue ‚Üí Sign page
4) Place signature/date/text fields, drag them into position, double-click to edit
5) Sign as sender ‚Üí generate signed PDF
              </div>
            </div>
          </div>
        </div>

        <!-- UPLOAD MODE -->
        <div id="panelUpload" style="display:none;">
          <div class="grid2">
            <div>
              <label for="uploadInput">Upload PDF</label>
              <input id="uploadInput" type="file" accept="application/pdf" />
              <div class="smallNote">
                Uploaded PDF is stored as Base64 in localStorage for the demo.
              </div>
            </div>

            <div class="previewBox">
              <h3>Upload status</h3>
              <div class="previewText" id="uploadStatus">No PDF uploaded yet.</div>
            </div>
          </div>
        </div>

        <!-- SCRATCH MODE -->
        <div id="panelScratch" style="display:none;">
          <div class="builder">
            <!-- LEFT: clauses -->
            <div class="card" style="padding:14px;">
              <h2>Choose clauses</h2>
              <p class="muted" style="margin-top:8px;">
                Select the clauses you want included (NDA Express style). Add custom clauses if needed.
              </p>

              <div class="divider"></div>

              <label for="builderTitle">Agreement Title</label>
              <input id="builderTitle" value="Confidentiality Agreement" />

              <div class="divider"></div>

              <div class="clauseList" id="clauseList"></div>

              <div class="divider"></div>

              <button class="btn" id="addCustomBtn" type="button">‚ûï Add custom clause</button>
              <div class="smallNote">
                Custom clauses appear at the bottom of the agreement.
              </div>
            </div>

            <!-- RIGHT: preview -->
            <div class="card" style="padding:14px;">
              <h2>Agreement Preview</h2>
              <p class="muted" style="margin-top:8px;">
                This preview is what will become the generated PDF.
              </p>

              <div class="divider"></div>

              <div class="previewBox">
                <h3 id="previewTitle">Confidentiality Agreement</h3>
                <div class="previewText" id="previewText">Select clauses on the left‚Ä¶</div>
              </div>

              <div class="smallNote">
                Note: the PDF is built on the Sign page using your app.js builder generator.
                If that function is missing, we‚Äôll add it next.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PARTIES -->
      <section class="card">
        <h2>Party Information</h2>
        <p class="muted">
          These values populate the envelope and are used for sender signature defaults.
        </p>

        <div class="divider"></div>

        <div class="grid2">
          <div class="card" style="padding:14px;">
            <h2>Party A (Sender)</h2>
            <div class="divider"></div>

            <label>Company / Name</label>
            <input id="aName" placeholder="Company or individual name" />

            <label style="margin-top:10px;">Email</label>
            <input id="aEmail" placeholder="sender@email.com" />

            <label style="margin-top:10px;">Title (optional)</label>
            <input id="aTitle" placeholder="CEO / Manager / etc." />

            <label style="margin-top:10px;">Address (optional)</label>
            <input id="aAddr" placeholder="Street, City, State" />
          </div>

          <div class="card" style="padding:14px;">
            <h2>Party B (Recipient)</h2>
            <div class="divider"></div>

            <label>Company / Name</label>
            <input id="bName" placeholder="Company or individual name" />

            <label style="margin-top:10px;">Email</label>
            <input id="bEmail" placeholder="recipient@email.com" />

            <label style="margin-top:10px;">Title (optional)</label>
            <input id="bTitle" placeholder="VP / Director / etc." />

            <label style="margin-top:10px;">Address (optional)</label>
            <input id="bAddr" placeholder="Street, City, State" />
          </div>
        </div>

        <div class="btnbar">
          <button class="btn" id="resetBtn" type="button">Reset Envelope</button>
          <button class="btn primary" id="continueBtn" type="button">Continue to Sign ‚Üí</button>
        </div>

        <div class="status" id="statusBox"></div>
      </section>
    </div>
  </main>

  <script src="assets/app.js"></script>

  <script>
    // ========= AUTH =========
    FSS.guard();
    const user = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userEmail").textContent = user.email || "demo@client.com";
    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    // ========= STATE =========
    const statusBox = document.getElementById("statusBox");
    function setStatus(type, msg){
      statusBox.className = "status " + type;
      statusBox.textContent = msg;
    }
    function clearStatus(){
      statusBox.className = "status";
      statusBox.textContent = "";
    }

    function getDoc(){
      return FSS.loadDocState() || null;
    }
    function saveDoc(doc){
      FSS.saveDocState(doc);
    }

    // Ensure doc exists
    let doc = getDoc();
    if(!doc){
      FSS.resetDoc();
      doc = getDoc();
    }

    // ========= MODE TABS =========
    let mode = "template"; // template | upload | scratch

    const tabTemplate = document.getElementById("tabTemplate");
    const tabUpload = document.getElementById("tabUpload");
    const tabScratch = document.getElementById("tabScratch");

    const panelTemplate = document.getElementById("panelTemplate");
    const panelUpload = document.getElementById("panelUpload");
    const panelScratch = document.getElementById("panelScratch");

    const modePill = document.getElementById("modePill");
    const modeLabel = document.getElementById("modeLabel");

    function setMode(next){
      mode = next;

      [tabTemplate, tabUpload, tabScratch].forEach(x => x.classList.remove("active"));
      panelTemplate.style.display = "none";
      panelUpload.style.display = "none";
      panelScratch.style.display = "none";

      if(next === "template"){
        tabTemplate.classList.add("active");
        panelTemplate.style.display = "";
        modeLabel.textContent = "Template";
      }
      if(next === "upload"){
        tabUpload.classList.add("active");
        panelUpload.style.display = "";
        modeLabel.textContent = "Upload";
      }
      if(next === "scratch"){
        tabScratch.classList.add("active");
        panelScratch.style.display = "";
        modeLabel.textContent = "Build From Scratch";
      }
    }

    tabTemplate.addEventListener("click", () => setMode("template"));
    tabUpload.addEventListener("click", () => setMode("upload"));
    tabScratch.addEventListener("click", () => setMode("scratch"));

    // ========= TEMPLATE SELECT =========
    const templateSelect = document.getElementById("templateSelect");

    // ========= UPLOAD =========
    const uploadInput = document.getElementById("uploadInput");
    const uploadStatus = document.getElementById("uploadStatus");

    uploadInput.addEventListener("change", async () => {
      clearStatus();
      const file = uploadInput.files && uploadInput.files[0];
      if(!file){
        uploadStatus.textContent = "No PDF uploaded yet.";
        return;
      }
      if(file.type !== "application/pdf"){
        setStatus("bad", "Please upload a PDF file.");
        uploadInput.value = "";
        return;
      }

      uploadStatus.textContent = "Reading PDF‚Ä¶";

      const buf = await file.arrayBuffer();
      const bytes = new Uint8Array(buf);
      let binary = "";
      for(let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
      const b64 = btoa(binary);

      localStorage.setItem("fss_uploaded_pdf_b64", b64);
      localStorage.setItem("fss_uploaded_pdf_name", file.name);

      uploadStatus.textContent = `‚úÖ Uploaded: ${file.name}`;
      setStatus("good", "Uploaded PDF stored for demo. Continue when ready.");
    });

    // ========= SCRATCH BUILDER (NDA EXPRESS STYLE) =========
    const clauseListEl = document.getElementById("clauseList");
    const builderTitleEl = document.getElementById("builderTitle");
    const previewTitleEl = document.getElementById("previewTitle");
    const previewTextEl = document.getElementById("previewText");
    const addCustomBtn = document.getElementById("addCustomBtn");

    // NDA Express style clause library (checkbox rules)
    const CLAUSES = [
      {
        id: "exclusions",
        title: "Exclusions from Confidential Information",
        body:
`Receiving Party‚Äôs obligations do not extend to information that is:
(a) publicly known at the time of disclosure or becomes publicly known through no fault of Receiving Party;
(b) discovered or created by Receiving Party before disclosure by Disclosing Party;
(c) learned by Receiving Party through legitimate means other than from Disclosing Party or its representatives; or
(d) disclosed by Receiving Party with Disclosing Party‚Äôs prior written approval.`
      },
      {
        id: "obligations",
        title: "Obligations of Receiving Party",
        body:
`Receiving Party will keep the Confidential Information strictly confidential, limit access to employees/contractors with a need to know, and use at least the same degree of care as it uses to protect its own confidential information (no less than reasonable care).`
      },
      {
        id: "return_destroy",
        title: "Return and/or Destruction of Information",
        body:
`Upon Disclosing Party‚Äôs request, Receiving Party will promptly return or destroy all copies of Confidential Information and certify such return or destruction in writing, except to the extent retained in routine backups or as required by law.`
      },
      {
        id: "term",
        title: "Term and Termination",
        body:
`This Agreement begins on the Effective Date and continues until terminated by either Party upon written notice. The confidentiality obligations survive termination for a period of (2) years, except for trade secrets which remain protected as long as they remain trade secrets.`
      },
      {
        id: "ownership",
        title: "Ownership of Information",
        body:
`All Confidential Information and copies thereof remain the property of Disclosing Party. No rights are granted by implication or otherwise except as expressly stated herein.`
      },
      {
        id: "no_license",
        title: "No License or Transfer of Rights",
        body:
`Nothing in this Agreement grants any license, ownership, or transfer of intellectual property rights. Each Party retains all rights, title, and interest in its intellectual property.`
      },
      {
        id: "no_obligation",
        title: "No Obligation to Proceed",
        body:
`The Parties acknowledge that this Agreement does not create an obligation for either Party to proceed with any proposed transaction or relationship. Either Party may terminate discussions at any time without liability.`
      },
      {
        id: "no_warranty",
        title: "No Warranty",
        body:
`Confidential Information is provided ‚Äúas is.‚Äù Disclosing Party makes no warranties regarding accuracy or completeness, and disclaims all liability arising from its use.`
      },
      {
        id: "entire_agreement",
        title: "Entire Agreement and Severability",
        body:
`This Agreement constitutes the entire agreement between the Parties regarding the subject matter and supersedes prior agreements. If any provision is held invalid, the remaining provisions remain in effect.`
      },
      // Extra ‚ÄúNDA Express‚Äù flavor add-ons:
      {
        id: "no_photography",
        title: "No Photography / Videography / Audio Recording",
        body:
`Receiving Party agrees not to photograph, record video, or make audio recordings of Confidential Information, meetings, or materials without Disclosing Party‚Äôs prior written consent.`
      },
      {
        id: "no_social_media",
        title: "No Social Media",
        body:
`Receiving Party agrees not to post, mention, or reference Disclosing Party, the relationship, or the Confidential Information on social media without prior written consent.`
      },
      {
        id: "non_disparagement",
        title: "No Disclosure of Personal Entanglement",
        body:
`The Parties agree not to publicly disclose personal relationships or entanglements related to this Agreement or the relationship between the Parties.`
      },
      {
        id: "non_solicit_employees",
        title: "Employee Non-Solicitation",
        body:
`During the term of this Agreement and for one (1) year thereafter, Receiving Party will not solicit for employment any employee of Disclosing Party that it interacted with through the Confidential Information relationship.`
      },
      {
        id: "non_solicit_clients",
        title: "Non-Solicitation of Clients",
        body:
`During the term of this Agreement and for one (1) year thereafter, Receiving Party will not solicit Disclosing Party‚Äôs clients or customers that it learned about through Confidential Information.`
      },
      {
        id: "non_compete",
        title: "Non-Compete (Optional)",
        body:
`For a period of six (6) months following the termination of discussions, Receiving Party agrees not to use Confidential Information to directly compete with Disclosing Party in the specific project area described in this Agreement. (Consult counsel for enforceability.)`
      },
      {
        id: "data_protection",
        title: "Data Protection",
        body:
`Receiving Party agrees to implement reasonable technical and organizational measures to protect Confidential Information, including access controls, encryption where appropriate, and prompt notice of any suspected breach.`
      }
    ];

    let selectedClauseIds = new Set(["exclusions","obligations","return_destroy","ownership","no_license","no_obligation"]);
    let customClauses = []; // {title, body}

    function renderClauseList(){
      clauseListEl.innerHTML = "";
      for(const c of CLAUSES){
        const checked = selectedClauseIds.has(c.id);
        const el = document.createElement("div");
        el.className = "clauseItem";
        el.innerHTML = `
          <input type="checkbox" ${checked ? "checked" : ""} />
          <div>
            <strong>${escapeHtml(c.title)}</strong>
            <span>${escapeHtml(shorten(c.body, 120))}</span>
          </div>
        `;
        el.addEventListener("click", (e) => {
          // allow clicking anywhere to toggle
          const isChecked = selectedClauseIds.has(c.id);
          if(isChecked) selectedClauseIds.delete(c.id);
          else selectedClauseIds.add(c.id);
          renderClauseList();
          renderPreview();
        });
        clauseListEl.appendChild(el);
      }

      // Add custom clauses display
      if(customClauses.length){
        const sep = document.createElement("div");
        sep.className = "divider";
        sep.style.margin = "12px 0";
        clauseListEl.appendChild(sep);

        customClauses.forEach((cc, idx) => {
          const el = document.createElement("div");
          el.className = "clauseItem";
          el.style.cursor = "default";
          el.innerHTML = `
            <input type="checkbox" checked disabled />
            <div>
              <strong>Custom: ${escapeHtml(cc.title)}</strong>
              <span>${escapeHtml(shorten(cc.body, 120))}</span>
            </div>
          `;
          el.addEventListener("dblclick", () => {
            const newTitle = prompt("Edit custom clause title:", cc.title);
            if(newTitle === null) return;
            const newBody = prompt("Edit custom clause body:", cc.body);
            if(newBody === null) return;
            customClauses[idx] = { title: newTitle.trim() || "Custom Clause", body: newBody.trim() || "" };
            renderClauseList();
            renderPreview();
          });
          clauseListEl.appendChild(el);
        });
      }
    }

    function buildAgreementText(){
      const title = (builderTitleEl.value || "Confidentiality Agreement").trim();
      const parts = [];

      parts.push(`${title.toUpperCase()}\n`);
      parts.push(`This Agreement (‚ÄúAgreement‚Äù) is entered into on the Effective Date by and between:\n`);
      parts.push(`Party A (‚ÄúDisclosing Party‚Äù): [Party A Name]\nParty B (‚ÄúReceiving Party‚Äù): [Party B Name]\n`);
      parts.push(`The Parties agree as follows:\n`);

      let section = 1;
      for(const c of CLAUSES){
        if(!selectedClauseIds.has(c.id)) continue;
        parts.push(`${section}. ${c.title}\n${c.body}\n`);
        section++;
      }

      for(const cc of customClauses){
        parts.push(`${section}. ${cc.title}\n${cc.body}\n`);
        section++;
      }

      parts.push(`IN WITNESS WHEREOF, the Parties have executed this Agreement as of the Effective Date.\n\n`);
      parts.push(`Party A Signature: ____________________________\nDate: __________________\n\n`);
      parts.push(`Party B Signature: ____________________________\nDate: __________________\n`);

      return { title, text: parts.join("\n") };
    }

    function renderPreview(){
      const { title, text } = buildAgreementText();
      previewTitleEl.textContent = title;
      previewTextEl.textContent = text;
    }

    function shorten(str, n){
      const s = (str || "").replace(/\s+/g, " ").trim();
      return s.length > n ? s.slice(0,n-1) + "‚Ä¶" : s;
    }
    function escapeHtml(str){
      return (str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[m]);
    }

    addCustomBtn.addEventListener("click", () => {
      const title = prompt("Custom clause title:", "Additional Terms");
      if(title === null) return;
      const body = prompt("Custom clause body:", "Enter the clause text here‚Ä¶");
      if(body === null) return;
      customClauses.push({ title: title.trim() || "Custom Clause", body: body.trim() || "" });
      renderClauseList();
      renderPreview();
    });

    builderTitleEl.addEventListener("input", renderPreview);

    // ========= PARTY INPUTS =========
    const aName = document.getElementById("aName");
    const aEmail = document.getElementById("aEmail");
    const aTitle = document.getElementById("aTitle");
    const aAddr = document.getElementById("aAddr");

    const bName = document.getElementById("bName");
    const bEmail = document.getElementById("bEmail");
    const bTitle = document.getElementById("bTitle");
    const bAddr = document.getElementById("bAddr");

    function loadExisting(){
      doc = getDoc();
      if(!doc) return;

      // Parties
      aName.value = doc.parties?.aName || "";
      aEmail.value = doc.parties?.aEmail || "";
      aTitle.value = doc.parties?.aTitle || "";
      aAddr.value = doc.parties?.aAddr || "";

      bName.value = doc.parties?.bName || "";
      bEmail.value = doc.parties?.bEmail || "";
      bTitle.value = doc.parties?.bTitle || "";
      bAddr.value = doc.parties?.bAddr || "";

      // Source state
      if(doc.builder){
        setMode("scratch");
        builderTitleEl.value = doc.builder.title || "Confidentiality Agreement";
        selectedClauseIds = new Set(doc.builder.selectedClauseIds || []);
        customClauses = doc.builder.customClauses || [];
        renderClauseList();
        renderPreview();
        return;
      }

      if(localStorage.getItem("fss_uploaded_pdf_b64")){
        // if they uploaded previously, keep upload mode selected
        setMode("upload");
        const nm = localStorage.getItem("fss_uploaded_pdf_name") || "Uploaded PDF";
        uploadStatus.textContent = `‚úÖ Uploaded: ${nm}`;
        return;
      }

      if(doc.template){
        setMode("template");
        templateSelect.value = doc.template;
      }
    }

    // ========= CONTINUE / SAVE =========
    document.getElementById("continueBtn").addEventListener("click", () => {
      clearStatus();

      const A = (aName.value || "").trim();
      const AE = (aEmail.value || "").trim();
      const B = (bName.value || "").trim();
      const BE = (bEmail.value || "").trim();

      if(!A || !B){
        setStatus("warn", "Please enter at least Party A Name and Party B Name.");
        return;
      }

      // Update doc
      doc = getDoc() || {};
      doc.parties = doc.parties || {};
      doc.parties.aName = A;
      doc.parties.aEmail = AE;
      doc.parties.aTitle = (aTitle.value || "").trim();
      doc.parties.aAddr  = (aAddr.value || "").trim();

      doc.parties.bName = B;
      doc.parties.bEmail = BE;
      doc.parties.bTitle = (bTitle.value || "").trim();
      doc.parties.bAddr  = (bAddr.value || "").trim();

      // Reset status / stage
      doc.status = "draft";
      doc.stage = "create";
      doc.updatedAt = new Date().toISOString();

      // Apply source based on mode
      if(mode === "template"){
        doc.template = templateSelect.value;
        doc.builder = null;

        // clear upload state (keep it optional, but prevents confusion)
        localStorage.removeItem("fss_uploaded_pdf_b64");
        localStorage.removeItem("fss_uploaded_pdf_name");
      }

      if(mode === "upload"){
        const b64 = localStorage.getItem("fss_uploaded_pdf_b64");
        if(!b64){
          setStatus("warn", "Upload a PDF first.");
          return;
        }
        doc.template = null;
        doc.builder = null;
      }

      if(mode === "scratch"){
        const built = buildAgreementText();
        doc.template = null;

        doc.builder = {
          title: built.title,
          text: built.text,
          selectedClauseIds: Array.from(selectedClauseIds),
          customClauses: customClauses
        };

        // clear upload state too (avoid conflicts)
        localStorage.removeItem("fss_uploaded_pdf_b64");
        localStorage.removeItem("fss_uploaded_pdf_name");
      }

      saveDoc(doc);

      // Clean fields so Sign starts fresh
      FSS.saveFields([]);
      FSS.saveValues({});

      setStatus("good", "‚úÖ Envelope created. Sending you to Sign‚Ä¶");

      setTimeout(() => {
        location.href = "sign.html";
      }, 650);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      if(!confirm("Reset the current envelope? This clears selected template/upload/scratch and parties.")) return;
      FSS.resetDoc();
      FSS.saveFields([]);
      FSS.saveValues({});
      localStorage.removeItem("fss_uploaded_pdf_b64");
      localStorage.removeItem("fss_uploaded_pdf_name");
      location.reload();
    });

    // ========= BOOT =========
    (function boot(){
      // default scratch builder render
      renderClauseList();
      renderPreview();
      loadExisting();
      clearStatus();
    })();
  </script>
</body>
</html>
