<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Portal — Create</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body class="app dark">

  <header class="topbar">
    <div class="brand">
      <div class="logo">FSS</div>
      <div>
        <div class="title">Create Document</div>
        <div class="sub">Choose a PDF, set parties, then send for signature.</div>
      </div>
    </div>

    <nav class="navlinks">
      <a href="dashboard.html">Dashboard</a>
      <a href="create.html" class="active">Create</a>
      <a href="audit.html">Audit</a>
      <a href="../../demos.html" id="logoutLink">Logout</a>
    </nav>
  </header>

  <main class="page">
    <div class="shell">

      <section class="panel">
        <h2>Step 1 — Select a template</h2>
        <p class="muted">These PDFs are served from <code>/demosites/fillsignsend/pdfs/</code>.</p>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label class="lbl">Template</label>
            <select class="input" id="docSelect">
              <option value="">Select a PDF…</option>
              <option value="nda.pdf">NDA</option>
              <option value="consulting_agreement.pdf">Consulting Agreement</option>
              <option value="lease-waiver.pdf">Lease Waiver</option>
              <option value="event-accident-waiver.pdf">Event Accident Waiver</option>
              <option value="non-compete-agreement.pdf">Non-Compete Agreement</option>
              <option value="Photo-Release.pdf">Photo Release</option>
              <option value="real-estate-agreement.pdf">Real Estate Agreement</option>
            </select>

            <div class="divider"></div>

            <h3 class="h3">Step 2 — Parties</h3>
            <p class="muted">Add Party A (sender) and Party B (recipient).</p>

            <div class="grid2">
              <div class="panel mini">
                <div class="miniHead">
                  <b>Party A (Sender)</b>
                  <span class="pill">Required</span>
                </div>

                <label class="lbl">Full name</label>
                <input class="input" id="aName" type="text" placeholder="Example: Mason Palmieri" />

                <label class="lbl" style="margin-top:10px;">Email</label>
                <input class="input" id="aEmail" type="email" placeholder="Example: mason@palmweb.net" />
              </div>

              <div class="panel mini">
                <div class="miniHead">
                  <b>Party B (Recipient)</b>
                  <span class="pill">Required</span>
                </div>

                <label class="lbl">Full name</label>
                <input class="input" id="bName" type="text" placeholder="Example: Client Name" />

                <label class="lbl" style="margin-top:10px;">Email</label>
                <input class="input" id="bEmail" type="email" placeholder="Example: client@email.com" />
              </div>
            </div>

            <div class="divider"></div>

            <h3 class="h3">Step 3 — Message (optional)</h3>
            <label class="lbl">Email subject</label>
            <input class="input" id="subject" type="text" placeholder="Signature requested" />

            <label class="lbl" style="margin-top:10px;">Message</label>
            <textarea class="input" id="message" style="min-height:120px;" placeholder="Hi — please review and sign this document at your earliest convenience."></textarea>

            <div class="actions" style="margin-top:14px;">
              <button class="btn secondary" id="saveBtn" type="button">Save</button>
              <button class="btn primary" id="sendBtn" type="button">Send for Signature</button>
            </div>

            <p class="tiny muted" id="statusLine" style="margin-top:10px;"></p>
          </div>

          <aside class="panel mini" style="height:fit-content;">
            <b>Preview</b>
            <p class="muted" style="margin-top:6px;">
              Preview loads here after you select a template.
            </p>

            <div class="divider"></div>

            <div id="previewBox" class="previewBox">
              <div class="muted tiny">No document selected.</div>
            </div>

            <div class="divider"></div>

            <b>Signing Link (demo)</b>
            <p class="muted tiny" style="margin-top:6px;">
              When you click “Send”, you’ll be able to copy a signing link and open it as the recipient.
            </p>

            <button class="btn outlineFull" id="copyLinkBtn" type="button" disabled>Copy Signing Link</button>
          </aside>
        </div>
      </section>

    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    // Guard
    FSS.guard();

    const docSelect = document.getElementById("docSelect");
    const previewBox = document.getElementById("previewBox");
    const statusLine = document.getElementById("statusLine");

    const aName = document.getElementById("aName");
    const aEmail = document.getElementById("aEmail");
    const bName = document.getElementById("bName");
    const bEmail = document.getElementById("bEmail");
    const subject = document.getElementById("subject");
    const message = document.getElementById("message");

    const saveBtn = document.getElementById("saveBtn");
    const sendBtn = document.getElementById("sendBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");

    // Load saved state
    const state = FSS.loadDocState();
    if(state?.template){
      docSelect.value = state.template;
      renderPreview(state.template);
    }
    if(state?.parties){
      aName.value = state.parties.aName || "";
      aEmail.value = state.parties.aEmail || "";
      bName.value = state.parties.bName || "";
      bEmail.value = state.parties.bEmail || "";
      subject.value = state.parties.subject || "";
      message.value = state.parties.message || "";
    }

    docSelect.addEventListener("change", () => {
      const val = docSelect.value;
      if(!val){
        previewBox.innerHTML = `<div class="muted tiny">No document selected.</div>`;
        return;
      }
      renderPreview(val);
    });

    function renderPreview(filename){
      const url = `pdfs/${filename}`;
      previewBox.innerHTML = `
        <div class="previewTop">
          <span class="pill">PDF</span>
          <span class="muted tiny">${filename}</span>
        </div>
        <iframe class="previewFrame" src="${url}" title="PDF preview"></iframe>
      `;
    }

    function validate(){
      const template = docSelect.value.trim();
      if(!template) return "Select a PDF template.";
      if(!aName.value.trim()) return "Party A name required.";
      if(!aEmail.value.trim()) return "Party A email required.";
      if(!bName.value.trim()) return "Party B name required.";
      if(!bEmail.value.trim()) return "Party B email required.";
      return null;
    }

    function saveState(extra = {}){
      const template = docSelect.value.trim();
      const parties = {
        aName: aName.value.trim(),
        aEmail: aEmail.value.trim(),
        bName: bName.value.trim(),
        bEmail: bEmail.value.trim(),
        subject: subject.value.trim(),
        message: message.value.trim(),
      };

      FSS.saveDocState({
        template,
        parties,
        ...extra
      });
    }

    saveBtn.addEventListener("click", () => {
      const err = validate();
      if(err){
        statusLine.textContent = err;
        statusLine.style.color = "#fda4af";
        return;
      }
      saveState();
      statusLine.textContent = "Saved.";
      statusLine.style.color = "#86efac";
    });

    sendBtn.addEventListener("click", () => {
      const err = validate();
      if(err){
        statusLine.textContent = err;
        statusLine.style.color = "#fda4af";
        return;
      }

      saveState({
        status: "sent",
        sentAt: Date.now()
      });

      // Create initial audit entries
      FSS.auditAdd("Created", "Sender created the envelope and selected a template.");
      FSS.auditAdd("Sent", "Envelope sent to recipient for signature.");

      statusLine.textContent = "Sent for signature (demo). You can now copy the signing link.";
      statusLine.style.color = "#86efac";

      copyLinkBtn.disabled = false;
    });

    copyLinkBtn.addEventListener("click", async () => {
      // For demo purposes, the "signing link" is just sign.html
      const link = `${window.location.origin}${window.location.pathname.replace("create.html","")}sign.html`;

      try{
        await navigator.clipboard.writeText(link);
        statusLine.textContent = "Signing link copied to clipboard.";
        statusLine.style.color = "#86efac";
      }catch{
        statusLine.textContent = "Could not copy. Here is the link: " + link;
        statusLine.style.color = "#fde68a";
      }
    });

    document.getElementById("logoutLink").addEventListener("click", () => {
      FSS.logout();
    });
  </script>

</body>
</html>
