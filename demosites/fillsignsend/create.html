<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Portal — Create</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body class="app light">

  <header class="topbar">
    <div class="brand">
      <div class="logo">FSS</div>
      <div>
        <div class="title">Create Agreement</div>
        <div class="sub">Fill details, then sign as the sender.</div>
      </div>
    </div>

    <nav class="navlinks">
      <a href="dashboard.html">Dashboard</a>
      <a href="create.html" class="active">Create</a>
      <a href="audit.html">Audit</a>
      <a href="../../demos.html" id="logoutLink">Logout</a>
    </nav>
  </header>

  <main class="page">
    <div class="shell">

      <section class="panel">
        <div class="panelHead">
          <div>
            <h2 style="margin:0;">Step 1 — Choose a PDF</h2>
            <p class="muted" style="margin:6px 0 0;">
              Templates load from <code>/demosites/fillsignsend/pdfs/</code>
            </p>
          </div>
          <div class="pill">Fill → Sign → Send</div>
        </div>

        <div class="divider"></div>

        <div class="layout">
          <!-- LEFT -->
          <div class="left">
            <label class="lbl">Template</label>
            <select class="input" id="docSelect">
              <option value="">Select a PDF…</option>
              <option value="nda.pdf">NDA</option>
              <option value="consulting_agreement.pdf">Consulting Agreement</option>
              <option value="lease-waiver.pdf">Lease Waiver</option>
              <option value="event-accident-waiver.pdf">Event Accident Waiver</option>
              <option value="non-compete-agreement.pdf">Non-Compete Agreement</option>
              <option value="Photo-Release.pdf">Photo Release</option>
              <option value="real-estate-agreement.pdf">Real Estate Agreement</option>
            </select>

            <div class="divider"></div>

            <h3 class="h3">Step 2 — Parties</h3>
            <p class="muted tiny" style="margin-top:6px;">
              Party A will be prompted to sign immediately after creating.
            </p>

            <div class="twoMini">
              <div class="miniCard">
                <div class="miniHead">
                  <b>Party A (Sender)</b>
                  <span class="tag">Signs First</span>
                </div>

                <label class="lbl">Full name*</label>
                <input class="input" id="aName" type="text" placeholder="Example: Mason Palmieri" />

                <label class="lbl" style="margin-top:10px;">Email*</label>
                <input class="input" id="aEmail" type="email" placeholder="Example: mason@palmweb.net" />
              </div>

              <div class="miniCard">
                <div class="miniHead">
                  <b>Party B (Recipient)</b>
                  <span class="tag gray">Receives After</span>
                </div>

                <label class="lbl">Full name*</label>
                <input class="input" id="bName" type="text" placeholder="Example: Client Name" />

                <label class="lbl" style="margin-top:10px;">Email*</label>
                <input class="input" id="bEmail" type="email" placeholder="Example: client@email.com" />
              </div>
            </div>

            <div class="divider"></div>

            <h3 class="h3">Optional Message</h3>
            <label class="lbl">Subject</label>
            <input class="input" id="subject" type="text" placeholder="Signature requested" />

            <label class="lbl" style="margin-top:10px;">Message</label>
            <textarea class="input" id="message" style="min-height:110px;" placeholder="Hi — please review and sign."></textarea>

            <div class="divider"></div>

            <div class="actions">
              <button class="btn secondary" id="saveBtn" type="button">Save Draft</button>
              <button class="btn primary" id="continueBtn" type="button">Continue to Sender Signing</button>
            </div>

            <p class="tiny" id="statusLine" style="margin-top:10px;"></p>
          </div>

          <!-- RIGHT -->
          <div class="right">
            <div class="previewHeader">
              <b>Preview</b>
              <span class="muted tiny" id="previewName">No template selected</span>
            </div>

            <div class="previewBox" id="previewBox">
              <div class="muted tiny" style="padding:14px;">Select a template to preview.</div>
            </div>

            <p class="tiny muted" style="margin-top:10px;">
              After you continue, the sender will be prompted to sign required fields.
            </p>
          </div>
        </div>
      </section>

    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    FSS.guard();

    const docSelect = document.getElementById("docSelect");
    const previewBox = document.getElementById("previewBox");
    const previewName = document.getElementById("previewName");
    const statusLine = document.getElementById("statusLine");

    const aName = document.getElementById("aName");
    const aEmail = document.getElementById("aEmail");
    const bName = document.getElementById("bName");
    const bEmail = document.getElementById("bEmail");
    const subject = document.getElementById("subject");
    const message = document.getElementById("message");

    const saveBtn = document.getElementById("saveBtn");
    const continueBtn = document.getElementById("continueBtn");

    // Load saved state
    const state = FSS.loadDocState();
    if(state?.template){
      docSelect.value = state.template;
      renderPreview(state.template);
    }
    if(state?.parties){
      aName.value = state.parties.aName || "";
      aEmail.value = state.parties.aEmail || "";
      bName.value = state.parties.bName || "";
      bEmail.value = state.parties.bEmail || "";
      subject.value = state.parties.subject || "";
      message.value = state.parties.message || "";
    }

    docSelect.addEventListener("change", () => {
      const val = docSelect.value.trim();
      if(!val){
        previewName.textContent = "No template selected";
        previewBox.innerHTML = `<div class="muted tiny" style="padding:14px;">Select a template to preview.</div>`;
        return;
      }
      renderPreview(val);
    });

    function renderPreview(filename){
      previewName.textContent = filename;
      const url = `pdfs/${filename}`;
      previewBox.innerHTML = `<iframe class="previewFrame" src="${url}" title="PDF preview"></iframe>`;
    }

    function validate(){
      if(!docSelect.value.trim()) return "Select a PDF template.";
      if(!aName.value.trim()) return "Sender name is required.";
      if(!aEmail.value.trim()) return "Sender email is required.";
      if(!bName.value.trim()) return "Recipient name is required.";
      if(!bEmail.value.trim()) return "Recipient email is required.";
      return null;
    }

    function saveState(extra = {}){
      const template = docSelect.value.trim();
      const parties = {
        aName: aName.value.trim(),
        aEmail: aEmail.value.trim(),
        bName: bName.value.trim(),
        bEmail: bEmail.value.trim(),
        subject: subject.value.trim(),
        message: message.value.trim(),
      };

      FSS.saveDocState({
        template,
        parties,
        status: "draft",
        ...extra
      });
    }

    saveBtn.addEventListener("click", () => {
      const err = validate();
      if(err){
        statusLine.textContent = err;
        statusLine.className = "tiny textBad";
        return;
      }
      saveState();
      statusLine.textContent = "Saved draft.";
      statusLine.className = "tiny textGood";
    });

    continueBtn.addEventListener("click", () => {
      const err = validate();
      if(err){
        statusLine.textContent = err;
        statusLine.className = "tiny textBad";
        return;
      }

      // Clear any old fields from previous envelopes
      FSS.saveFields([]);

      // Set flow state
      saveState({
        status: "sender_signing",
        createdAt: Date.now(),
        stage: "sender"
      });

      // Audit
      FSS.auditAdd("Created", "Envelope created. Sender prompted to sign.");

      // Go to signing room as sender
      window.location.href = "sign.html?role=sender";
    });

    document.getElementById("logoutLink").addEventListener("click", () => {
      FSS.logout();
    });
  </script>
</body>
</html>
