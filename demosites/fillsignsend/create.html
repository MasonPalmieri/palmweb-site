<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create • Client Demo</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    /* =========================================
       CREATE PAGE (Scoped to avoid app.css fights)
       ========================================= */
    body.create-page{
      min-height:100vh;
    }

    .create-page .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px 18px 70px;
    }

    .create-page .page-title{
      margin: 10px 0 6px;
      font-size: 28px;
      font-weight: 950;
      letter-spacing: -0.4px;
      color: rgba(255,255,255,.92);
    }

    .create-page .page-sub{
      margin: 0 0 18px;
      color: rgba(255,255,255,.72);
      font-weight: 750;
      font-size: 14px;
    }

    /* 2-column layout */
    .create-page .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
      position: relative;
    }

    /* IMPORTANT: make sure LEFT panel is above anything */
    .create-page .left{
      position: relative;
      z-index: 10;
      pointer-events: auto;
    }

    .create-page .right{
      position: relative;
      z-index: 1;
      min-height: 620px;
      pointer-events: auto;
    }

    /* Card style (matches your FSS glass look) */
    .create-page .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      padding: 16px;
      overflow:hidden;
    }

    .create-page .card h3{
      margin:0 0 6px;
      font-size: 16px;
      font-weight: 950;
      color: rgba(255,255,255,.92);
    }

    .create-page .card p{
      margin:0 0 12px;
      font-size: 13px;
      font-weight: 750;
      color: rgba(255,255,255,.70);
      line-height: 1.45;
    }

    /* Tabs */
    .create-page .tabs{
      display:flex;
      gap: 8px;
      margin: 10px 0 14px;
      flex-wrap:wrap;
    }

    .create-page .tab{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .create-page .tab.active{
      border-color: rgba(67,203,255,.30);
      box-shadow: 0 0 0 4px rgba(67,203,255,.10);
      background: rgba(67,203,255,.10);
    }

    /* Inputs */
    .create-page label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-weight: 900;
      font-size: 12.5px;
      color: rgba(255,255,255,.85);
      margin-top: 10px;
    }

    .create-page input,
    .create-page select,
    .create-page textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.95);
      outline:none;
      font-weight: 850;
      font-size: 13.5px;
    }

    .create-page textarea{
      min-height: 160px;
      resize: vertical;
      line-height: 1.4;
    }

    .create-page input:focus,
    .create-page select:focus,
    .create-page textarea:focus{
      border-color: rgba(67,203,255,.55);
      box-shadow: 0 0 0 4px rgba(67,203,255,.12);
    }

    .create-page .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .create-page .checks{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    .create-page .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-weight: 850;
      font-size: 12.5px;
      cursor:pointer;
      user-select:none;
      color: rgba(255,255,255,.88);
    }

    .create-page .chip input{
      width:auto;
      accent-color: #43cbff;
    }

    /* Buttons */
    .create-page .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }

    .create-page .btn-wide{
      flex: 1 1 auto;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 950;
      font-size: 14px;
    }

    .create-page .hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.65);
      font-weight: 750;
      line-height: 1.45;
    }

    /* Preview header */
    .create-page .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .create-page .preview-head .leftTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 950;
      color: rgba(255,255,255,.92);
    }

    .create-page .preview-box{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      height: 610px;
      position: relative;
      z-index: 1;
    }

    /* The iframe MUST never overlap left panel */
    .create-page iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
      position: relative;
      z-index: 1;
    }

    /* Responsive */
    @media (max-width: 980px){
      .create-page .grid{
        grid-template-columns: 1fr;
      }
      .create-page .preview-box{
        height: 520px;
      }
    }
  </style>
</head>

<body class="app create-page">
  <!-- Top bar uses your existing app.css styles -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">FSS</div>
        <div class="brand-text">
          <div class="brand-title">Client Demo</div>
          <div class="brand-sub">Fill → Sign → Send</div>
        </div>
      </div>

      <div class="nav">
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="create.html" class="nav-link active">Create</a>
        <a href="sign.html" class="nav-link">Sign</a>
        <a href="completed.html" class="nav-link">Completed</a>
      </div>

      <div class="topbar-actions">
        <div class="pill" id="userPill">demo@client.com</div>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="page-title">Create</div>
    <div class="page-sub">Choose a template, upload a PDF, or build from scratch (NDA Express style).</div>

    <div class="grid">
      <!-- LEFT -->
      <div class="left">
        <div class="card">
          <h3>Create Agreement</h3>
          <p>Pick your source, enter party info + rules, then generate a clean PDF for signing.</p>

          <div class="tabs">
            <button class="tab active" id="tabBuild" type="button">Build from scratch</button>
            <button class="tab" id="tabTemplate" type="button">Template</button>
            <button class="tab" id="tabUpload" type="button">Upload PDF</button>
          </div>

          <!-- SHARED FIELDS -->
          <label>
            Agreement Title
            <input id="title" type="text" placeholder="Example: Mutual Non-Disclosure Agreement" />
          </label>

          <div class="row2">
            <label>
              Party A Name
              <input id="aName" type="text" placeholder="Example: Company A, Inc." />
            </label>
            <label>
              Party A Email
              <input id="aEmail" type="email" placeholder="a@company.com" />
            </label>
          </div>

          <div class="row2">
            <label>
              Party B Name
              <input id="bName" type="text" placeholder="Example: Company B, LLC" />
            </label>
            <label>
              Party B Email
              <input id="bEmail" type="email" placeholder="b@company.com" />
            </label>
          </div>

          <div id="buildSection">
            <label style="margin-top:14px;">Rules / Options (NDA Express style)</label>

            <div class="checks">
              <label class="chip"><input id="optMutual" type="checkbox" /> Mutual NDA</label>
              <label class="chip"><input id="optOneWay" type="checkbox" /> One-way NDA</label>
              <label class="chip"><input id="optNonCompete" type="checkbox" /> Include non-compete</label>
              <label class="chip"><input id="optNonSolicit" type="checkbox" /> Include non-solicit</label>
              <label class="chip"><input id="optInjunctive" type="checkbox" /> Injunctive relief</label>
              <label class="chip"><input id="optReturnDestroy" type="checkbox" /> Return/Destroy confidential info</label>
            </div>

            <div class="row2">
              <label>
                Term (months)
                <input id="termMonths" type="number" min="1" max="120" value="12" />
              </label>
              <label>
                Governing Law (State)
                <input id="governingLaw" type="text" value="Massachusetts" />
              </label>
            </div>

            <label>
              Purpose / Relationship
              <input id="purpose" type="text" placeholder="Example: evaluating a potential partnership" />
            </label>

            <label>
              Agreement Body (optional)
              <textarea id="body" placeholder="Write the agreement text here… (or paste clauses)"></textarea>
            </label>
          </div>

          <!-- TEMPLATE SECTION -->
          <div id="templateSection" style="display:none;">
            <label>
              Template PDF
              <select id="templateSelect">
                <option value="nda.pdf">nda.pdf</option>
                <option value="non-compete-agreement.pdf">non-compete-agreement.pdf</option>
              </select>
            </label>

            <div class="hint">Templates are loaded from <strong>/pdfs</strong>.</div>
          </div>

          <!-- UPLOAD SECTION -->
          <div id="uploadSection" style="display:none;">
            <label>
              Upload PDF
              <input id="uploadInput" type="file" accept="application/pdf" />
            </label>

            <div class="hint">Uploads are stored locally in your browser (Base64). Nothing is sent.</div>
          </div>

          <div class="actions">
            <button class="btn btn-primary btn-wide" id="previewBtn" type="button">Preview PDF</button>
            <button class="btn btn-outline btn-wide" id="saveBtn" type="button">Save & Go To Sign</button>
            <button class="btn btn-outline btn-wide" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="hint">
            Tip: Use the Rules/Options above like NDA Express — then we auto-generate a clean PDF for signing.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="card">
          <div class="preview-head">
            <div class="leftTitle">
              <span class="pill">PDF</span>
              <span id="previewLabel">Preview</span>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-outline" id="openNewTabBtn" type="button">Open</button>
              <button class="btn btn-outline" id="refreshPreviewBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="preview-box">
            <iframe id="previewFrame" title="PDF Preview"></iframe>
          </div>

          <div class="hint" id="previewHint">Click <strong>Preview PDF</strong> to generate a preview here.</div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/app.js"></script>
  <script>
    // ======================
    // GUARD + TOPBAR
    // ======================
    FSS.guard();

    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userPill").textContent = auth.email || "demo@client.com";

    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    // ======================
    // TAB LOGIC
    // ======================
    const tabBuild = document.getElementById("tabBuild");
    const tabTemplate = document.getElementById("tabTemplate");
    const tabUpload = document.getElementById("tabUpload");

    const buildSection = document.getElementById("buildSection");
    const templateSection = document.getElementById("templateSection");
    const uploadSection = document.getElementById("uploadSection");

    function setTab(which){
      tabBuild.classList.toggle("active", which === "build");
      tabTemplate.classList.toggle("active", which === "template");
      tabUpload.classList.toggle("active", which === "upload");

      buildSection.style.display = which === "build" ? "" : "none";
      templateSection.style.display = which === "template" ? "" : "none";
      uploadSection.style.display = which === "upload" ? "" : "none";

      // store mode in doc state
      const d = FSS.loadDocState() || FSS.resetDoc();
      d.sourceMode = which;
      FSS.saveDocState(d);
    }

    tabBuild.addEventListener("click", () => setTab("build"));
    tabTemplate.addEventListener("click", () => setTab("template"));
    tabUpload.addEventListener("click", () => setTab("upload"));

    // ======================
    // LOAD EXISTING STATE
    // ======================
    const titleEl = document.getElementById("title");
    const aNameEl = document.getElementById("aName");
    const aEmailEl = document.getElementById("aEmail");
    const bNameEl = document.getElementById("bName");
    const bEmailEl = document.getElementById("bEmail");

    const optMutual = document.getElementById("optMutual");
    const optOneWay = document.getElementById("optOneWay");
    const optNonCompete = document.getElementById("optNonCompete");
    const optNonSolicit = document.getElementById("optNonSolicit");
    const optInjunctive = document.getElementById("optInjunctive");
    const optReturnDestroy = document.getElementById("optReturnDestroy");

    const termMonths = document.getElementById("termMonths");
    const governingLaw = document.getElementById("governingLaw");
    const purpose = document.getElementById("purpose");
    const body = document.getElementById("body");

    const templateSelect = document.getElementById("templateSelect");
    const uploadInput = document.getElementById("uploadInput");

    function loadUI(){
      const d = FSS.loadDocState() || FSS.resetDoc();

      titleEl.value = d.builder?.title || d.title || "";
      aNameEl.value = d.parties?.aName || "";
      aEmailEl.value = d.parties?.aEmail || "";
      bNameEl.value = d.parties?.bName || "";
      bEmailEl.value = d.parties?.bEmail || "";

      // builder options
      const rules = d.builder?.rules || {};
      optMutual.checked = !!rules.mutual;
      optOneWay.checked = !!rules.oneWay;
      optNonCompete.checked = !!rules.nonCompete;
      optNonSolicit.checked = !!rules.nonSolicit;
      optInjunctive.checked = !!rules.injunctive;
      optReturnDestroy.checked = !!rules.returnDestroy;

      termMonths.value = rules.termMonths ?? 12;
      governingLaw.value = rules.governingLaw ?? "Massachusetts";
      purpose.value = rules.purpose ?? "";
      body.value = d.builder?.text || "";

      // template
      if(d.template) templateSelect.value = d.template;

      // mode
      setTab(d.sourceMode || "build");
    }

    loadUI();

    // ======================
    // PREVIEW
    // ======================
    const previewFrame = document.getElementById("previewFrame");
    const previewLabel = document.getElementById("previewLabel");
    const previewHint = document.getElementById("previewHint");

    async function buildDocStateFromUI(){
      const d = FSS.loadDocState() || FSS.resetDoc();

      d.title = titleEl.value.trim();
      d.parties = d.parties || {};
      d.parties.aName = aNameEl.value.trim();
      d.parties.aEmail = aEmailEl.value.trim();
      d.parties.bName = bNameEl.value.trim();
      d.parties.bEmail = bEmailEl.value.trim();

      const mode = d.sourceMode || "build";

      if(mode === "template"){
        d.template = templateSelect.value;
        d.builder = null; // not builder
      }

      if(mode === "build"){
        d.template = null; // builder overrides template
        d.builder = {
          title: d.title || "Agreement",
          text: body.value.trim(),
          rules: {
            mutual: optMutual.checked,
            oneWay: optOneWay.checked,
            nonCompete: optNonCompete.checked,
            nonSolicit: optNonSolicit.checked,
            injunctive: optInjunctive.checked,
            returnDestroy: optReturnDestroy.checked,
            termMonths: Number(termMonths.value || 12),
            governingLaw: governingLaw.value.trim(),
            purpose: purpose.value.trim(),
          }
        };
      }

      FSS.saveDocState(d);
      return d;
    }

    async function previewPDF(){
      previewHint.textContent = "Generating preview…";
      const d = await buildDocStateFromUI();

      try{
        // If upload mode, user must have uploaded something
        if(d.sourceMode === "upload"){
          if(!FSS.hasUploadedPDF()){
            alert("Upload a PDF first.");
            previewHint.textContent = "Upload a PDF to preview.";
            return;
          }
          const url = FSS.base64ToBlobURL(FSS.getUploadedPDFBase64());
          previewFrame.src = url;
          previewLabel.textContent = "Uploaded PDF";
          previewHint.textContent = "Preview loaded.";
          return;
        }

        // If template mode
        if(d.sourceMode === "template"){
          previewFrame.src = "pdfs/" + encodeURIComponent(d.template || "nda.pdf");
          previewLabel.textContent = d.template || "nda.pdf";
          previewHint.textContent = "Template preview loaded.";
          return;
        }

        // Build mode -> generate a PDF from builder text (pdf-lib)
        const bytes = await FSS.generateBuilderPDFBytes();
        if(!bytes){
          alert("Builder PDF failed. Open DevTools → Console.");
          previewHint.textContent = "Builder PDF failed — open console.";
          return;
        }

        const b64 = btoa(String.fromCharCode(...bytes));
        const url = FSS.base64ToBlobURL(b64);

        previewFrame.src = url;
        previewLabel.textContent = "Scratch-built PDF";
        previewHint.textContent = "Builder preview loaded.";
      }catch(err){
        console.error(err);
        alert("Preview failed. Check console.");
        previewHint.textContent = "Preview failed.";
      }
    }

    document.getElementById("previewBtn").addEventListener("click", previewPDF);

    document.getElementById("refreshPreviewBtn").addEventListener("click", () => {
      if(previewFrame.src) previewFrame.src = previewFrame.src;
    });

    document.getElementById("openNewTabBtn").addEventListener("click", () => {
      if(!previewFrame.src) return;
      window.open(previewFrame.src, "_blank");
    });

    // ======================
    // UPLOAD HANDLER
    // ======================
    uploadInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      if(file.type !== "application/pdf"){
        alert("Please choose a PDF file.");
        uploadInput.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const b64 = String(reader.result).split(",")[1];
        localStorage.setItem("fss_uploaded_pdf_b64", b64);
        localStorage.setItem("fss_uploaded_pdf_name", file.name);
        alert("Uploaded successfully. Click Preview PDF.");
      };
      reader.readAsDataURL(file);
    });

    // ======================
    // SAVE & GO TO SIGN
    // ======================
    document.getElementById("saveBtn").addEventListener("click", async () => {
      await buildDocStateFromUI();
      FSS.setStage("sign");
      location.href = "sign.html";
    });

    // ======================
    // RESET
    // ======================
    document.getElementById("resetBtn").addEventListener("click", () => {
      if(!confirm("Reset this agreement?")) return;
      FSS.resetDoc();
      location.reload();
    });
  </script>
</body>
</html>