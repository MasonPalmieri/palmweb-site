<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create • Client Demo</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 50px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }

    .page-head h1{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -0.2px;
    }

    .page-head p{
      margin: 6px 0 0;
      color: rgba(255,255,255,.70);
      font-weight: 750;
      font-size: 13px;
      max-width: 80ch;
      line-height: 1.5;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 12px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 24px 80px rgba(0,0,0,.30);
    }

    .card h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: -0.1px;
    }

    .sub{
      margin: 8px 0 0;
      color: rgba(255,255,255,.70);
      font-weight: 750;
      font-size: 13px;
      line-height: 1.5;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-weight: 900;
      font-size: 13px;
      color: rgba(255,255,255,.86);
    }

    input, select, textarea{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.95);
      outline:none;
      font-size: 14px;
      font-weight: 850;
    }

    select option{
      background:#0b1220;
      color:#fff;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(67,203,255,.55);
      box-shadow: 0 0 0 4px rgba(67,203,255,.12);
    }

    textarea{
      min-height: 160px;
      resize: vertical;
      line-height: 1.55;
      font-weight: 750;
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .full{ grid-column: 1 / -1; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top: 10px;
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.62);
      font-weight: 750;
      line-height: 1.45;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.84);
      display:none;
    }
    .status.good{ border-color: rgba(96,255,157,.35); background: rgba(96,255,157,.10); }
    .status.warn{ border-color: rgba(255,196,82,.35); background: rgba(255,196,82,.10); }
    .status.bad{ border-color: rgba(255,79,99,.35); background: rgba(255,79,99,.10); }

    /* Scratch builder */
    .chips{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.90);
      user-select:none;
      cursor:pointer;
    }
    .chip input{ accent-color: rgba(67,203,255,.95); }

    .small{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      font-weight: 750;
    }

    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="app">
  <header class="app-top">
    <div class="app-top-inner">
      <a class="app-brand" href="dashboard.html">
        <span class="logo-badge">FSS</span>
        <div class="brand-text">
          <strong>Client Demo</strong>
          <span>Fill → Sign → Send</span>
        </div>
      </a>

      <div class="app-nav">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link active" href="create.html">Create</a>
        <a class="nav-link" href="sign.html">Sign</a>
        <a class="nav-link" href="success.html">Completed</a>
      </div>

      <div class="app-user">
        <span id="userEmail" class="user-pill">—</span>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1>Create Agreement</h1>
        <p>
          Start a new agreement from a template, upload your own PDF, or build from scratch (NDA Express-style).
          This step sets the parties + document content before signing.
        </p>
      </div>
      <div class="row">
        <a class="btn btn-outline" href="dashboard.html">Back</a>
        <a class="btn btn-primary" href="sign.html">Continue → Sign</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Template / Upload -->
      <section class="card">
        <h2>Start from Template</h2>
        <p class="sub">Uses a PDF stored in <code>/demosites/fillsignsend/pdfs/</code>.</p>

        <div class="form-grid">
          <label class="full">
            Agreement Template (PDF)
            <select id="templateSel">
              <option value="nda.pdf">NDA</option>
              <option value="consulting_agreement.pdf">Consulting Agreement</option>
              <option value="non-compete-agreement.pdf">Non-Compete</option>
              <option value="real-estate-agreement.pdf">Real Estate Agreement</option>
              <option value="Photo-Release.pdf">Photo Release</option>
              <option value="lease-waiver.pdf">Lease Waiver</option>
              <option value="event-accident-waiver.pdf">Event Accident Waiver</option>
            </select>
          </label>
        </div>

        <div class="row">
          <button class="btn btn-primary" id="useTemplateBtn" type="button">Use Template</button>
          <button class="btn btn-outline" id="clearUploadBtn" type="button">Clear Upload</button>
        </div>

        <div class="divider"></div>

        <h2 id="upload">Upload Agreement</h2>
        <p class="sub">Upload any PDF — it will be stored locally and used for signing.</p>

        <label style="margin-top:10px;">
          Upload PDF
          <input id="uploadPdf" type="file" accept="application/pdf" />
        </label>

        <div class="small" id="uploadInfo" style="margin-top:8px;">No upload yet.</div>

        <div class="hint">
          Upload is stored in <strong>localStorage</strong>. It will work like a template for signing and output.
        </div>

        <div class="status" id="statusLeft"></div>
      </section>

      <!-- RIGHT: Parties + Scratch Builder -->
      <section class="card">
        <h2>Parties</h2>
        <p class="sub">Sender signs first. Recipient completes after sending.</p>

        <div class="form-grid">
          <label>
            Sender Name*
            <input id="aName" type="text" placeholder="Sender full name" />
          </label>
          <label>
            Sender Email*
            <input id="aEmail" type="email" placeholder="sender@company.com" />
          </label>

          <label>
            Recipient Name*
            <input id="bName" type="text" placeholder="Recipient full name" />
          </label>
          <label>
            Recipient Email*
            <input id="bEmail" type="email" placeholder="recipient@company.com" />
          </label>

          <label class="full">
            Notes (optional)
            <input id="notes" type="text" placeholder="Internal notes for this envelope (demo-only)" />
          </label>
        </div>

        <div class="divider"></div>

        <h2 id="scratch">Build From Scratch</h2>
        <p class="sub">Pick clauses + generate agreement text (fast demo mode).</p>

        <label style="margin-top:10px;">
          Agreement Title
          <input id="scratchTitle" type="text" placeholder="Example: Mutual Non-Disclosure Agreement" />
        </label>

        <div class="chips" id="clauseChips"></div>

        <label style="margin-top:10px;">
          Agreement Body (editable)
          <textarea id="scratchText" placeholder="Choose clauses above, or type your own text..."></textarea>
        </label>

        <div class="row">
          <button class="btn btn-outline" id="insertDefaultsBtn" type="button">Insert Defaults</button>
          <button class="btn btn-primary" id="useScratchBtn" type="button">Use Scratch Agreement</button>
        </div>

        <div class="hint">
          Using scratch mode creates a real PDF in-browser so the signer can place fields + generate signed output.
        </div>

        <div class="status" id="statusRight"></div>
      </section>
    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    // Auth guard
    FSS.guard();

    // Header user
    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userEmail").textContent = auth.email || "demo@client.com";

    // Ensure doc exists
    let doc = FSS.loadDocState();
    if(!doc){
      doc = FSS.resetDoc();
      FSS.logAudit("Envelope created.");
    }

    // Elements
    const templateSel = document.getElementById("templateSel");
    const useTemplateBtn = document.getElementById("useTemplateBtn");
    const clearUploadBtn = document.getElementById("clearUploadBtn");

    const uploadPdf = document.getElementById("uploadPdf");
    const uploadInfo = document.getElementById("uploadInfo");

    const aName = document.getElementById("aName");
    const aEmail = document.getElementById("aEmail");
    const bName = document.getElementById("bName");
    const bEmail = document.getElementById("bEmail");

    const statusLeft = document.getElementById("statusLeft");
    const statusRight = document.getElementById("statusRight");

    // Scratch
    const scratchTitle = document.getElementById("scratchTitle");
    const scratchText = document.getElementById("scratchText");
    const clauseChips = document.getElementById("clauseChips");
    const insertDefaultsBtn = document.getElementById("insertDefaultsBtn");
    const useScratchBtn = document.getElementById("useScratchBtn");

    // Demo clause rules (NDA Express style)
    const CLAUSES = [
      { id:"confidentiality", label:"Confidentiality", text:`1. CONFIDENTIALITY\nEach party agrees to keep confidential information private and not disclose it to third parties without written consent.` },
      { id:"term", label:"Term", text:`2. TERM\nThis Agreement begins on the Effective Date and remains in effect for two (2) years unless terminated earlier by written notice.` },
      { id:"noncircumvent", label:"Non-Circumvention", text:`3. NON-CIRCUMVENTION\nRecipient agrees not to circumvent or bypass the disclosing party to directly engage clients, vendors, or partners presented under this Agreement.` },
      { id:"nonsolicit", label:"Non-Solicitation", text:`4. NON-SOLICITATION\nRecipient agrees not to solicit the employees or contractors of the other party during the term and for one (1) year after termination.` },
      { id:"governinglaw", label:"Governing Law", text:`5. GOVERNING LAW\nThis Agreement will be governed by the laws of the state in which the disclosing party is primarily located.` },
      { id:"dispute", label:"Dispute Resolution", text:`6. DISPUTE RESOLUTION\nAny dispute will be resolved first through good-faith negotiation, then mediation, and finally binding arbitration if necessary.` },
      { id:"signatures", label:"Signature Block", text:`SIGNATURES\nIN WITNESS WHEREOF, the parties have executed this Agreement as of the Effective Date.\n\nSender: ____________________________   Date: __________\nRecipient: __________________________ Date: __________` },
    ];

    const selectedClauseIds = new Set();

    function showStatus(el, msg, type="warn"){
      el.style.display = "";
      el.className = "status " + type;
      el.textContent = msg;
    }

    function clearStatus(el){
      el.style.display = "none";
      el.textContent = "";
    }

    function loadExisting(){
      doc = FSS.loadDocState() || doc;

      // Parties
      aName.value = doc.parties?.aName || "";
      aEmail.value = doc.parties?.aEmail || "";
      bName.value = doc.parties?.bName || "";
      bEmail.value = doc.parties?.bEmail || "";

      // Template
      if(doc.template){
        templateSel.value = doc.template;
      }

      // Upload
      const upName = localStorage.getItem("fss_uploaded_pdf_name");
      if(upName){
        uploadInfo.textContent = `Uploaded: ${upName}`;
      }else{
        uploadInfo.textContent = "No upload yet.";
      }

      // Scratch builder
      if(doc.builder){
        scratchTitle.value = doc.builder.title || "";
        scratchText.value = doc.builder.text || "";
      }
    }

    function saveParties(){
      doc = FSS.loadDocState() || doc;

      doc.parties = doc.parties || {};
      doc.parties.aName = (aName.value || "").trim();
      doc.parties.aEmail = (aEmail.value || "").trim();
      doc.parties.bName = (bName.value || "").trim();
      doc.parties.bEmail = (bEmail.value || "").trim();

      FSS.saveDocState(doc);
    }

    // Build clause chips
    function renderClauseChips(){
      clauseChips.innerHTML = CLAUSES.map(c => `
        <label class="chip">
          <input type="checkbox" data-id="${c.id}" />
          ${c.label}
        </label>
      `).join("");

      clauseChips.querySelectorAll("input[type=checkbox]").forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const id = cb.getAttribute("data-id");
          if(cb.checked) selectedClauseIds.add(id);
          else selectedClauseIds.delete(id);

          // Auto-generate text from selected
          const blocks = CLAUSES
            .filter(x => selectedClauseIds.has(x.id))
            .map(x => x.text);

          if(blocks.length){
            scratchText.value =
`EFFECTIVE DATE: ${new Date().toLocaleDateString()}

${blocks.join("\n\n")}
`;
          }
        });
      });
    }

    // Use template
    useTemplateBtn.addEventListener("click", ()=>{
      saveParties();

      doc = FSS.loadDocState() || doc;

      doc.template = templateSel.value;
      doc.builder = null; // leaving scratch
      doc.status = "draft";
      doc.stage = "create";
      FSS.saveDocState(doc);

      // Clear signed state + fields
      localStorage.removeItem("fss_signed_pdf_b64");
      localStorage.setItem("fss_fields", JSON.stringify([]));
      localStorage.setItem("fss_values", JSON.stringify({}));

      FSS.logAudit(`Template selected: ${doc.template}`);
      showStatus(statusLeft, "Template selected. Continue to Sign to place fields.", "good");
    });

    // Clear upload
    clearUploadBtn.addEventListener("click", ()=>{
      localStorage.removeItem("fss_uploaded_pdf_b64");
      localStorage.removeItem("fss_uploaded_pdf_name");
      uploadInfo.textContent = "No upload yet.";
      FSS.logAudit("Uploaded PDF cleared.");
      showStatus(statusLeft, "Upload cleared.", "good");
    });

    // Upload PDF
    uploadPdf.addEventListener("change", async ()=>{
      clearStatus(statusLeft);

      const file = uploadPdf.files && uploadPdf.files[0];
      if(!file){
        showStatus(statusLeft, "No file selected.", "warn");
        return;
      }

      if(file.type !== "application/pdf"){
        showStatus(statusLeft, "Please upload a PDF file.", "bad");
        return;
      }

      try{
        const buf = await file.arrayBuffer();
        // Convert to base64
        let binary = "";
        const bytes = new Uint8Array(buf);
        for(let i=0; i<bytes.length; i++){
          binary += String.fromCharCode(bytes[i]);
        }
        const b64 = btoa(binary);

        localStorage.setItem("fss_uploaded_pdf_b64", b64);
        localStorage.setItem("fss_uploaded_pdf_name", file.name);

        // Update doc
        saveParties();
        doc = FSS.loadDocState() || doc;
        doc.template = null;
        doc.builder = null;
        doc.status = "draft";
        doc.stage = "create";
        FSS.saveDocState(doc);

        // Clear signed + fields
        localStorage.removeItem("fss_signed_pdf_b64");
        localStorage.setItem("fss_fields", JSON.stringify([]));
        localStorage.setItem("fss_values", JSON.stringify({}));

        uploadInfo.textContent = `Uploaded: ${file.name}`;
        FSS.logAudit(`Uploaded PDF selected: ${file.name}`);
        showStatus(statusLeft, "Upload saved. Continue to Sign to place fields.", "good");
      }catch(err){
        console.error(err);
        showStatus(statusLeft, "Upload failed. Check console.", "bad");
      }
    });

    // Insert defaults
    insertDefaultsBtn.addEventListener("click", ()=>{
      scratchTitle.value = scratchTitle.value || "Mutual Non-Disclosure Agreement";

      scratchText.value =
`EFFECTIVE DATE: ${new Date().toLocaleDateString()}

1. CONFIDENTIALITY
Each party agrees to keep confidential information private and not disclose it to any third party without written consent.

2. PURPOSE
The parties wish to exchange confidential information for evaluation and business discussions.

3. EXCLUSIONS
Confidential information does not include information that is publicly available, already known, independently developed, or disclosed under legal obligation.

4. TERM
This Agreement remains in effect for two (2) years unless terminated earlier in writing.

GOVERNING LAW
This Agreement shall be governed by applicable state laws.

SIGNATURES
Sender: ____________________________   Date: __________
Recipient: __________________________ Date: __________
`;
      showStatus(statusRight, "Defaults inserted. Click “Use Scratch Agreement”.", "good");
    });

    // Use scratch agreement
    useScratchBtn.addEventListener("click", ()=>{
      saveParties();

      const title = (scratchTitle.value || "").trim() || "Agreement";
      const text = (scratchText.value || "").trim();

      if(!text){
        showStatus(statusRight, "Please add agreement text first.", "warn");
        return;
      }

      doc = FSS.loadDocState() || doc;
      doc.builder = {
        title,
        text,
        selectedClauseIds: Array.from(selectedClauseIds),
        customClauses: []
      };
      doc.template = null; // builder takes priority
      doc.status = "draft";
      doc.stage = "create";
      FSS.saveDocState(doc);

      // Clear signed + fields
      localStorage.removeItem("fss_signed_pdf_b64");
      localStorage.setItem("fss_fields", JSON.stringify([]));
      localStorage.setItem("fss_values", JSON.stringify({}));

      FSS.logAudit(`Scratch agreement created: ${title}`);
      showStatus(statusRight, "Scratch agreement saved. Continue to Sign.", "good");
    });

    // Save parties on blur
    [aName,aEmail,bName,bEmail].forEach(el=>{
      el.addEventListener("blur", saveParties);
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      FSS.logout();
      location.replace("index.html");
    });

    // Boot
    renderClauseChips();
    loadExisting();
  </script>
</body>
</html>