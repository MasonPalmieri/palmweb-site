<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSS — Sign Document</title>

  <link rel="stylesheet" href="assets/app.css" />

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";
  </script>

  <style>
    /* Just for this page (keeps it clean) */
    .paper {
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }

    /* PDF page canvas styling */
    .pdf-canvas {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
    }

    /* Clickable fields */
    .field {
      position: absolute;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 190px;
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .field:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .field span {
      display:block;
      font-weight: 950;
      font-size: 14px;
      color:#fff;
    }
    .field small {
      display:block;
      margin-top: 2px;
      font-weight: 750;
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }

    /* Signature Modal */
    .sig-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.60);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 999;
    }
    .sig-modal.show { display: flex; }

    .sig-card {
      width: min(700px, 100%);
      background: #0f172a;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      overflow: hidden;
    }

    .sig-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sig-head strong {
      color:#fff;
      font-weight: 950;
      font-size: 14px;
    }
    .sig-close {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
    }
    .sig-close:hover { background: rgba(255,255,255,.10); }

    .sig-body {
      padding: 16px;
    }

    .sig-tabs {
      display:flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .sig-tab {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-weight: 900;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
    }
    .sig-tab.active {
      background: linear-gradient(135deg, rgba(220,38,38,.95), rgba(234,88,12,.95));
      border-color: transparent;
      color: #fff;
    }

    .sig-preview {
      border: 1px dashed rgba(255,255,255,.22);
      border-radius: 18px;
      padding: 16px;
      background: rgba(255,255,255,.05);
      color: #fff;
      min-height: 160px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    canvas#sigPad {
      width:100%;
      height: 220px;
      border-radius: 18px;
      background: #fff;
      border: 1px solid rgba(255,255,255,.12);
      display:none;
    }

    .sig-actions {
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .sig-note {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight: 750;
    }

    /* Ensure the field layer stays above viewer */
    #sigField, #initField {
      z-index: 15;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-top">
      <div class="app-brand">
        <div class="app-logo">FSS</div>
        <div>
          <div class="app-title">Fill • Send • Sign</div>
          <div class="app-sub">Document Signing Demo</div>
        </div>
      </div>

      <div class="app-actions">
        <a class="btn btn-outline" href="dashboard.html">← Dashboard</a>
        <button class="btn btn-primary" id="completeBtn" type="button">Complete</button>
      </div>
    </header>

    <main class="app-main">
      <div class="layout-two">
        <!-- Left Panel -->
        <aside class="panel">
          <h2 class="panel-title">Signing Summary</h2>
          <p class="panel-sub">Review the details and complete required fields.</p>

          <div class="info-block">
            <div class="info-row">
              <span class="muted">Document</span>
              <span id="docName" style="font-weight:950;">NDA</span>
            </div>
            <div class="info-row">
              <span class="muted">Recipient</span>
              <span id="docRecipient" style="font-weight:950;">client@example.com</span>
            </div>
            <div class="info-row">
              <span class="muted">Status</span>
              <span style="font-weight:950; color:#22c55e;">Pending signature</span>
            </div>
          </div>

          <div class="info-block">
            <div style="font-weight:950; margin-bottom:8px;">Required</div>

            <div class="req-item" id="reqSig">
              <div>
                <div style="font-weight:950;">Signature</div>
                <div class="muted" style="font-size:12px;">Tap “Sign here” on the document</div>
              </div>
              <div class="chip" id="sigChip">Required</div>
            </div>

            <div class="req-item" id="reqInit">
              <div>
                <div style="font-weight:950;">Initial</div>
                <div class="muted" style="font-size:12px;">Tap “Initial here” on the document</div>
              </div>
              <div class="chip" id="initChip">Required</div>
            </div>
          </div>

          <div class="note">
            <strong>Demo note:</strong>
            This is a simulated DocuSign-style workflow using browser storage.
          </div>
        </aside>

        <!-- Right: PDF Viewer -->
        <section class="panel panel-wide" style="padding:0;">
          <div class="paper" id="paper">
            <!-- Viewer Header -->
            <div style="padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <div>
                <div style="font-weight:950; font-size:14px; color:#fff;">Document Preview</div>
                <div style="font-size:12px; color:rgba(255,255,255,.70); font-weight:750;">Scroll through the PDF and complete fields.</div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn btn-outline" id="zoomOutBtn" type="button">−</button>
                <button class="btn btn-outline" id="zoomInBtn" type="button">+</button>
              </div>
            </div>

            <!-- PDF Canvas Stack -->
            <div id="pdfWrap" style="height:560px; overflow:auto; background: radial-gradient(800px 340px at 30% 10%, rgba(220,38,38,.22), transparent 60%), #070b14; padding:18px;">
              <div id="pdfPages" style="display:flex; flex-direction:column; gap:14px; align-items:center;"></div>
            </div>

            <!-- Clickable fields (Demo overlay) -->
            <div
              class="field"
              id="sigField"
              style="left: 22px; bottom: 122px;"
              role="button"
              tabindex="0"
            >
              <span>Sign here</span>
              <small>Party B</small>
            </div>

            <div
              class="field"
              id="initField"
              style="right: 22px; bottom: 122px; min-width: 170px;"
              role="button"
              tabindex="0"
            >
              <span>Initial here</span>
              <small>Party B</small>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="app-foot">
      <span>FSS Demo — PDFs rendered with PDF.js</span>
    </footer>
  </div>

  <!-- Signature Modal -->
  <div class="sig-modal" id="sigModal" aria-hidden="true">
    <div class="sig-card" role="dialog" aria-modal="true">
      <div class="sig-head">
        <strong id="sigTitle">Add Signature</strong>
        <button class="sig-close" id="sigCloseBtn" type="button">✕</button>
      </div>

      <div class="sig-body">
        <div class="sig-tabs">
          <button class="sig-tab active" id="tabType" type="button">Type</button>
          <button class="sig-tab" id="tabDraw" type="button">Draw</button>
        </div>

        <div class="sig-preview" id="typedPreview">
          <div>
            <div style="font-weight:950; font-size:28px; letter-spacing:.5px;" id="typedText">Mason Palmieri</div>
            <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,.70); font-weight:750;">Typed signature preview</div>
          </div>
        </div>

        <canvas id="sigPad"></canvas>

        <div style="margin-top:12px;">
          <label style="display:block; color:#fff; font-weight:900; font-size:13px; margin-bottom:6px;">Your name</label>
          <input id="sigNameInput" type="text" value="Mason Palmieri" style="width:100%; padding:12px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color:#fff; outline:none; font-size:14px;" />
        </div>

        <div class="sig-actions">
          <button class="btn btn-outline" id="clearSigBtn" type="button">Clear</button>
          <button class="btn btn-primary" id="applySigBtn" type="button">Apply</button>
        </div>

        <div class="sig-note">
          This is a demo signature tool. In production you’d store a cryptographic audit trail + signed PDF.
        </div>
      </div>
    </div>
  </div>

  <script src="assets/app.js"></script>

  <script>
    // ===============================
    // Load doc selection + recipient
    // ===============================
    const selectedPdf = localStorage.getItem("fss_selected_pdf") || "nda.pdf";
    const docNameEl = document.getElementById("docName");
    const recipient = localStorage.getItem("fss_recipient") || "client@example.com";
    document.getElementById("docRecipient").textContent = recipient;

    // Friendly names in UI
    const niceName = selectedPdf
      .replace(/[-_]/g, " ")
      .replace(".pdf", "")
      .replace(/\b\w/g, c => c.toUpperCase());

    docNameEl.textContent = niceName;

    // ===============================
    // PDF.js Rendering
    // ===============================
    let currentScale = 1.2;

    const pdfPagesEl = document.getElementById("pdfPages");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");

    async function renderPdf() {
      pdfPagesEl.innerHTML = "";

      const url = `pdfs/${selectedPdf}`;
      const pdf = await pdfjsLib.getDocument(url).promise;

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: currentScale });

        const canvas = document.createElement("canvas");
        canvas.className = "pdf-canvas";
        const ctx = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        pdfPagesEl.appendChild(canvas);
        await page.render({ canvasContext: ctx, viewport }).promise;
      }
    }

    zoomInBtn.addEventListener("click", async () => {
      currentScale = Math.min(currentScale + 0.15, 2.2);
      await renderPdf();
    });

    zoomOutBtn.addEventListener("click", async () => {
      currentScale = Math.max(currentScale - 0.15, 0.7);
      await renderPdf();
    });

    renderPdf();

    // ===============================
    // Signature flow logic
    // ===============================
    const sigField = document.getElementById("sigField");
    const initField = document.getElementById("initField");

    const reqSig = document.getElementById("reqSig");
    const reqInit = document.getElementById("reqInit");
    const sigChip = document.getElementById("sigChip");
    const initChip = document.getElementById("initChip");

    const completeBtn = document.getElementById("completeBtn");

    const sigModal = document.getElementById("sigModal");
    const sigCloseBtn = document.getElementById("sigCloseBtn");
    const applySigBtn = document.getElementById("applySigBtn");
    const clearSigBtn = document.getElementById("clearSigBtn");

    const tabType = document.getElementById("tabType");
    const tabDraw = document.getElementById("tabDraw");
    const typedPreview = document.getElementById("typedPreview");
    const typedText = document.getElementById("typedText");
    const sigPad = document.getElementById("sigPad");
    const sigNameInput = document.getElementById("sigNameInput");
    const sigTitle = document.getElementById("sigTitle");

    let activeField = null;
    let hasSignature = false;
    let hasInitials = false;

    function openSigModal(field) {
      activeField = field;
      sigTitle.textContent = field === "signature" ? "Add Signature" : "Add Initials";
      sigModal.classList.add("show");
      sigModal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeSigModal() {
      sigModal.classList.remove("show");
      sigModal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      activeField = null;
    }

    sigCloseBtn.addEventListener("click", closeSigModal);
    sigModal.addEventListener("click", (e) => {
      if (e.target === sigModal) closeSigModal();
    });

    sigField.addEventListener("click", () => openSigModal("signature"));
    initField.addEventListener("click", () => openSigModal("initials"));

    // Update typed preview
    sigNameInput.addEventListener("input", () => {
      typedText.textContent = sigNameInput.value.trim() || "Your Name";
    });

    // Tabs
    function setTab(mode) {
      const isType = mode === "type";
      tabType.classList.toggle("active", isType);
      tabDraw.classList.toggle("active", !isType);

      typedPreview.style.display = isType ? "flex" : "none";
      sigPad.style.display = isType ? "none" : "block";

      if (!isType) resizePad();
    }

    tabType.addEventListener("click", () => setTab("type"));
    tabDraw.addEventListener("click", () => setTab("draw"));

    // Canvas draw signature
    let drawing = false;
    let ctx = sigPad.getContext("2d");

    function resizePad() {
      const rect = sigPad.getBoundingClientRect();
      sigPad.width = rect.width * devicePixelRatio;
      sigPad.height = 220 * devicePixelRatio;
      ctx = sigPad.getContext("2d");
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#0f172a";
    }

    function startDraw(e) {
      drawing = true;
      ctx.beginPath();
      const { x, y } = getPos(e);
      ctx.moveTo(x, y);
    }

    function draw(e) {
      if (!drawing) return;
      const { x, y } = getPos(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDraw() {
      drawing = false;
    }

    function getPos(e) {
      const rect = sigPad.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    sigPad.addEventListener("mousedown", startDraw);
    sigPad.addEventListener("mousemove", draw);
    sigPad.addEventListener("mouseup", stopDraw);
    sigPad.addEventListener("mouseleave", stopDraw);

    sigPad.addEventListener("touchstart", startDraw, { passive: true });
    sigPad.addEventListener("touchmove", draw, { passive: true });
    sigPad.addEventListener("touchend", stopDraw);

    clearSigBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, sigPad.width, sigPad.height);
    });

    applySigBtn.addEventListener("click", () => {
      if (activeField === "signature") {
        hasSignature = true;
        sigChip.textContent = "Done";
        sigChip.classList.add("done");
        reqSig.classList.add("done");
        sigField.style.opacity = "0.35";
        sigField.style.pointerEvents = "none";
      }

      if (activeField === "initials") {
        hasInitials = true;
        initChip.textContent = "Done";
        initChip.classList.add("done");
        reqInit.classList.add("done");
        initField.style.opacity = "0.35";
        initField.style.pointerEvents = "none";
      }

      closeSigModal();
    });

    // Complete
    completeBtn.addEventListener("click", () => {
      if (!hasSignature || !hasInitials) {
        alert("Please complete all required fields before finishing.");
        return;
      }

      // Save a tiny audit log for demo
      const audit = {
        document: selectedPdf,
        recipient,
        signedBy: sigNameInput.value.trim() || "Signer",
        signedAt: new Date().toISOString()
      };

      localStorage.setItem("fss_last_signed", JSON.stringify(audit));
      window.location.href = "success.html";
    });

    // Default
    setTab("type");
  </script>
</body>
</html>
