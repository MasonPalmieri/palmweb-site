<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Demo • Sign</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    /* ===== Page Shell ===== */
    .page{
      min-height: 100vh;
      padding: 18px 18px 40px;
    }

    /* ===== Top Bar (stable) ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 12px 0 14px;
      margin-bottom: 10px;
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      padding: 10px 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .badge{
      width: 42px; height: 42px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      flex: 0 0 auto;
    }
    .brand-title{
      min-width:0;
    }
    .brand-title strong{
      display:block;
      font-weight: 950;
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-title span{
      display:block;
      font-weight: 800;
      font-size: 12px;
      color: rgba(255,255,255,.70);
    }

    .navlinks{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .navlinks a{
      text-decoration:none;
      font-weight: 900;
      color: rgba(255,255,255,.82);
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition: background .15s ease, transform .06s ease;
      user-select:none;
      white-space: nowrap;
    }
    .navlinks a:hover{ background: rgba(255,255,255,.08); }
    .navlinks a:active{ transform: translateY(1px); }
    .navlinks a.active{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
    }

    .userpill{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .userpill .email{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 900;
      color: rgba(255,255,255,.85);
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ===== Layout ===== */
    .layout{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .card-head{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .card-head h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
    }
    .card-head p{
      margin: 4px 0 0;
      color: rgba(255,255,255,.70);
      font-size: 13px;
      font-weight: 750;
      line-height: 1.4;
    }

    .card-body{
      padding: 14px;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }

    .info{
      display:grid;
      gap: 10px;
    }
    .info .row{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .info .label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.62);
      margin-bottom: 6px;
    }
    .info .value{
      font-size: 13px;
      font-weight: 950;
      color: rgba(255,255,255,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 11px 13px;
      border-radius: 14px;
      border: 1px solid transparent;
      cursor:pointer;
      font-weight: 950;
      user-select:none;
      transition: transform .06s ease, background .15s ease, box-shadow .15s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-primary{
      background: linear-gradient(135deg, #ff3d7a, #43cbff);
      color: #061018;
      box-shadow: 0 18px 40px rgba(255,61,122,.12);
    }
    .btn-outline{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
    }
    .btn-outline:hover{ background: rgba(255,255,255,.09); }
    .btn-danger{
      background: rgba(255,79,99,.18);
      border-color: rgba(255,79,99,.30);
      color: rgba(255,255,255,.92);
    }
    .btn-danger:hover{ background: rgba(255,79,99,.24); }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.64);
      font-weight: 750;
      line-height: 1.45;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.84);
      display:none;
      white-space: pre-wrap;
    }
    .status.bad{ border-color: rgba(255,79,99,.35); background: rgba(255,79,99,.10); }
    .status.good{ border-color: rgba(96,255,157,.35); background: rgba(96,255,157,.10); }
    .status.warn{ border-color: rgba(255,196,82,.35); background: rgba(255,196,82,.10); }

    /* ===== PDF View + Overlay ===== */
    .viewer-toolbar{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .viewer-toolbar .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      white-space: nowrap;
    }

    .toolrow{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tool{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
      transition: background .15s ease, transform .06s ease;
    }
    .tool:hover{ background: rgba(255,255,255,.09); }
    .tool:active{ transform: translateY(1px); }

    .viewer-wrap{
      padding: 12px;
      height: min(76vh, 820px);
      overflow:auto;
      position:relative;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .pdf-stage{
      position:relative;
      width: 100%;
      min-height: 640px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }

    /* Use iframe for crisp PDF viewing */
    #pdfFrame{
      width: 100%;
      height: 100%;
      border: 0;
      display:block;
      background:#fff;
    }

    /* Overlay for drag/drop fields (absolute positioned on top of PDF) */
    .overlay{
      position:absolute;
      inset: 0;
      pointer-events:none; /* only field boxes accept events */
    }

    .field{
      position:absolute;
      pointer-events:auto;
      user-select:none;
      touch-action:none;
      border-radius: 12px;
      border: 1px solid rgba(67,203,255,.55);
      background: rgba(67,203,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      min-width: 110px;
      min-height: 34px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor: grab;
    }
    .field:active{ cursor: grabbing; }

    .field .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .field .type{
      font-size: 11px;
      font-weight: 950;
      color: rgba(255,255,255,.80);
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .field .val{
      font-size: 14px;
      font-weight: 950;
      color: rgba(255,255,255,.96);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }

    .field .xbtn{
      border: 0;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      border-radius: 10px;
      width: 30px;
      height: 30px;
      cursor:pointer;
      font-weight: 950;
    }
    .field .xbtn:hover{ background: rgba(0,0,0,.28); }

    .field.signature{
      border-color: rgba(96,255,157,.55);
      background: rgba(96,255,157,.12);
    }
    .field.date{
      border-color: rgba(255,196,82,.55);
      background: rgba(255,196,82,.12);
    }
    .field.text{
      border-color: rgba(255,61,122,.55);
      background: rgba(255,61,122,.10);
    }

    /* Small helper */
    .kbd{
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      color: rgba(255,255,255,.84);
      display:inline-flex;
      align-items:center;
      gap: 6px;
      width: fit-content;
    }
  </style>
</head>

<body class="app">
  <div class="page">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="badge">FSS</div>
          <div class="brand-title">
            <strong>Client Demo</strong>
            <span>Fill → Sign → Send</span>
          </div>
        </div>

        <div class="navlinks">
          <a href="dashboard.html">Dashboard</a>
          <a href="create.html">Create</a>
          <a href="sign.html" class="active">Sign</a>
          <a href="completed.html">Completed</a>
        </div>

        <div class="userpill">
          <div class="email" id="userEmail">—</div>
          <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="card">
        <div class="card-head">
          <div>
            <h2>Sign</h2>
            <p>Drag fields onto the document, edit values, then generate a signed PDF.</p>
          </div>
        </div>

        <div class="card-body">
          <div class="info">
            <div class="row">
              <div class="label">Agreement</div>
              <div class="value" id="agreementVal">—</div>
            </div>
            <div class="row">
              <div class="label">Sender</div>
              <div class="value" id="senderVal">—</div>
            </div>
            <div class="row">
              <div class="label">Recipient</div>
              <div class="value" id="recipientVal">—</div>
            </div>
            <div class="row">
              <div class="label">Source</div>
              <div class="value" id="sourceVal">—</div>
            </div>
          </div>

          <div class="divider"></div>

          <div style="font-weight:950; font-size:13px; color:rgba(255,255,255,.86); margin-bottom:8px;">
            Add a field (then drag onto PDF)
          </div>

          <div class="actions">
            <button class="btn btn-outline" id="addSigBtn" type="button">+ Signature</button>
            <button class="btn btn-outline" id="addDateBtn" type="button">+ Date</button>
            <button class="btn btn-outline" id="addTextBtn" type="button">+ Text</button>
            <button class="btn btn-danger" id="clearFieldsBtn" type="button">Clear Fields</button>
          </div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn btn-primary" id="signBtn" type="button">Sign as Sender</button>
            <a class="btn btn-outline" id="downloadBtn" href="#" style="display:none;">Download Signed PDF</a>
          </div>

          <div class="hint">
            <div class="kbd">Tip</div>
            Tap a field to edit its value. Drag it to reposition. Works on iOS + desktop.
          </div>

          <div class="status warn" id="statusBox"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="viewer-toolbar">
          <div class="left">
            <span class="pill">PDF</span>
            <span class="pill" id="pdfLabel">Loading…</span>
          </div>
          <div class="toolrow">
            <button class="tool" id="zoomOutBtn" type="button">−</button>
            <button class="tool" id="zoomInBtn" type="button">+</button>
            <button class="tool" id="refreshBtn" type="button">Refresh</button>
            <button class="tool" id="openBtn" type="button">Open</button>
          </div>
        </div>

        <div class="viewer-wrap" id="viewerScroll">
          <div class="pdf-stage" id="pdfStage">
            <iframe id="pdfFrame" title="PDF Preview"></iframe>
            <div class="overlay" id="overlay"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/app.js"></script>
  <script>
    /* =========================
       GUARD + USER
       ========================= */
    FSS.guard();

    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userEmail").textContent = auth.email || "demo@client.com";

    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    /* =========================
       STATE + DOM
       ========================= */
    const statusBox = document.getElementById("statusBox");
    const pdfFrame = document.getElementById("pdfFrame");
    const pdfLabel = document.getElementById("pdfLabel");
    const overlay = document.getElementById("overlay");
    const pdfStage = document.getElementById("pdfStage");

    const agreementVal = document.getElementById("agreementVal");
    const senderVal = document.getElementById("senderVal");
    const recipientVal = document.getElementById("recipientVal");
    const sourceVal = document.getElementById("sourceVal");

    const downloadBtn = document.getElementById("downloadBtn");

    let zoom = 120;
    let currentPdfUrl = "";
    let lastObjectUrl = "";

    function showStatus(msg, type="warn"){
      statusBox.style.display = "";
      statusBox.className = "status " + type;
      statusBox.textContent = msg;
    }
    function clearStatus(){
      statusBox.style.display = "none";
      statusBox.textContent = "";
    }

    function revokeLastUrl(){
      try{
        if(lastObjectUrl){
          URL.revokeObjectURL(lastObjectUrl);
          lastObjectUrl = "";
        }
      }catch{}
    }

    function detectSource(doc){
      if(localStorage.getItem("fss_uploaded_pdf_b64")) return "Uploaded PDF";
      if(doc?.builder?.text) return "Built from scratch";
      return (doc?.template ? ("Template: " + doc.template) : "Template");
    }

    /* =========================
       LOAD PDF SOURCE URL
       ========================= */
    async function getPdfUrlForViewer(){
      const doc = FSS.loadDocState();
      if(!doc) throw new Error("No document state found. Go to Create.");

      // Upload
      const up = localStorage.getItem("fss_uploaded_pdf_b64");
      if(up){
        revokeLastUrl();
        const url = FSS.base64ToBlobURL(up);
        lastObjectUrl = url;
        return url;
      }

      // Scratch builder
      if(doc.builder && doc.builder.text){
        const bytes = await FSS.generateBuilderPDFBytes();
        if(!bytes) throw new Error("Builder PDF failed. Check console.");

        // bytes is Uint8Array
        let bin = "";
        for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
        const b64 = btoa(bin);

        revokeLastUrl();
        const url = FSS.base64ToBlobURL(b64);
        lastObjectUrl = url;
        return url;
      }

      // Template
      const t = doc.template || "nda.pdf";
      return "pdfs/" + encodeURIComponent(t);
    }

    async function loadViewer(){
      clearStatus();

      const doc = FSS.loadDocState();
      if(!doc){
        showStatus("No agreement found. Go to Create first.", "bad");
        pdfLabel.textContent = "No doc";
        return;
      }

      agreementVal.textContent = doc.title || doc.builder?.title || "Agreement";
      senderVal.textContent = doc.parties?.aName ? `${doc.parties.aName} (${doc.parties.aEmail || "—"})` : "Not provided";
      recipientVal.textContent = doc.parties?.bName ? `${doc.parties.bName} (${doc.parties.bEmail || "—"})` : "Not provided";
      sourceVal.textContent = detectSource(doc);

      pdfLabel.textContent = "Loading…";

      try{
        const url = await getPdfUrlForViewer();

        // Native PDF viewer zoom via #zoom= (works in most browsers)
        // iOS Safari ignores zoom param — but it’s fine.
        currentPdfUrl = url + `#zoom=${zoom}`;

        pdfFrame.src = currentPdfUrl;

        pdfLabel.textContent = "Ready";
        renderFields();
      }catch(err){
        console.error(err);
        pdfLabel.textContent = "Error";
        showStatus(err.message || "Failed to load PDF.", "bad");
      }
    }

    /* =========================
       FIELD MODEL
       - fields stored in FSS.loadFields()
       - values stored in FSS.loadValues()
       - We store overlay coords relative to stage in px
       ========================= */
    function getFields(){
      return FSS.loadFields() || [];
    }
    function setFields(arr){
      FSS.saveFields(arr || []);
      renderFields();
    }

    function getValues(){
      return FSS.loadValues() || {};
    }
    function setValues(obj){
      FSS.saveValues(obj || {});
      renderFields();
    }

    function fieldDefaultValue(type){
      const doc = FSS.loadDocState() || {};
      const senderName = doc.parties?.aName || "Sender";
      if(type === "signature") return senderName;
      if(type === "date") return new Date().toLocaleDateString();
      if(type === "text") return "Enter text…";
      return "";
    }

    function addField(type){
      const fields = getFields();
      const id = FSS.uid();

      // Default placement at top-left area; user drags into place.
      const f = {
        id,
        type,
        page: 1,
        x: 80,
        y: 120 + fields.length * 60,
        w: type === "signature" ? 220 : (type === "text" ? 220 : 160),
        h: 44,
        required: true,
        role: "sender",
        label: type
      };

      fields.push(f);
      setFields(fields);

      const values = getValues();
      values[id] = fieldDefaultValue(type);
      setValues(values);

      showStatus("Field added. Drag it onto the document.", "good");
    }

    function deleteField(id){
      const fields = getFields().filter(f => f.id !== id);
      setFields(fields);

      const values = getValues();
      delete values[id];
      setValues(values);
    }

    function clearAllFields(){
      setFields([]);
      setValues({});
      showStatus("Cleared all fields.", "good");
    }

    /* =========================
       RENDER FIELDS OVERLAY
       ========================= */
    function renderFields(){
      overlay.innerHTML = "";

      const fields = getFields();
      const values = getValues();

      for(const f of fields){
        const el = document.createElement("div");
        el.className = "field " + f.type;
        el.style.left = (f.x || 0) + "px";
        el.style.top  = (f.y || 0) + "px";
        el.style.width = (f.w || 160) + "px";
        el.style.height = (f.h || 44) + "px";
        el.dataset.id = f.id;

        const left = document.createElement("div");
        left.className = "left";

        const type = document.createElement("div");
        type.className = "type";
        type.textContent = f.type;

        const val = document.createElement("div");
        val.className = "val";
        val.textContent = (values[f.id] != null ? String(values[f.id]) : "");

        left.appendChild(type);
        left.appendChild(val);

        const xbtn = document.createElement("button");
        xbtn.className = "xbtn";
        xbtn.type = "button";
        xbtn.textContent = "✕";
        xbtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteField(f.id);
        });

        el.appendChild(left);
        el.appendChild(xbtn);

        // Tap to edit (prompt) — works on iOS
        el.addEventListener("click", (e) => {
          // Avoid click after drag
          if(el.dataset.dragging === "1") return;
          e.preventDefault();
          e.stopPropagation();
          editFieldValue(f.id, f.type);
        });

        // Drag handlers (Pointer Events)
        attachDrag(el);

        overlay.appendChild(el);
      }

      // show download if exists
      downloadBtn.style.display = FSS.hasSignedPDF() ? "" : "none";
      if(FSS.hasSignedPDF()){
        downloadBtn.href = "#";
      }
    }

    function editFieldValue(id, type){
      const values = getValues();
      const current = values[id] != null ? String(values[id]) : "";

      let label = "Enter value:";
      if(type === "signature") label = "Enter your signature name:";
      if(type === "date") label = "Enter date:";
      if(type === "text") label = "Enter text:";

      const val = prompt(label, current || fieldDefaultValue(type));
      if(val == null) return;

      values[id] = String(val);
      setValues(values);
    }

    function attachDrag(el){
      let startX = 0, startY = 0;
      let origX = 0, origY = 0;

      const onDown = (e) => {
        e.preventDefault();
        e.stopPropagation();

        // pointer capture for iOS/desktop stability
        el.setPointerCapture?.(e.pointerId);

        el.dataset.dragging = "0";
        startX = e.clientX;
        startY = e.clientY;

        const id = el.dataset.id;
        const fields = getFields();
        const f = fields.find(x => x.id === id);
        origX = f ? (f.x || 0) : 0;
        origY = f ? (f.y || 0) : 0;

        window.addEventListener("pointermove", onMove, { passive:false });
        window.addEventListener("pointerup", onUp, { passive:false });
        window.addEventListener("pointercancel", onUp, { passive:false });
      };

      const onMove = (e) => {
        e.preventDefault();

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        if(Math.abs(dx) + Math.abs(dy) > 5){
          el.dataset.dragging = "1";
        }

        const id = el.dataset.id;
        const fields = getFields();
        const f = fields.find(x => x.id === id);
        if(!f) return;

        const stageRect = pdfStage.getBoundingClientRect();
        const maxX = Math.max(0, stageRect.width - (f.w || 160));
        const maxY = Math.max(0, stageRect.height - (f.h || 44));

        // Update in-memory and DOM
        const nx = Math.max(0, Math.min(maxX, origX + dx));
        const ny = Math.max(0, Math.min(maxY, origY + dy));

        f.x = nx;
        f.y = ny;

        el.style.left = nx + "px";
        el.style.top = ny + "px";
      };

      const onUp = (e) => {
        try{ e.preventDefault(); }catch{}

        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);
        window.removeEventListener("pointercancel", onUp);

        const id = el.dataset.id;
        const fields = getFields();
        const f = fields.find(x => x.id === id);
        if(!f) return;

        // Persist updated positions
        FSS.saveFields(fields);

        // Reset dragging flag after click would have happened
        setTimeout(() => { el.dataset.dragging = "0"; }, 50);
      };

      el.addEventListener("pointerdown", onDown, { passive:false });
    }

    /* =========================
       ACTIONS
       ========================= */
    document.getElementById("addSigBtn").addEventListener("click", () => addField("signature"));
    document.getElementById("addDateBtn").addEventListener("click", () => addField("date"));
    document.getElementById("addTextBtn").addEventListener("click", () => addField("text"));
    document.getElementById("clearFieldsBtn").addEventListener("click", () => {
      if(!confirm("Clear all fields?")) return;
      clearAllFields();
    });

    /* ===== Sign as sender ===== */
    document.getElementById("signBtn").addEventListener("click", async () => {
      clearStatus();

      const doc = FSS.loadDocState();
      if(!doc){
        showStatus("No agreement found. Go to Create first.", "bad");
        return;
      }

      const fields = getFields();
      if(fields.length === 0){
        showStatus("Add at least 1 field before signing.", "warn");
        return;
      }

      try{
        showStatus("Generating signed PDF…", "warn");

        // Fill defaults for missing values
        const vals = getValues();
        for(const f of fields){
          if(vals[f.id] == null || String(vals[f.id]).trim() === ""){
            vals[f.id] = fieldDefaultValue(f.type);
          }
        }
        setValues(vals);

        const ok = await FSS.generateSignedPDF();
        if(!ok){
          showStatus("Signing failed. Open console for details.", "bad");
          return;
        }

        FSS.logAudit("Sender signed and generated signed PDF.");
        showStatus("✅ Signed PDF generated. Download available.", "good");

        downloadBtn.style.display = "";
      }catch(err){
        console.error(err);
        showStatus(err.message || "Signing failed.", "bad");
      }
    });

    /* ===== Download Signed PDF ===== */
    downloadBtn.addEventListener("click", (e) => {
      e.preventDefault();

      const b64 = FSS.getSignedBase64();
      if(!b64){
        showStatus("No signed PDF exists yet.", "warn");
        return;
      }

      const byteChars = atob(b64);
      const bytes = new Uint8Array(byteChars.length);
      for(let i=0; i<byteChars.length; i++){
        bytes[i] = byteChars.charCodeAt(i);
      }

      const blob = new Blob([bytes], { type:"application/pdf" });
      const url = URL.createObjectURL(blob);

      const doc = FSS.loadDocState() || {};
      const a = document.createElement("a");
      a.href = url;
      a.download = `FSS-${(doc.id || "agreement")}-signed.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 2000);
    });

    /* =========================
       VIEWER TOOLS (fixed)
       ========================= */
    document.getElementById("zoomInBtn").addEventListener("click", async () => {
      zoom = Math.min(200, zoom + 10);
      await loadViewer();
      showStatus(`Zoom: ${zoom}%`, "good");
    });

    document.getElementById("zoomOutBtn").addEventListener("click", async () => {
      zoom = Math.max(70, zoom - 10);
      await loadViewer();
      showStatus(`Zoom: ${zoom}%`, "good");
    });

    document.getElementById("refreshBtn").addEventListener("click", async () => {
      await loadViewer();
      showStatus("Viewer refreshed.", "good");
    });

    document.getElementById("openBtn").addEventListener("click", async () => {
      try{
        const url = await getPdfUrlForViewer();
        window.open(url, "_blank");
      }catch(err){
        showStatus("Unable to open PDF. " + (err.message || ""), "bad");
      }
    });

    /* =========================
       INIT
       ========================= */
    (async function boot(){
      // Ensure a doc exists
      if(!FSS.loadDocState()){
        FSS.resetDoc();
      }

      // Populate stage info
      await loadViewer();

      // If no fields exist yet, add default signature + date
      const fields = getFields();
      if(fields.length === 0){
        addField("signature");
        addField("date");
        showStatus("Default Signature + Date fields added. Drag them into place.", "good");
      }else{
        renderFields();
      }
    })();
  </script>
</body>
</html>