<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Demo • Sign</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    .page { padding: 18px 18px 34px; max-width: 1600px; margin: 0 auto; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      margin-bottom: 14px;
    }
    .brand { display:flex; align-items:center; gap:10px; color: rgba(255,255,255,.92); font-weight: 950; }
    .brand .badge{
      width: 36px; height: 36px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
    }
    .brand .meta { display:flex; flex-direction:column; gap:1px; }
    .brand .meta small { color: rgba(255,255,255,.70); font-weight: 850; }

    .navlinks { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .navlinks a{
      text-decoration:none; color: rgba(255,255,255,.80);
      font-weight: 900; padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05);
    }
    .navlinks a.active { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16); color: rgba(255,255,255,.95); }

    .rightmeta { display:flex; align-items:center; gap:10px; }
    .pill{
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
      font-weight: 900; font-size: 13px;
    }
    .toolbtn{
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950; cursor:pointer; user-select:none;
    }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }

    .card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 26px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding: 14px 14px 10px;
      font-size: 16px; font-weight: 950;
      color: rgba(255,255,255,.92);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .card .body{ padding: 12px 14px 14px; color: rgba(255,255,255,.88); }

    .kv{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      font-weight: 900;
      color: rgba(255,255,255,.90);
      font-size: 13px;
    }
    .kv small{ display:block; color: rgba(255,255,255,.65); font-weight: 850; margin-bottom:6px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950; cursor:pointer;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(67,203,255,.95), rgba(96,255,157,.85));
      color: rgba(5,12,18,.95);
    }
    .btn.danger{
      background: rgba(255,79,99,.12);
      border-color: rgba(255,79,99,.30);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight: 800;
      line-height: 1.45;
    }

    /* Viewer */
    .viewerHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .viewerHead .title{
      display:flex; align-items:center; gap:10px;
      color: rgba(255,255,255,.92); font-weight: 950;
      min-width:0;
    }
    .viewerHead .title .tag{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 950;
    }
    .tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .viewerWrap{ padding: 12px; }
    .viewerFrame{
      height: calc(100vh - 200px);
      min-height: 660px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:auto;
      position: relative;
    }
    .stage{
      position: relative;
      width: fit-content;
      margin: 0 auto;
      padding: 12px;
    }
    canvas{
      display:block;
      background: #fff;
      border-radius: 12px;
    }

    /* Overlay for fields */
    .overlay{
      position:absolute;
      left: 12px;
      top: 12px;
      pointer-events:none;
    }
    .field{
      position:absolute;
      min-width: 160px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 13px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
      pointer-events:auto; /* allows dragging/click */
      touch-action:none; /* iOS drag */
    }
    .field .meta{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .field .meta .label{
      font-size: 10px;
      font-weight: 950;
      color: rgba(255,255,255,.72);
      letter-spacing: .4px;
    }
    .field .meta .value{
      font-size: 13px;
      font-weight: 950;
      color: rgba(255,255,255,.96);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 220px;
    }
    .field .x{
      width: 22px; height: 22px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      flex: 0 0 auto;
      user-select:none;
    }

    .field.sig { border-color: rgba(96,255,157,.35); background: rgba(12,30,20,.65); }
    .field.date { border-color: rgba(255,213,79,.30); background: rgba(30,24,10,.65); }
    .field.text { border-color: rgba(67,203,255,.35); background: rgba(10,22,30,.65); }

    .statusLine{
      padding: 10px 14px 14px;
      color: rgba(255,255,255,.72);
      font-weight: 850;
      font-size: 13px;
    }

    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
      .viewerFrame { height: 62vh; min-height: 480px; }
    }
  </style>
</head>

<body class="app">
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="badge">FSS</div>
        <div class="meta">
          <div>Client Demo</div>
          <small>Fill → Sign → Send</small>
        </div>
      </div>

      <div class="navlinks">
        <a href="dashboard.html">Dashboard</a>
        <a href="create.html">Create</a>
        <a class="active" href="sign.html">Sign</a>
        <a href="success.html">Completed</a>
      </div>

      <div class="rightmeta">
        <div class="pill" id="userPill">demo@client.com</div>
        <button class="toolbtn" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Sign</h2>
        <div class="body">
          <div style="color:rgba(255,255,255,.72); font-weight:850; font-size:13px;">
            Drag fields onto the document, edit values, then generate a signed PDF.
          </div>

          <div class="kv">
            <small>Agreement</small>
            <div id="kvAgreement">—</div>
          </div>

          <div class="kv">
            <small>Sender</small>
            <div id="kvSender">—</div>
          </div>

          <div class="kv">
            <small>Recipient</small>
            <div id="kvRecipient">—</div>
          </div>

          <div class="kv">
            <small>Source</small>
            <div id="kvSource">—</div>
          </div>

          <div style="margin-top:14px; font-weight:950;">Add a field (then drag onto PDF)</div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="addSigBtn" type="button">+ Signature</button>
            <button class="btn" id="addDateBtn" type="button">+ Date</button>
            <button class="btn" id="addTextBtn" type="button">+ Text</button>
            <button class="btn danger" id="clearBtn" type="button">Clear Fields</button>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn primary" id="signBtn" type="button">Sign as Sender</button>
          </div>

          <div class="hint">
            Tip: Tap a field to edit its value. Drag to reposition. Works on iOS + desktop.
          </div>

          <div class="statusLine" id="leftStatus"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="viewerHead">
          <div class="title">
            <span class="tag">PDF</span>
            <span id="pdfName">Ready</span>
          </div>
          <div class="tools">
            <button class="toolbtn" id="fitBtn" type="button">Fit</button>
            <button class="toolbtn" id="zoomOutBtn" type="button">–</button>
            <button class="toolbtn" id="zoomInBtn" type="button">+</button>
            <button class="toolbtn" id="refreshBtn" type="button">Refresh</button>
            <button class="toolbtn" id="openBtn" type="button">Open</button>
          </div>
        </div>

        <div class="viewerWrap">
          <div class="viewerFrame" id="viewerFrame">
            <div class="stage" id="stage">
              <canvas id="pdfCanvas"></canvas>
              <div class="overlay" id="overlay"></div>
            </div>
          </div>
        </div>

        <div class="statusLine" id="rightStatus">Loading…</div>
      </div>
    </div>
  </div>

  <script src="assets/app.js"></script>

  <script type="module">
    import * as pdfjsLib from "./pdfjs/build/pdf.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdfjs/build/pdf.worker.mjs";

    // ---- Guard + top bar ----
    FSS.guard();
    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userPill").textContent = auth.email || "demo@client.com";
    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    // ---- DOM ----
    const leftStatus = document.getElementById("leftStatus");
    const rightStatus = document.getElementById("rightStatus");
    const pdfName = document.getElementById("pdfName");

    const kvAgreement = document.getElementById("kvAgreement");
    const kvSender = document.getElementById("kvSender");
    const kvRecipient = document.getElementById("kvRecipient");
    const kvSource = document.getElementById("kvSource");

    const addSigBtn = document.getElementById("addSigBtn");
    const addDateBtn = document.getElementById("addDateBtn");
    const addTextBtn = document.getElementById("addTextBtn");
    const clearBtn = document.getElementById("clearBtn");
    const signBtn = document.getElementById("signBtn");

    const fitBtn = document.getElementById("fitBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const openBtn = document.getElementById("openBtn");

    const viewerFrame = document.getElementById("viewerFrame");
    const stage = document.getElementById("stage");
    const overlay = document.getElementById("overlay");
    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");

    function setLeftStatus(msg){ leftStatus.textContent = msg || ""; }
    function setRightStatus(msg){ rightStatus.textContent = msg || ""; }

    // ---- State ----
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.0;

    // fields stored as percent positions relative to rendered canvas
    // { id, type, label, value, xPct, yPct }
    let fields = [];

    // ---- Load doc state ----
    function hydrateHeader(){
      const d = FSS.loadDocState() || {};
      const parties = d.parties || {};

      kvAgreement.textContent = d.template || d.builder?.title || "Agreement";
      kvSender.textContent = parties.aName ? `${parties.aName} (${parties.aEmail || ""})` : "—";
      kvRecipient.textContent = parties.bName ? `${parties.bName} (${parties.bEmail || ""})` : "—";

      if (localStorage.getItem("fss_uploaded_pdf_b64")) kvSource.textContent = "Upload";
      else if (d.builder?.text) kvSource.textContent = "Builder";
      else kvSource.textContent = "Template";
    }

    function getSourceFromState(){
      const d = FSS.loadDocState();
      if(!d) throw new Error("No document state found. Go to Create first.");

      // signed pdf overrides
      const signedB64 = localStorage.getItem("fss_signed_pdf_b64");
      if (signedB64) {
        return { kind:"data", data: base64ToBytes(signedB64), name: "Signed PDF" };
      }

      // upload
      const upB64 = localStorage.getItem("fss_uploaded_pdf_b64");
      const upName = localStorage.getItem("fss_uploaded_pdf_name") || "Uploaded.pdf";
      if (upB64) {
        return { kind:"data", data: base64ToBytes(upB64), name: upName };
      }

      // builder
      if (d.builder?.text) {
        return { kind:"builder", name: d.builder.title || "Agreement" };
      }

      // template
      const tpl = d.template || "nda.pdf";
      return { kind:"url", url: `pdfs/${encodeURIComponent(tpl)}`, name: tpl };
    }

    function base64ToBytes(b64){
      const byteChars = atob(b64);
      const bytes = new Uint8Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
      return bytes;
    }

    // ---- PDF load + render ----
    async function loadPdf(){
      hydrateHeader();

      const src = getSourceFromState();
      pdfName.textContent = src.name || "PDF";

      // builder needs pdf-lib generation
      if (src.kind === "builder") {
        const ok = await FSS.ensurePdfLib();
        if (!ok) throw new Error("pdf-lib failed to load for builder.");
        const bytes = await FSS.generateBuilderPDFBytes();
        if (!bytes) throw new Error("Builder PDF failed. Check console.");
        pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
      } else if (src.kind === "url") {
        pdfDoc = await pdfjsLib.getDocument({ url: src.url }).promise;
      } else {
        pdfDoc = await pdfjsLib.getDocument({ data: src.data }).promise;
      }

      pageNum = 1;
      scale = 1.0;
      await renderPage(true);
    }

    async function renderPage(forceFit = false){
      if(!pdfDoc) return;

      const page = await pdfDoc.getPage(pageNum);

      const unscaled = page.getViewport({ scale: 1.0 });
      const maxW = Math.max(320, viewerFrame.clientWidth - 64);
      const fitScale = Math.max(0.2, Math.min(3.0, maxW / unscaled.width));

      if (forceFit || !scale || scale === 1.0) scale = fitScale;

      const viewport = page.getViewport({ scale });

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      // stage width follows canvas width
      stage.style.width = `${canvas.width + 24}px`;

      // overlay matches canvas size
      overlay.style.width = `${canvas.width}px`;
      overlay.style.height = `${canvas.height}px`;

      setRightStatus(`Rendering… (zoom ${Math.round(scale*100)}%)`);
      await page.render({ canvasContext: ctx, viewport }).promise;
      setRightStatus(`Ready (zoom ${Math.round(scale*100)}%).`);

      renderFields();
    }

    // ---- Fields rendering / editing ----
    function todayStr(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yy = d.getFullYear();
      return `${mm}/${dd}/${yy}`;
    }

    function createField(type){
      const id = `f_${Math.random().toString(16).slice(2)}`;
      const defaults = {
        signature: { label:"SIGNATURE", value: (auth.email || "Signed").split("@")[0] || "Signed" },
        date: { label:"DATE", value: todayStr() },
        text: { label:"TEXT", value:"Click to edit" },
      }[type];

      const f = {
        id,
        type,
        label: defaults.label,
        value: defaults.value,
        xPct: 0.18,
        yPct: 0.18 + (fields.length * 0.08),
      };
      fields.push(f);
      renderFields();
    }

    function renderFields(){
      overlay.innerHTML = "";

      for (const f of fields){
        const el = document.createElement("div");
        el.className = `field ${f.type === "signature" ? "sig" : f.type === "date" ? "date" : "text"}`;
        el.dataset.id = f.id;

        const x = Math.round(f.xPct * canvas.width);
        const y = Math.round(f.yPct * canvas.height);

        el.style.left = `${x}px`;
        el.style.top = `${y}px`;

        el.innerHTML = `
          <div class="meta">
            <div class="label">${f.label}</div>
            <div class="value">${escapeHtml(f.value)}</div>
          </div>
          <div class="x" title="Remove">×</div>
        `;

        // Remove
        el.querySelector(".x").addEventListener("click", (e) => {
          e.stopPropagation();
          fields = fields.filter(ff => ff.id !== f.id);
          renderFields();
        });

        // Tap to edit
        el.addEventListener("click", (e) => {
          // don't trigger on drag end weirdness
          if (el.dataset.dragging === "1") return;
          const next = prompt(`Edit ${f.label}`, f.value);
          if (next !== null){
            f.value = String(next);
            renderFields();
          }
        });

        enableDrag(el, f);
        overlay.appendChild(el);
      }
    }

    function enableDrag(el, f){
      let startX = 0, startY = 0, origLeft = 0, origTop = 0;

      function onDown(ev){
        ev.preventDefault();
        el.setPointerCapture(ev.pointerId);

        el.dataset.dragging = "0";
        startX = ev.clientX;
        startY = ev.clientY;
        origLeft = parseFloat(el.style.left || "0");
        origTop = parseFloat(el.style.top || "0");

        document.addEventListener("pointermove", onMove);
        document.addEventListener("pointerup", onUp, { once:true });
      }

      function onMove(ev){
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;

        if (Math.abs(dx) + Math.abs(dy) > 3) el.dataset.dragging = "1";

        let newLeft = origLeft + dx;
        let newTop = origTop + dy;

        // clamp
        newLeft = Math.max(0, Math.min(canvas.width - 40, newLeft));
        newTop = Math.max(0, Math.min(canvas.height - 40, newTop));

        el.style.left = `${newLeft}px`;
        el.style.top = `${newTop}px`;

        f.xPct = newLeft / canvas.width;
        f.yPct = newTop / canvas.height;
      }

      function onUp(){
        document.removeEventListener("pointermove", onMove);
        setTimeout(() => { el.dataset.dragging = "0"; }, 0);
      }

      el.addEventListener("pointerdown", onDown, { passive:false });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---- Actions ----
    addSigBtn.addEventListener("click", () => createField("signature"));
    addDateBtn.addEventListener("click", () => createField("date"));
    addTextBtn.addEventListener("click", () => createField("text"));

    clearBtn.addEventListener("click", () => {
      if (!confirm("Clear all fields?")) return;
      fields = [];
      renderFields();
    });

    fitBtn.addEventListener("click", () => renderPage(true));
    zoomInBtn.addEventListener("click", () => { scale = Math.min(3.0, (scale||1)*1.12); renderPage(false); });
    zoomOutBtn.addEventListener("click", () => { scale = Math.max(0.2, (scale||1)/1.12); renderPage(false); });

    refreshBtn.addEventListener("click", async () => {
      try{
        await loadPdf();
      }catch(e){
        console.error(e);
        alert(e.message || String(e));
      }
    });

    openBtn.addEventListener("click", async () => {
      try{
        const src = getSourceFromState();
        if (src.kind === "url") return window.open(src.url, "_blank");
        if (src.kind === "data") {
          const blob = new Blob([src.data], { type:"application/pdf" });
          return window.open(URL.createObjectURL(blob), "_blank");
        }
        // builder
        const ok = await FSS.ensurePdfLib();
        if(!ok) throw new Error("pdf-lib failed to load.");
        const bytes = await FSS.generateBuilderPDFBytes();
        const blob = new Blob([bytes], { type:"application/pdf" });
        window.open(URL.createObjectURL(blob), "_blank");
      }catch(e){
        console.error(e);
        alert(e.message || String(e));
      }
    });

    signBtn.addEventListener("click", async () => {
      try{
        setLeftStatus("Generating signed PDF…");

        // Save fields to doc state so pdf-lib generator can use them
        const d = FSS.loadDocState() || {};
        d.fields = fields.map(f => ({
          id: f.id,
          type: f.type,
          label: f.label,
          value: f.value,
          xPct: f.xPct,
          yPct: f.yPct,
          page: 1,
        }));
        FSS.saveDocState(d);

        const ok = await FSS.ensurePdfLib();
        if(!ok) throw new Error("pdf-lib failed to load.");

        // Generate signed PDF bytes (must exist in your assets/app.js)
        const bytes = await FSS.generateSignedPDFBytes();
        if(!bytes) throw new Error("Signed PDF generation failed. Open DevTools console.");

        // Store signed PDF for this session
        const b64 = bytesToBase64(bytes);
        localStorage.setItem("fss_signed_pdf_b64", b64);

        setLeftStatus("Signed PDF generated. Reloading preview…");
        await loadPdf();
        setLeftStatus("Signed PDF ready.");
      }catch(e){
        console.error(e);
        alert(e.message || String(e));
        setLeftStatus("Error: " + (e.message || String(e)));
      }
    });

    function bytesToBase64(u8){
      let s = "";
      for(let i=0;i<u8.length;i++) s += String.fromCharCode(u8[i]);
      return btoa(s);
    }

    // ---- Init ----
    (async function init(){
      try{
        setRightStatus("Loading…");
        await loadPdf();
        // Add defaults if none
        if(fields.length === 0){
          createField("signature");
          createField("date");
        }
        setLeftStatus("");
      }catch(e){
        console.error(e);
        alert(e.message || String(e));
        setRightStatus("Failed to load PDF.");
      }
    })();
  </script>
</body>
</html>