<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign â€¢ Client Demo</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 18px 50px;
    }

    .page-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .page-head h1{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -0.2px;
    }

    .page-head p{
      margin: 6px 0 0;
      font-size: 13px;
      color: rgba(255,255,255,.72);
      font-weight: 750;
      max-width: 90ch;
      line-height: 1.5;
    }

    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 10px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 24px 80px rgba(0,0,0,.30);
    }

    .card h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: -0.1px;
    }

    .sub{
      margin: 8px 0 0;
      color: rgba(255,255,255,.70);
      font-weight: 750;
      font-size: 13px;
      line-height: 1.5;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      width: fit-content;
      white-space: nowrap;
    }
    .pill .dot{ width: 9px; height: 9px; border-radius: 999px; background: rgba(255,255,255,.25); }
    .pill[data-state="sender"] .dot{ background: rgba(67,203,255,.95); }
    .pill[data-state="ready"] .dot{ background: rgba(96,255,157,.95); }
    .pill[data-state="sent"] .dot{ background: rgba(255,196,82,.95); }
    .pill[data-state="completed"] .dot{ background: rgba(96,255,157,.95); }

    .info{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }

    .info .row{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    .info .label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.60);
      margin-bottom: 6px;
    }

    .info .value{
      font-size: 13px;
      font-weight: 950;
      color: rgba(255,255,255,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .btn-lg{
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 950;
      width: 100%;
      justify-content:center;
    }

    .btn-muted{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
    }
    .btn-muted:hover{ background: rgba(255,255,255,.09); }

    /* Tools */
    .toolbox{
      display:grid;
      gap: 10px;
      margin-top: 12px;
    }

    .tool-btn{
      width:100%;
      justify-content:space-between;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .tool-btn:hover{ background: rgba(255,255,255,.09); }
    .tool-btn span{ opacity:.9; font-weight: 900; }

    /* Field editor */
    .editor{
      margin-top: 12px;
      display:none;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    .editor h3{
      margin:0 0 8px;
      font-size: 13px;
      font-weight: 950;
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-weight: 900;
      font-size: 13px;
      color: rgba(255,255,255,.86);
    }

    input, textarea{
      padding: 11px 11px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.95);
      outline:none;
      font-size: 14px;
      font-weight: 850;
    }

    input:focus, textarea:focus{
      border-color: rgba(67,203,255,.55);
      box-shadow: 0 0 0 4px rgba(67,203,255,.12);
    }

    .editor-actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .editor-actions .btn{ flex: 1 1 auto; justify-content:center; }

    /* Viewer */
    .viewer-card{
      padding: 0;
      overflow:hidden;
    }

    .viewer-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }

    .viewer-title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }

    .badge{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
    }

    .viewer-title strong{
      font-weight: 950;
      font-size: 13px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .viewer-tools{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .tool{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .tool:hover{ background: rgba(255,255,255,.09); }

    .viewer-body{
      position: relative;
      padding: 14px;
      background: radial-gradient(1000px 520px at 50% 0%, rgba(255,255,255,.08), transparent 65%);
    }

    /* Big viewer */
    #pdfFrame{
      width: 100%;
      height: min(82vh, 980px);
      border: 0;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }

    /* Overlay layer for draggable fields */
    #overlay{
      position:absolute;
      inset: 14px;
      border-radius: 18px;
      pointer-events: none;
    }

    .field{
      position:absolute;
      min-width: 140px;
      min-height: 38px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(67,203,255,.55);
      background: rgba(15,23,42,.80);
      color: rgba(255,255,255,.95);
      font-weight: 950;
      font-size: 14px;
      cursor: move;
      user-select:none;
      pointer-events: auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .field .type{
      opacity:.85;
      font-weight: 900;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    .field.signature .label{
      font-family: "Brush Script MT", "Segoe Script", "Snell Roundhand", cursive;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .field .label{
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 240px;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 850;
      font-size: 13px;
      color: rgba(255,255,255,.84);
      display:none;
    }
    .status.good{ border-color: rgba(96,255,157,.35); background: rgba(96,255,157,.10); }
    .status.warn{ border-color: rgba(255,196,82,.35); background: rgba(255,196,82,.10); }
    .status.bad{ border-color: rgba(255,79,99,.35); background: rgba(255,79,99,.10); }

    @media (max-width: 1020px){
      .layout{ grid-template-columns: 1fr; }
      #pdfFrame{ height: 72vh; }
    }
  </style>
</head>

<body class="app">
  <header class="app-top">
    <div class="app-top-inner">
      <a class="app-brand" href="dashboard.html">
        <span class="logo-badge">FSS</span>
        <div class="brand-text">
          <strong>Client Demo</strong>
          <span>Fill â†’ Sign â†’ Send</span>
        </div>
      </a>

      <div class="app-nav">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link" href="create.html">Create</a>
        <a class="nav-link active" href="sign.html">Sign</a>
        <a class="nav-link" href="success.html">Completed</a>
      </div>

      <div class="app-user">
        <span id="userEmail" class="user-pill">â€”</span>
        <button class="btn btn-outline" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1>Fill â†’ Sign â†’ Send</h1>
        <p>
          Drag fields onto the PDF, click a field to edit its value, then generate the signed PDF.
          This is a local demo (no external sending).
        </p>
      </div>

      <div class="pill" id="flowPill" data-state="sender">
        <span class="dot"></span>
        <span id="flowLabel">Sender signing</span>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <aside class="card">
        <h2>Envelope</h2>
        <p class="sub" id="flowText">â€”</p>

        <div class="divider"></div>

        <div class="info">
          <div class="row">
            <div class="label">Document</div>
            <div class="value" id="templateVal">â€”</div>
          </div>
          <div class="row">
            <div class="label">Sender</div>
            <div class="value" id="senderVal">â€”</div>
          </div>
          <div class="row">
            <div class="label">Recipient</div>
            <div class="value" id="recipientVal">â€”</div>
          </div>
        </div>

        <div class="divider"></div>

        <h2>Field Tools</h2>
        <p class="sub">Click a tool, then click / drag onto the PDF.</p>

        <div class="toolbox">
          <button class="tool-btn" id="toolSignature" type="button">
            <span>Signature</span> <span>+</span>
          </button>
          <button class="tool-btn" id="toolDate" type="button">
            <span>Date</span> <span>+</span>
          </button>
          <button class="tool-btn" id="toolText" type="button">
            <span>Text</span> <span>+</span>
          </button>
        </div>

        <div class="divider"></div>

        <div class="actions">
          <button class="btn btn-primary btn-lg" id="senderSignBtn" type="button">Generate Signed PDF</button>

          <button class="btn btn-primary btn-lg" id="sendBtn" type="button" style="display:none;">Send to Recipient</button>

          <button class="btn btn-primary btn-lg" id="recipientBtn" type="button" style="display:none;">Simulate Recipient Completion</button>

          <a class="btn btn-muted btn-lg" id="downloadBtn" href="#" style="display:none;">Download Signed PDF</a>
        </div>

        <div class="status warn" id="statusBox" style="display:none;"></div>

        <!-- Field editor -->
        <div class="editor" id="editor">
          <h3>Edit Field</h3>

          <label>
            Value
            <input id="fieldValue" type="text" placeholder="Enter value..." />
          </label>

          <div class="editor-actions">
            <button class="btn btn-outline" id="deleteFieldBtn" type="button">Delete</button>
            <button class="btn btn-primary" id="saveFieldBtn" type="button">Save</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            Tip: signatures look best if you type a name like <strong>Mason Palmieri</strong>.
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <section class="card viewer-card">
        <div class="viewer-head">
          <div class="viewer-title">
            <div class="badge">PDF</div>
            <strong id="pdfName">â€”</strong>
          </div>

          <div class="viewer-tools">
            <button class="tool" id="refreshBtn" type="button">Refresh</button>
            <button class="tool" id="clearFieldsBtn" type="button">Clear Fields</button>
          </div>
        </div>

        <div class="viewer-body" id="viewerBody">
          <iframe id="pdfFrame" title="PDF Preview"></iframe>
          <div id="overlay"></div>
        </div>
      </section>
    </div>
  </main>

  <script src="assets/app.js"></script>
  <script>
    // Auth guard
    FSS.guard();

    const user = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userEmail").textContent = user.email || "demo@client.com";

    // Ensure doc exists
    let doc = FSS.loadDocState();
    if(!doc){
      doc = FSS.resetDoc();
      FSS.logAudit("Envelope created.");
    }

    // UI refs
    const templateVal = document.getElementById("templateVal");
    const senderVal = document.getElementById("senderVal");
    const recipientVal = document.getElementById("recipientVal");

    const flowPill = document.getElementById("flowPill");
    const flowLabel = document.getElementById("flowLabel");
    const flowText = document.getElementById("flowText");

    const senderSignBtn = document.getElementById("senderSignBtn");
    const sendBtn = document.getElementById("sendBtn");
    const recipientBtn = document.getElementById("recipientBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    const statusBox = document.getElementById("statusBox");
    const pdfFrame = document.getElementById("pdfFrame");
    const pdfName = document.getElementById("pdfName");

    const overlay = document.getElementById("overlay");

    // Editor
    const editor = document.getElementById("editor");
    const fieldValue = document.getElementById("fieldValue");
    const saveFieldBtn = document.getElementById("saveFieldBtn");
    const deleteFieldBtn = document.getElementById("deleteFieldBtn");

    // Tools
    const toolSignature = document.getElementById("toolSignature");
    const toolDate = document.getElementById("toolDate");
    const toolText = document.getElementById("toolText");

    let currentTool = null;          // "signature" | "date" | "text"
    let selectedFieldId = null;      // field.id
    let dragState = null;            // {id, startX, startY, origX, origY}

    function showStatus(type, msg){
      statusBox.style.display = "";
      statusBox.className = "status " + type;
      statusBox.textContent = msg;
    }
    function clearStatus(){
      statusBox.style.display = "none";
      statusBox.textContent = "";
    }

    function setFlow(state){
      flowPill.setAttribute("data-state", state);

      if(state === "sender"){
        flowLabel.textContent = "Sender signing";
        flowText.innerHTML =
          `Step 1: Drag signature/date/text fields onto the PDF.<br><br>
           Then click <strong>Generate Signed PDF</strong> to stamp them into the PDF.`;
      }

      if(state === "ready"){
        flowLabel.textContent = "Ready to send";
        flowText.innerHTML =
          `Step 2: The signed PDF is generated.<br><br>
           Click <strong>Send to Recipient</strong> (simulated).`;
      }

      if(state === "sent"){
        flowLabel.textContent = "Recipient signing";
        flowText.innerHTML =
          `Step 3: Recipient completes signing (simulated).`;
      }

      if(state === "completed"){
        flowLabel.textContent = "Completed";
        flowText.innerHTML =
          `âœ… Agreement completed.<br><br>
           Download the signed PDF or view the completed screen.`;
      }
    }

    // Resolve doc label (template/upload/scratch)
    function getDocLabel(){
      doc = FSS.loadDocState() || doc;

      if(doc.builder && doc.builder.text){
        return (doc.builder.title || "Scratch Agreement");
      }

      const upName = localStorage.getItem("fss_uploaded_pdf_name");
      if(upName) return upName;

      return doc.template || "nda.pdf";
    }

    function getBasePDFURL(){
      doc = FSS.loadDocState() || doc;

      // If signed exists, we show signed in viewer for instant feedback
      if(FSS.hasSignedPDF()){
        const b64 = FSS.getSignedBase64();
        return FSS.base64ToBlobURL(b64);
      }

      // Uploaded
      if(localStorage.getItem("fss_uploaded_pdf_b64")){
        return FSS.base64ToBlobURL(localStorage.getItem("fss_uploaded_pdf_b64"));
      }

      // Template or builder uses template viewer (builder preview isn't needed because signing will build PDF)
      const template = doc.template || "nda.pdf";
      return `pdfs/${encodeURIComponent(template)}`;
    }

    async function loadPDF(){
      const name = getDocLabel();
      pdfName.textContent = name;

      const url = getBasePDFURL();
      pdfFrame.src = url;
    }

    // Field rendering
    function renderFields(){
      overlay.innerHTML = "";
      const fields = FSS.loadFields() || [];
      const values = FSS.loadValues() || {};

      fields.forEach(f=>{
        const el = document.createElement("div");
        el.className = `field ${f.type}`;
        el.dataset.id = f.id;

        const v = (values[f.id] != null ? values[f.id] :
                  (values[f.type] != null ? values[f.type] : ""));

        const labelText = v || (f.type === "signature" ? "Signature" : f.type === "date" ? "Date" : "Text");

        el.innerHTML = `
          <div class="label">${escapeHtml(labelText)}</div>
          <div class="type">${f.type}</div>
        `;

        // positions stored as overlay coords
        el.style.left = (f.x || 80) + "px";
        el.style.top = (f.y || 80) + "px";
        el.style.width = (f.w || (f.type === "signature" ? 200 : 160)) + "px";
        el.style.height = (f.h || 44) + "px";

        // Click selects field
        el.addEventListener("mousedown", (e)=>{
          e.stopPropagation();
          selectField(f.id);

          // start drag
          dragState = {
            id: f.id,
            startX: e.clientX,
            startY: e.clientY,
            origX: f.x || 80,
            origY: f.y || 80
          };

          window.addEventListener("mousemove", onDragMove);
          window.addEventListener("mouseup", onDragEnd);
        });

        overlay.appendChild(el);
      });

      // overlay should be interactive
      overlay.style.pointerEvents = "none";
      overlay.querySelectorAll(".field").forEach(x => x.style.pointerEvents = "auto");
    }

    function selectField(id){
      selectedFieldId = id;
      const fields = FSS.loadFields() || [];
      const values = FSS.loadValues() || {};

      const f = fields.find(x => x.id === id);
      if(!f){
        editor.style.display = "none";
        return;
      }

      const currentVal = (values[id] != null ? values[id] :
                          (values[f.type] != null ? values[f.type] : ""));

      fieldValue.value = currentVal || "";
      editor.style.display = "";
      fieldValue.focus();
    }

    function saveSelectedField(){
      if(!selectedFieldId) return;

      const fields = FSS.loadFields() || [];
      const values = FSS.loadValues() || {};

      const f = fields.find(x => x.id === selectedFieldId);
      if(!f) return;

      values[selectedFieldId] = fieldValue.value;
      FSS.saveValues(values);
      FSS.logAudit(`Field updated (${f.type}).`);

      renderFields();
      showStatus("good", "Field updated.");
      setTimeout(clearStatus, 900);
    }

    function deleteSelectedField(){
      if(!selectedFieldId) return;

      let fields = FSS.loadFields() || [];
      const f = fields.find(x => x.id === selectedFieldId);

      fields = fields.filter(x => x.id !== selectedFieldId);
      FSS.saveFields(fields);

      // also remove value
      const values = FSS.loadValues() || {};
      delete values[selectedFieldId];
      FSS.saveValues(values);

      FSS.logAudit(`Field deleted (${f?.type || "field"}).`);

      selectedFieldId = null;
      editor.style.display = "none";
      renderFields();
      showStatus("good", "Field removed.");
      setTimeout(clearStatus, 900);
    }

    saveFieldBtn.addEventListener("click", saveSelectedField);
    deleteFieldBtn.addEventListener("click", deleteSelectedField);

    // Drag handlers
    function onDragMove(e){
      if(!dragState) return;

      const dx = e.clientX - dragState.startX;
      const dy = e.clientY - dragState.startY;

      const fields = FSS.loadFields() || [];
      const idx = fields.findIndex(x => x.id === dragState.id);
      if(idx === -1) return;

      fields[idx].x = dragState.origX + dx;
      fields[idx].y = dragState.origY + dy;

      FSS.saveFields(fields);
      renderFields();
    }

    function onDragEnd(){
      if(!dragState) return;

      FSS.logAudit("Field moved.");
      dragState = null;

      window.removeEventListener("mousemove", onDragMove);
      window.removeEventListener("mouseup", onDragEnd);
    }

    // Tools
    function setTool(tool){
      currentTool = tool;
      showStatus("warn", `Tool selected: ${tool}. Click the PDF to place it, then drag into position.`);
    }

    toolSignature.addEventListener("click", ()=>setTool("signature"));
    toolDate.addEventListener("click", ()=>setTool("date"));
    toolText.addEventListener("click", ()=>setTool("text"));

    // Place field by clicking viewer container
    document.getElementById("viewerBody").addEventListener("click", (e)=>{
      if(!currentTool) return;

      // Place relative to overlay box
      const rect = overlay.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if(x < 0 || y < 0) return;

      const id = FSS.uid();
      const fields = FSS.loadFields() || [];
      const values = FSS.loadValues() || {};

      const base = {
        id,
        type: currentTool,
        page: 1,
        x: Math.max(0, x - 80),
        y: Math.max(0, y - 18),
        w: currentTool === "signature" ? 220 : 160,
        h: 44,
        required: false,
        role: "sender"
      };

      fields.push(base);
      FSS.saveFields(fields);

      // default values
      if(currentTool === "signature"){
        values[id] = doc.parties?.aName || "Sender";
      } else if(currentTool === "date"){
        values[id] = new Date().toLocaleDateString();
      } else {
        values[id] = "Enter text";
      }
      FSS.saveValues(values);

      FSS.logAudit(`Field placed (${currentTool}).`);
      currentTool = null;

      renderFields();
      selectField(id);

      showStatus("good", "Field placed. Drag it into position or edit the value.");
      setTimeout(clearStatus, 1100);
    });

    // Flow state refresh
    function refreshState(){
      doc = FSS.loadDocState() || doc;

      templateVal.textContent = getDocLabel();
      senderVal.textContent = doc.parties?.aName ? `${doc.parties.aName} (${doc.parties.aEmail || "â€”"})` : "Not set";
      recipientVal.textContent = doc.parties?.bName ? `${doc.parties.bName} (${doc.parties.bEmail || "â€”"})` : "Not set";

      const signed = FSS.hasSignedPDF();

      if(doc.status === "completed"){
        setFlow("completed");
        senderSignBtn.style.display = "none";
        sendBtn.style.display = "none";
        recipientBtn.style.display = "none";
        downloadBtn.style.display = signed ? "" : "none";
        return;
      }

      if(doc.status === "sent"){
        setFlow("sent");
        senderSignBtn.style.display = "none";
        sendBtn.style.display = "none";
        recipientBtn.style.display = "";
        downloadBtn.style.display = signed ? "" : "none";
        return;
      }

      if(signed){
        setFlow("ready");
        senderSignBtn.style.display = "";
        sendBtn.style.display = "";
        recipientBtn.style.display = "none";
        downloadBtn.style.display = "";
        return;
      }

      setFlow("sender");
      senderSignBtn.style.display = "";
      sendBtn.style.display = "none";
      recipientBtn.style.display = "none";
      downloadBtn.style.display = "none";
    }

    // Generate Signed PDF (real)
    senderSignBtn.addEventListener("click", async ()=>{
      clearStatus();
      doc = FSS.loadDocState() || doc;

      if(!doc.parties?.aName || !doc.parties?.bName){
        showStatus("warn", "Missing sender or recipient. Go to Create first.");
        return;
      }

      const fields = FSS.loadFields() || [];
      if(fields.length === 0){
        showStatus("warn", "Place at least one field (signature/date/text) before generating.");
        return;
      }

      try{
        showStatus("warn", "Generating signed PDFâ€¦");
        const ok = await FSS.generateSignedPDF();

        if(!ok){
          showStatus("bad", "Signed PDF generation failed. Check console.");
          return;
        }

        FSS.logAudit("Signed PDF generated.");
        showStatus("good", "âœ… Signed PDF generated and loaded in viewer.");
        refreshState();
        await loadPDF();
      }catch(err){
        console.error(err);
        showStatus("bad", "Signed PDF generation failed. Check console.");
      }
    });

    // Send (simulation)
    sendBtn.addEventListener("click", ()=>{
      clearStatus();
      doc = FSS.loadDocState() || doc;

      if(!FSS.hasSignedPDF()){
        showStatus("warn", "Generate the signed PDF first.");
        return;
      }

      doc.status = "sent";
      doc.sentAt = new Date().toISOString();
      FSS.saveDocState(doc);

      FSS.logAudit(`Agreement sent to ${doc.parties?.bEmail || "recipient"}.`);
      showStatus("good", "ðŸ“¨ Sent! Recipient completion enabled.");
      refreshState();
    });

    // Recipient completion simulation
    recipientBtn.addEventListener("click", ()=>{
      clearStatus();
      doc = FSS.loadDocState() || doc;

      doc.status = "completed";
      doc.completedAt = new Date().toISOString();
      FSS.saveDocState(doc);

      FSS.logAudit("Recipient completed signing.");
      showStatus("good", "âœ… Completed. Redirectingâ€¦");
      setTimeout(()=>location.href="success.html", 700);
    });

    // Download signed
    downloadBtn.addEventListener("click", (e)=>{
      e.preventDefault();

      const b64 = FSS.getSignedBase64();
      if(!b64){
        showStatus("warn", "No signed PDF available.");
        return;
      }

      const byteChars = atob(b64);
      const bytes = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) bytes[i] = byteChars.charCodeAt(i);

      const blob = new Blob([bytes], { type:"application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `FSS-${doc.id || "agreement"}-signed.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });

    // Tools
    document.getElementById("refreshBtn").addEventListener("click", async ()=>{
      await loadPDF();
      renderFields();
      refreshState();
      showStatus("good", "Viewer refreshed.");
      setTimeout(clearStatus, 900);
    });

    document.getElementById("clearFieldsBtn").addEventListener("click", ()=>{
      if(!confirm("Clear all placed fields?")) return;

      localStorage.setItem("fss_fields", JSON.stringify([]));
      localStorage.setItem("fss_values", JSON.stringify({}));
      FSS.logAudit("All fields cleared.");
      editor.style.display = "none";
      selectedFieldId = null;
      renderFields();
      showStatus("good", "All fields cleared.");
      setTimeout(clearStatus, 900);
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      FSS.logout();
      location.replace("index.html");
    });

    // Escape helper
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    // Boot
    (async function boot(){
      doc = FSS.loadDocState() || doc;
      refreshState();
      await loadPDF();
      renderFields();
      clearStatus();
    })();
  </script>
</body>
</html>