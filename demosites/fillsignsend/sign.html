<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSS ‚Äî Sign</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>

<body class="app light">
  <header class="topbar">
    <div class="brand">
      <div class="logo">FSS</div>
      <div>
        <div class="title">Signing Room</div>
        <div class="sub" id="roleLine">Sign your document</div>
      </div>
    </div>

    <nav class="navlinks">
      <a href="dashboard.html">Dashboard</a>
      <a href="create.html">Create</a>
      <a href="sign.html?role=sender" id="senderNav">Sender Sign</a>
      <a href="sign.html?role=recipient" id="recipientNav">Recipient Sign</a>
      <a href="../../demos.html" id="logoutBtn">Logout</a>
    </nav>
  </header>

  <main class="page">
    <div class="shell">
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2 style="margin:0;" id="docTitle">Template: ‚Äî</h2>
            <p class="muted" style="margin:6px 0 0;" id="docSub">
              Click a field type, then click the document to place it.
            </p>
          </div>

          <div class="actions">
            <button class="btn secondary" id="clearBtn" type="button">Clear Fields</button>
            <button class="btn primary" id="completeBtn" type="button">Complete Signing</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="signGrid">
          <!-- LEFT -->
          <aside class="signSide">
            <div class="sideCard">
              <div class="sideTitle">Fields</div>
              <div class="fieldRow">
                <button class="chip active" data-type="signature">‚úçÔ∏è Signature</button>
                <button class="chip" data-type="initials">ID Initials</button>
                <button class="chip" data-type="text">abc Text</button>
                <button class="chip" data-type="date">üìÖ Date</button>
                <button class="chip" data-type="checkbox">‚òë Checkbox</button>
              </div>

              <div class="divider" style="margin:14px 0;"></div>

              <div class="sideTitle">Envelope</div>
              <div class="tiny muted" id="partyInfo">Loading‚Ä¶</div>

              <div class="divider" style="margin:14px 0;"></div>

              <div class="sideTitle">Required fields</div>
              <p class="tiny muted" style="margin:10px 0 0;">
                Demo requires at least: <b>Signature</b> + <b>Date</b>.
                Any placed field marked ‚ÄúRequired‚Äù must be completed.
              </p>

              <button class="btn secondary" id="downloadDraftBtn" type="button" style="margin-top:14px; width:100%;">
                Download Draft PDF
              </button>
            </div>

            <div class="tiny muted" style="margin-top:10px;">
              Tip: If the PDF looks too small, zoom in using your browser (Ctrl/Cmd +).
            </div>
          </aside>

          <!-- RIGHT -->
          <div class="signDocWrap">
            <div class="docTop">
              <div class="docBadge">
                <span class="pdfDot">PDF</span>
                <span id="templateLabel">‚Äî</span>
              </div>

              <div class="docControls">
                <span class="tiny muted" id="zoomLabel">Zoom: 100%</span>
                <button class="miniBtn" id="zoomOut" type="button">‚àí</button>
                <button class="miniBtn" id="zoomIn" type="button">+</button>
              </div>
            </div>

            <div class="docFrame" id="docFrame">
              <iframe id="pdfFrame" title="PDF Preview"></iframe>
              <div class="overlay" id="overlay"></div>
            </div>

            <div class="tiny" id="statusLine" style="margin-top:10px; color:#16a34a; font-weight:950;">
              Ready.
            </div>

            <div class="tiny muted" style="margin-top:6px;">
              Clicking placed fields lets you fill them. Drag to reposition. Click ‚ùå to remove.
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- pdf-lib CDN -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="assets/app.js"></script>

  <script>
    FSS.guard();

    // ====== ROLE + DOC STATE ======
    const params = new URLSearchParams(location.search);
    const role = (params.get("role") || "sender").toLowerCase();
    const roleLine = document.getElementById("roleLine");
    const senderNav = document.getElementById("senderNav");
    const recipientNav = document.getElementById("recipientNav");

    senderNav.classList.toggle("active", role === "sender");
    recipientNav.classList.toggle("active", role === "recipient");

    roleLine.textContent = role === "sender"
      ? "Sender signing ‚Äî Party A signs first"
      : "Recipient signing ‚Äî Party B signs after send";

    const doc = FSS.loadDocState();
    if (!doc || !doc.template) {
      alert("No active envelope found. Please create an agreement first.");
      location.href = "create.html";
    }

    // ====== ELEMENTS ======
    const overlay = document.getElementById("overlay");
    const pdfFrame = document.getElementById("pdfFrame");
    const docTitle = document.getElementById("docTitle");
    const templateLabel = document.getElementById("templateLabel");
    const partyInfo = document.getElementById("partyInfo");
    const statusLine = document.getElementById("statusLine");
    const clearBtn = document.getElementById("clearBtn");
    const completeBtn = document.getElementById("completeBtn");
    const downloadDraftBtn = document.getElementById("downloadDraftBtn");

    // ====== SETUP PDF PREVIEW ======
    docTitle.textContent = `Template: ${doc.template}`;
    templateLabel.textContent = doc.template;

    // Show PDF (real file)
    pdfFrame.src = `pdfs/${doc.template}`;

    // Parties
    const p = doc.parties || {};
    partyInfo.innerHTML = `
      <div><b>Sender:</b> ${FSS.escape(p.aName || "‚Äî")} (${FSS.escape(p.aEmail || "‚Äî")})</div>
      <div style="margin-top:6px;"><b>Recipient:</b> ${FSS.escape(p.bName || "‚Äî")} (${FSS.escape(p.bEmail || "‚Äî")})</div>
      <div style="margin-top:10px;" class="muted tiny"><b>Status:</b> ${FSS.escape(doc.status || "draft")}</div>
    `;

    // ====== FIELD PLACEMENT / EDITING ======
    let activeType = "signature";
    let zoom = 1;

    const chips = document.querySelectorAll(".chip");
    chips.forEach(ch => {
      ch.addEventListener("click", () => {
        chips.forEach(x => x.classList.remove("active"));
        ch.classList.add("active");
        activeType = ch.dataset.type;
        statusLine.textContent = `${activeType.toUpperCase()} selected ‚Äî click the document to place it.`;
      });
    });

    function renderFields(){
      overlay.innerHTML = "";

      const fields = FSS.loadFields();
      fields.forEach((f, idx) => {
        const el = document.createElement("div");
        el.className = "field";
        el.dataset.index = idx;

        el.style.left = `${f.x}px`;
        el.style.top = `${f.y}px`;
        el.style.width = `${f.w}px`;
        el.style.height = `${f.h}px`;

        el.innerHTML = `
          <div class="fieldTag">${f.type.toUpperCase()}</div>
          <div class="fieldVal">${FSS.escape(f.value || "")}</div>
          <button class="fieldX" title="Remove">‚úï</button>
        `;

        // remove
        el.querySelector(".fieldX").addEventListener("click", (e) => {
          e.stopPropagation();
          const fields2 = FSS.loadFields();
          fields2.splice(idx, 1);
          FSS.saveFields(fields2);
          renderFields();
        });

        // edit
        el.addEventListener("click", () => {
          const val = prompt(`Enter value for ${f.type}:`, f.value || "");
          if(val === null) return;

          const fields2 = FSS.loadFields();
          fields2[idx].value = val;
          FSS.saveFields(fields2);
          renderFields();
        });

        // drag
        let drag = false;
        let startX, startY;

        el.addEventListener("mousedown", (e) => {
          if(e.target.classList.contains("fieldX")) return;
          drag = true;
          startX = e.clientX - f.x;
          startY = e.clientY - f.y;
          el.classList.add("dragging");
        });

        window.addEventListener("mousemove", (e) => {
          if(!drag) return;
          const nx = e.clientX - startX;
          const ny = e.clientY - startY;

          el.style.left = `${nx}px`;
          el.style.top = `${ny}px`;
        });

        window.addEventListener("mouseup", () => {
          if(!drag) return;
          drag = false;
          el.classList.remove("dragging");

          const newX = parseFloat(el.style.left);
          const newY = parseFloat(el.style.top);

          const fields2 = FSS.loadFields();
          fields2[idx].x = newX;
          fields2[idx].y = newY;
          FSS.saveFields(fields2);
        });

        overlay.appendChild(el);
      });
    }

    // Place on click
    overlay.addEventListener("click", (e) => {
      // don't place if clicking a field
      if(e.target.closest(".field")) return;

      const rect = overlay.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const field = {
        type: activeType,
        page: 1,
        x: Math.max(0, x - 90),
        y: Math.max(0, y - 18),
        w: activeType === "signature" ? 240 : 180,
        h: 44,
        value: ""
      };

      const fields = FSS.loadFields();
      fields.push(field);
      FSS.saveFields(fields);
      renderFields();
    });

    // Clear
    clearBtn.addEventListener("click", () => {
      const ok = confirm("Clear all placed fields?");
      if(!ok) return;
      FSS.saveFields([]);
      renderFields();
      statusLine.textContent = "Fields cleared.";
    });

    // Zoom controls (just scales the doc frame)
    function applyZoom(){
      const frame = document.getElementById("docFrame");
      frame.style.transform = `scale(${zoom})`;
      frame.style.transformOrigin = "top center";
      document.getElementById("zoomLabel").textContent = `Zoom: ${Math.round(zoom * 100)}%`;
    }

    document.getElementById("zoomIn").addEventListener("click", () => {
      zoom = Math.min(1.6, zoom + 0.1);
      applyZoom();
    });
    document.getElementById("zoomOut").addEventListener("click", () => {
      zoom = Math.max(0.8, zoom - 0.1);
      applyZoom();
    });
    applyZoom();

    // Draft download = template only (no edits)
    downloadDraftBtn.addEventListener("click", async () => {
      const url = `pdfs/${doc.template}`;
      window.open(url, "_blank");
    });

    // COMPLETE SIGNING: validate + generate signed PDF + go success
    completeBtn.addEventListener("click", async () => {
      const fields = FSS.loadFields();

      const hasSig = fields.some(f => f.type === "signature" && (f.value || "").trim());
      const hasDate = fields.some(f => f.type === "date" && (f.value || "").trim());

      if(!hasSig || !hasDate){
        alert("This demo requires at least:\n‚Ä¢ Signature field filled\n‚Ä¢ Date field filled");
        return;
      }

      statusLine.style.color = "#1e40af";
      statusLine.textContent = "Generating signed PDF‚Ä¶";

      const ok = await FSS.generateSignedPDF(); // uses pdf-lib
      if(!ok){
        statusLine.style.color = "#b91c1c";
        statusLine.textContent = "Error generating signed PDF.";
        return;
      }

      // update stage and audit
      if(role === "sender"){
        FSS.setDocStage("recipient");   // next is recipient
        FSS.setDocStatus("sent");       // mimic sending
        FSS.logAudit("Sender signed and sent document.");
      } else {
        FSS.setDocStatus("completed");
        FSS.logAudit("Recipient signed. Envelope completed.");
      }

      statusLine.style.color = "#16a34a";
      statusLine.textContent = "Signed PDF created successfully. Redirecting‚Ä¶";

      setTimeout(() => {
        location.href = "success.html";
      }, 700);
    });

    // Initial render
    renderFields();

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
    });
  </script>

  <!-- Page layout styles -->
  <style>
    .signGrid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }
    .signSide{
      position: sticky;
      top: 88px;
    }
    .sideCard{
      border: 1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      box-shadow: 0 12px 28px rgba(15,23,42,.06);
      padding: 14px;
    }
    .sideTitle{
      font-weight: 1000;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .fieldRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .chip{
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
    }
    .chip.active{
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .docTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .docBadge{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 950;
    }
    .pdfDot{
      background:#111827;
      color:#fff;
      font-size: 11px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .docControls{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .miniBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight: 1000;
    }
    .miniBtn:hover{ background:#f8fafc; }

    .docFrame{
      position: relative;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid var(--border);
      background:#fff;
      box-shadow: 0 18px 40px rgba(15,23,42,.08);
      width: 800px;
      margin: 0 auto;
    }
    iframe{
      width: 100%;
      height: 980px;
      border: 0;
      background:#fff;
    }
    .overlay{
      position:absolute;
      inset: 0;
      cursor: crosshair;
    }

    .field{
      position:absolute;
      border-radius: 12px;
      border: 2px solid rgba(59,130,246,.45);
      background: rgba(255,255,255,.9);
      box-shadow: 0 12px 26px rgba(15,23,42,.12);
      padding: 8px 10px;
      cursor: pointer;
      user-select:none;
    }
    .field.dragging{ opacity:.85; }
    .fieldTag{
      font-size: 10px;
      font-weight: 1000;
      color: #1e3a8a;
    }
    .fieldVal{
      font-size: 12px;
      font-weight: 950;
      margin-top: 3px;
      color: #0f172a;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .fieldX{
      position:absolute;
      top: -10px;
      right: -10px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.6);
      background:#fff;
      cursor:pointer;
      font-weight: 1000;
    }
    .fieldX:hover{ background:#f8fafc; }

    @media(max-width: 980px){
      .signGrid{ grid-template-columns: 1fr; }
      .signSide{ position: static; }
      .docFrame{ width: 100%; }
      iframe{ height: 720px; }
    }
  </style>

</body>
</html>
