<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSS — eSignature</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>

<body>
  <header>
    <div class="container nav">
      <a class="brand" href="dashboard.html">
        <div class="brand-badge">FSS</div>
        <div>
          <strong>FSS</strong>
          <span>eSignature</span>
        </div>
      </a>

      <div class="navlinks">
        <a href="dashboard.html">Dashboard</a>
        <a href="create.html">Create</a>
        <a href="sign.html">eSign</a>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div class="topbar">
        <div>
          <h2 style="margin:0;">Review & Sign</h2>
          <div class="small">DocuSign-like signing experience (demo)</div>
        </div>
        <a class="btn btn-outline" href="dashboard.html">Back</a>
      </div>

      <div class="sign-wrap" style="margin-top:14px;">
        <div class="doc">
          <div class="topbar">
            <div>
              <div class="badge" id="docType">NDA</div>
              <h3 id="docTitle" style="margin-top:10px;">Document</h3>
              <p id="docMeta"></p>
            </div>
            <span class="badge">Signature Required</span>
          </div>

          <hr />

          <p id="docBody" style="white-space:pre-wrap;"></p>

          <hr />

          <div class="signature">
            <div style="font-weight:950; margin-bottom:8px;">Draw Signature</div>
            <canvas id="sig"></canvas>

            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;">
              <button class="btn btn-outline" id="clearBtn" type="button">Clear</button>
              <button class="btn btn-primary" id="completeBtn" type="button">Complete Signing</button>
            </div>

            <p id="msg" class="small" style="margin-top:10px; display:none; color:#fca5a5;">
              Please draw a signature first.
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { requireAuth, getAgreements, updateAgreement } from "./assets/app.js";

    requireAuth();

    // Load most recent agreement
    const list = getAgreements();
    const doc = list[0];

    const docTitle = document.getElementById("docTitle");
    const docType = document.getElementById("docType");
    const docMeta = document.getElementById("docMeta");
    const docBody = document.getElementById("docBody");
    const msg = document.getElementById("msg");

    if(!doc){
      docTitle.textContent = "No document found.";
      docBody.textContent = "Go back and create a document first.";
    }else{
      docTitle.textContent = doc.title;
      docType.textContent = doc.type;

      docMeta.textContent =
        `From: ${doc.partyA.company || "Party A"} • To: ${doc.partyB.company || "Party B"} • Mode: ${doc.mode}`;

      docBody.textContent =
`This ${doc.type} (“Agreement”) is entered into by and between:

Party A: ${doc.partyA.company || "Party A"} (${doc.partyA.email || "—"})
Party B: ${doc.partyB.company || "Party B"} (${doc.partyB.email || "—"})

1. Confidential Information.
The Parties may exchange confidential information for business purposes.

2. Use & Disclosure.
The Receiving Party agrees not to disclose Confidential Information except as permitted.

3. Term.
This Agreement remains in effect for 2 years unless terminated earlier.

4. No License.
No rights are granted except as expressly stated.

5. Entire Agreement.
This Agreement contains the entire understanding of the Parties.

Notes:
${doc.notes || "—"}

By signing below, Party B agrees to the terms.`;
    }

    // Signature pad
    const canvas = document.getElementById("sig");
    const ctx = canvas.getContext("2d");

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const scale = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * scale);
      canvas.height = Math.floor(rect.height * scale);
      ctx.setTransform(scale, 0, 0, scale, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "rgba(255,255,255,.92)";
    }
    window.addEventListener("resize", resize);
    resize();

    let drawing = false;
    let hasInk = false;

    function pos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      return {x, y};
    }

    function start(e){
      drawing = true;
      hasInk = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      e.preventDefault();
    }

    function move(e){
      if(!drawing) return;
      const p = pos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      e.preventDefault();
    }

    function end(){
      drawing = false;
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", end);

    document.getElementById("clearBtn").addEventListener("click", () => {
      resize();
      hasInk = false;
      msg.style.display = "none";
    });

    document.getElementById("completeBtn").addEventListener("click", () => {
      if(!doc) return;

      msg.style.display = "none";
      if(!hasInk){
        msg.style.display = "";
        return;
      }

      // Persist signature (demo)
      const dataUrl = canvas.toDataURL("image/png");
      doc.signatureDataUrl = dataUrl;
      doc.status = "Completed (Signed)";
      updateAgreement(doc);

      window.location.href = "success.html";
    });
  </script>
</body>
</html>
