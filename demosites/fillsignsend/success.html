<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Demo • Completed</title>

  <link rel="stylesheet" href="assets/app.css" />

  <style>
    .page { padding: 18px 18px 34px; max-width: 1400px; margin: 0 auto; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      color: rgba(255,255,255,.92);
      font-weight: 950;
    }
    .brand .badge{
      width: 36px; height: 36px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
    }
    .brand .meta{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .brand .meta small{ color: rgba(255,255,255,.70); font-weight: 850; }

    .navlinks{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .navlinks a{
      text-decoration:none; color: rgba(255,255,255,.80);
      font-weight: 900; padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05);
    }
    .navlinks a.active{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: rgba(255,255,255,.95);
    }

    .rightmeta{ display:flex; align-items:center; gap:10px; }
    .pill{
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
      font-weight: 900; font-size: 13px;
    }
    .toolbtn{
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950; cursor:pointer; user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }

    .card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 26px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding: 14px 14px 10px;
      font-size: 16px; font-weight: 950;
      color: rgba(255,255,255,.92);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .card .body{ padding: 12px 14px 14px; color: rgba(255,255,255,.88); }

    .muted{ color: rgba(255,255,255,.70); font-weight: 850; font-size: 13px; line-height: 1.5; }

    .kv{
      margin-top:10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      font-weight: 900;
      color: rgba(255,255,255,.90);
      font-size: 13px;
    }
    .kv small{
      display:block;
      color: rgba(255,255,255,.65);
      font-weight: 850;
      margin-bottom:6px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 11px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950; cursor:pointer;
      text-decoration:none;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(67,203,255,.95), rgba(96,255,157,.85));
      color: rgba(5,12,18,.95);
    }
    .btn.danger{
      background: rgba(255,79,99,.12);
      border-color: rgba(255,79,99,.30);
    }

    /* Viewer */
    .viewerHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .viewerHead .title{
      display:flex; align-items:center; gap:10px;
      color: rgba(255,255,255,.92);
      font-weight: 950;
      min-width:0;
    }
    .viewerHead .title .tag{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 950;
    }
    .tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .viewerWrap{ padding: 12px; }
    .viewerFrame{
      height: calc(100vh - 220px);
      min-height: 620px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:auto;
      position: relative;
    }
    canvas{
      display:block;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
    }

    .statusLine{
      padding: 10px 14px 14px;
      color: rgba(255,255,255,.72);
      font-weight: 850;
      font-size: 13px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .viewerFrame{ height: 62vh; min-height: 420px; }
    }
  </style>
</head>

<body class="app">
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="badge">FSS</div>
        <div class="meta">
          <div>Client Demo</div>
          <small>Fill → Sign → Send</small>
        </div>
      </div>

      <div class="navlinks">
        <a href="dashboard.html">Dashboard</a>
        <a href="create.html">Create</a>
        <a href="sign.html">Sign</a>
        <a class="active" href="success.html">Completed</a>
      </div>

      <div class="rightmeta">
        <div class="pill" id="userPill">demo@client.com</div>
        <button class="toolbtn" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Completed</h2>
        <div class="body">
          <div class="muted">
            This page shows your signed PDF and provides a download/open button.
          </div>

          <div class="kv">
            <small>Agreement</small>
            <div id="kvAgreement">—</div>
          </div>

          <div class="kv">
            <small>Sender</small>
            <div id="kvSender">—</div>
          </div>

          <div class="kv">
            <small>Recipient</small>
            <div id="kvRecipient">—</div>
          </div>

          <div class="kv">
            <small>Status</small>
            <div id="kvStatus">—</div>
          </div>

          <div class="row">
            <button class="btn primary" id="downloadBtn" type="button">Download Signed PDF</button>
            <button class="btn" id="openBtn" type="button">Open in New Tab</button>
          </div>

          <div class="row">
            <a class="btn" href="sign.html">Back to Sign</a>
            <a class="btn" href="create.html">Back to Create</a>
          </div>

          <div class="row">
            <button class="btn danger" id="newBtn" type="button">Start New Agreement</button>
          </div>

          <div class="statusLine" id="leftStatus"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="viewerHead">
          <div class="title">
            <span class="tag">Signed PDF</span>
            <span id="pdfName">—</span>
          </div>
          <div class="tools">
            <button class="toolbtn" id="fitBtn" type="button">Fit</button>
            <button class="toolbtn" id="zoomOutBtn" type="button">–</button>
            <button class="toolbtn" id="zoomInBtn" type="button">+</button>
            <button class="toolbtn" id="refreshBtn" type="button">Refresh</button>
          </div>
        </div>

        <div class="viewerWrap">
          <div class="viewerFrame" id="viewerFrame">
            <canvas id="pdfCanvas"></canvas>
          </div>
        </div>

        <div class="statusLine" id="rightStatus">Loading…</div>
      </div>
    </div>
  </div>

  <script src="assets/app.js"></script>

  <script type="module">
    import * as pdfjsLib from "./pdfjs/build/pdf.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdfjs/build/pdf.worker.mjs";

    FSS.guard();

    const auth = JSON.parse(localStorage.getItem("fss_auth") || "{}");
    document.getElementById("userPill").textContent = auth.email || "demo@client.com";
    document.getElementById("logoutBtn").addEventListener("click", () => {
      FSS.logout();
      location.href = "index.html";
    });

    const leftStatus = document.getElementById("leftStatus");
    const rightStatus = document.getElementById("rightStatus");
    const pdfName = document.getElementById("pdfName");

    const kvAgreement = document.getElementById("kvAgreement");
    const kvSender = document.getElementById("kvSender");
    const kvRecipient = document.getElementById("kvRecipient");
    const kvStatus = document.getElementById("kvStatus");

    const viewerFrame = document.getElementById("viewerFrame");
    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");

    const downloadBtn = document.getElementById("downloadBtn");
    const openBtn = document.getElementById("openBtn");
    const newBtn = document.getElementById("newBtn");

    const fitBtn = document.getElementById("fitBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.0;

    function setLeft(msg){ leftStatus.textContent = msg || ""; }
    function setRight(msg){ rightStatus.textContent = msg || ""; }

    function base64ToBytes(b64){
      const byteChars = atob(b64);
      const bytes = new Uint8Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
      return bytes;
    }

    function hydrateHeader(){
      const d = FSS.loadDocState() || {};
      const parties = d.parties || {};
      kvAgreement.textContent = d.template || d.builder?.title || "Agreement";
      kvSender.textContent = parties.aName ? `${parties.aName} (${parties.aEmail || ""})` : "—";
      kvRecipient.textContent = parties.bName ? `${parties.bName} (${parties.bEmail || ""})` : "—";

      kvStatus.textContent = FSS.hasSignedPDF()
        ? "Signed PDF generated ✅"
        : "No signed PDF found. Go to Sign.";
    }

    async function loadSignedPdf(){
      hydrateHeader();

      const signedB64 = FSS.getSignedBase64();
      if (!signedB64){
        pdfName.textContent = "No Signed PDF";
        setLeft("No signed PDF found. Go to Sign and click “Sign as Sender”.");
        setRight("No signed PDF.");
        downloadBtn.disabled = true;
        openBtn.disabled = true;
        return;
      }

      downloadBtn.disabled = false;
      openBtn.disabled = false;

      const bytes = base64ToBytes(signedB64);
      pdfName.textContent = "signed.pdf";

      pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
      pageNum = 1;
      scale = 1.0;
      await renderPage(true);

      setLeft("");
    }

    async function renderPage(forceFit=false){
      if (!pdfDoc) return;

      const page = await pdfDoc.getPage(pageNum);
      const unscaled = page.getViewport({ scale: 1.0 });
      const maxW = viewerFrame.clientWidth - 24;
      const fitScale = Math.max(0.2, Math.min(3.0, maxW / unscaled.width));

      if (forceFit || !scale || scale === 1.0) scale = fitScale;

      const viewport = page.getViewport({ scale });

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      setRight(`Rendering… (zoom ${Math.round(scale*100)}%)`);
      await page.render({ canvasContext: ctx, viewport }).promise;
      setRight(`Ready (zoom ${Math.round(scale*100)}%).`);
    }

    function openSigned(){
      const signedB64 = FSS.getSignedBase64();
      if (!signedB64) return;
      const blobUrl = FSS.base64ToBlobURL(signedB64, "application/pdf");
      window.open(blobUrl, "_blank");
    }

    function downloadSigned(){
      const signedB64 = FSS.getSignedBase64();
      if (!signedB64) return;

      const bytes = base64ToBytes(signedB64);
      const blob = new Blob([bytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "signed.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    downloadBtn.addEventListener("click", downloadSigned);
    openBtn.addEventListener("click", openSigned);

    fitBtn.addEventListener("click", () => renderPage(true));
    zoomInBtn.addEventListener("click", () => { scale = Math.min(3.0, (scale||1)*1.12); renderPage(false); });
    zoomOutBtn.addEventListener("click", () => { scale = Math.max(0.2, (scale||1)/1.12); renderPage(false); });
    refreshBtn.addEventListener("click", loadSignedPdf);

    newBtn.addEventListener("click", () => {
      if (!confirm("Start a new agreement? This clears doc, fields, values, uploads, and signed PDF (keeps login).")) return;

      FSS.resetDoc();
      localStorage.removeItem("fss_uploaded_pdf_b64");
      localStorage.removeItem("fss_uploaded_pdf_name");
      localStorage.removeItem("fss_signed_pdf_b64");

      FSS.logAudit("Started a new agreement (reset doc + signed).");
      location.href = "create.html";
    });

    // Init
    loadSignedPdf();
  </script>
</body>
</html>