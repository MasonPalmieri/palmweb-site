<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charity Tournament ‚Äî Live Leaderboard</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Captain-submitted scoring with shotgun starts and a live leaderboard. Mobile-first and simple." />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#556173;
      --hair: rgba(15,23,42,.08);
      --border: rgba(15,23,42,.12);
      --panel: rgba(255,255,255,.80);
      --blue:#1d79c6;
      --green:#2cab4b;
      --danger:#dc2626;
      --warn:#f59e0b;
      --shadow2: 0 10px 30px rgba(15,23,42,.08);
      --radius: 20px;
      --max: 860px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(29,121,198,.14), transparent 60%),
        radial-gradient(1200px 520px at 90% 0%, rgba(44,171,75,.10), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.03), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    a{ color:inherit; text-decoration:none; }
    .container{ max-width: var(--max); margin:0 auto; padding: 0 16px; }

    header{
      position: sticky; top: 0; z-index: 50;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--hair);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; padding: 12px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width: 36px; height: 36px;
      border-radius: 14px;
      border: 1px solid var(--hair);
      background:
        radial-gradient(14px 14px at 30% 35%, rgba(29,121,198,.26), transparent 70%),
        radial-gradient(14px 14px at 68% 58%, rgba(44,171,75,.22), transparent 70%),
        rgba(15,23,42,.02);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
    }
    .brand-title{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .brand-title strong{ font-weight: 950; font-size: 13.5px; letter-spacing: .1px; }
    .brand-title span{
      font-weight: 800; font-size: 12px; color: var(--muted);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 380px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      white-space: nowrap;
      font-size: 13px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--green));
      box-shadow: 0 18px 44px rgba(29,121,198,.18);
    }
    .btn-danger{
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.30);
      color: rgba(127,29,29,.95);
    }
    .btn-warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.35);
      color: rgba(120,53,15,.95);
    }

    main{ padding: 16px 0 32px; }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position: relative;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 240px at 12% 16%, rgba(29,121,198,.08), transparent 70%),
        radial-gradient(420px 240px at 98% 0%, rgba(44,171,75,.06), transparent 70%);
      pointer-events:none;
    }
    .panel > *{ position: relative; }

    .kicker{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 900;
      color: rgba(11,18,32,.86);
      width: fit-content;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: linear-gradient(135deg, var(--blue), var(--green));
    }

    h1{
      margin: 10px 0 6px;
      font-size: 24px;
      letter-spacing: -0.6px;
      line-height: 1.05;
      font-weight: 950;
    }
    .lead{
      margin: 0;
      color: rgba(11,18,32,.70);
      font-weight: 850;
      font-size: 13.5px;
      line-height: 1.45;
    }

    .screen{ display:none; }
    .screen.show{ display:block; }

    .stack{ display:flex; flex-direction:column; gap: 10px; }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .row.stretch > *{ flex: 1 1 180px; }

    .field{ display:flex; flex-direction:column; gap: 6px; }
    .label{ font-weight: 950; font-size: 12px; color: rgba(11,18,32,.82); }
    .hint{ font-weight: 800; font-size: 12px; color: rgba(11,18,32,.60); margin-top: -2px; }
    .input, .select{
      width:100%;
      padding: 13px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      color: rgba(11,18,32,.92);
      outline:none;
      font-weight: 900;
      font-size: 15px;
    }
    .input:focus, .select:focus{
      border-color: rgba(29,121,198,.55);
      box-shadow: 0 0 0 4px rgba(29,121,198,.10);
    }

    .hr{ height:1px; background: rgba(15,23,42,.08); margin: 6px 0; }

    .card{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.80);
      border-radius: 16px;
      padding: 12px;
    }

    .big-num{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: -1px;
      line-height: 1;
      margin: 4px 0 0;
    }
    .sub{
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Leaderboard */
    .lb{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .lb-item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 12px;
    }
    .lb-left{ min-width:0; }
    .lb-team{
      font-weight: 950;
      letter-spacing: -0.2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 52vw;
    }
    .lb-meta{
      margin-top: 4px;
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,18,32,.78);
    }
    .scorebox{
      text-align:right;
      flex: 0 0 auto;
    }
    .scorebox .score{
      font-weight: 950;
      font-size: 26px;
      letter-spacing: -0.4px;
      line-height: 1.05;
    }
    .scorebox .small{
      font-weight: 850;
      color: rgba(11,18,32,.60);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(640px, calc(100% - 24px));
      z-index: 2000;
      display:none;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 55px rgba(15,23,42,.18);
      color: rgba(11,18,32,.90);
      font-weight: 900;
      font-size: 13px;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
<header>
  <div class="container nav">
    <a class="brand" href="../../demos.html" aria-label="Back to Demos">
      <div class="badge">üèÜ</div>
      <div class="brand-title">
        <strong>Charity Tournament</strong>
        <span>Captain scoring + live leaderboard</span>
      </div>
    </a>
    <div class="row">
      <button class="btn" id="btnHome" type="button">Home</button>
      <button class="btn btn-warn" id="btnResetLocal" type="button" title="Clears local device cache only">Reset</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="panel">
    <!-- HOME -->
    <div class="screen show" id="screen-home">
      <div class="kicker"><span class="dot"></span> Mobile-first ‚Ä¢ One thing per screen</div>
      <h1>Live Tournament Scoring</h1>
      <p class="lead">
        One captain per team submits hole-by-hole scores. Everyone can open the leaderboard and watch it update.
      </p>

      <div class="hr"></div>

      <div class="stack">
        <button class="btn btn-primary" id="goCreate" type="button">Create Tournament</button>
        <button class="btn" id="goCaptain" type="button">Captain: Enter Scores</button>
        <button class="btn" id="goLeaderboard" type="button">View Leaderboard</button>

        <div class="card">
          <div class="label">Real-time mode</div>
          <div class="hint" id="rtStatus">Checking‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- CREATE -->
    <div class="screen" id="screen-create">
      <div class="kicker"><span class="dot"></span> Setup tournament</div>
      <h1>Create Tournament</h1>
      <p class="lead">Make a tournament code, add teams, set shotgun starts, and assign captain PINs.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament name</div>
          <input class="input" id="c_name" placeholder="e.g., Rotary Charity Scramble" />
        </div>

        <div class="row stretch">
          <div class="field">
            <div class="label">Holes</div>
            <select class="select" id="c_holes">
              <option value="9">9</option>
              <option value="18" selected>18</option>
            </select>
          </div>

          <div class="field">
            <div class="label">Shotgun start?</div>
            <select class="select" id="c_shotgun">
              <option value="yes" selected>Yes</option>
              <option value="no">No (starts on hole 1)</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="label">Optional: course par (comma-separated)</div>
          <input class="input" id="c_par" placeholder="18 numbers (optional). Example: 4,4,3,5,..." />
          <div class="hint">If you include par, leaderboard can show ‚Äúto par‚Äù. Leave blank if not needed.</div>
        </div>

        <div class="card">
          <div class="label">Tournament code</div>
          <div class="hint">Share this code with captains and participants.</div>
          <div class="big-num" id="c_code">‚Äî</div>
          <div class="row">
            <button class="btn" id="c_regen" type="button">Regenerate</button>
            <button class="btn" id="c_copycode" type="button">Copy code</button>
          </div>
        </div>

        <div class="card">
          <div class="label">Teams (2‚Äì36 typical)</div>
          <div class="hint">Each team needs: Team name, Starting hole, Captain PIN (4‚Äì8 digits).</div>
          <div class="stack" id="c_teams"></div>
          <div class="row">
            <button class="btn" id="c_addteam" type="button">Add Team</button>
            <button class="btn btn-primary" id="c_publish" type="button">Publish Tournament</button>
          </div>
          <div class="hint" id="c_publishHint"></div>
        </div>

        <div class="row">
          <button class="btn" id="backFromCreate" type="button">Back</button>
          <button class="btn" id="goLeaderboardFromCreate" type="button">View Leaderboard</button>
        </div>
      </div>
    </div>

    <!-- CAPTAIN JOIN -->
    <div class="screen" id="screen-captain-join">
      <div class="kicker"><span class="dot"></span> Captain sign-in</div>
      <h1>Captain: Enter Scores</h1>
      <p class="lead">Enter tournament code, pick your team, then unlock with the captain PIN.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament code</div>
          <input class="input" id="j_code" placeholder="e.g., A7K2Q9" />
        </div>

        <div class="field">
          <div class="label">Team</div>
          <select class="select" id="j_team">
            <option value="">Load tournament first</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Captain PIN</div>
          <input class="input" id="j_pin" inputmode="numeric" placeholder="4‚Äì8 digits" />
        </div>

        <div class="field">
          <div class="label">Captain name (for audit)</div>
          <input class="input" id="j_captainName" placeholder="e.g., Mason" />
          <div class="hint">Shows on last-updated audit line.</div>
        </div>

        <button class="btn btn-primary" id="j_unlock" type="button">Unlock Score Entry</button>
        <button class="btn" id="backFromJoin" type="button">Back</button>

        <div class="card">
          <div class="label">Anti-cheat basics</div>
          <div class="hint">
            Scores require the captain PIN. Each submission records timestamp + captain name + device label.
            If someone keeps ‚Äúediting‚Äù holes, the update timestamps make it obvious.
          </div>
        </div>
      </div>
    </div>

    <!-- SCORE ENTRY (one hole) -->
    <div class="screen" id="screen-score">
      <div class="kicker"><span class="dot"></span> One hole at a time</div>
      <h1 id="s_title">Score Entry</h1>
      <p class="lead" id="s_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Current hole</div>
          <div class="big-num" id="s_hole">1</div>
          <div class="sub" id="s_holeMeta">Starting hole: ‚Äî</div>
        </div>

        <div class="field">
          <div class="label">Team score for this hole</div>
          <input class="input" id="s_score" inputmode="numeric" placeholder="Enter strokes (e.g., 4)" />
          <div class="hint">Enter gross strokes for the team on this hole.</div>
        </div>

        <button class="btn btn-primary" id="s_submit" type="button">Submit Hole Score</button>

        <div class="row">
          <button class="btn" id="s_prev" type="button">‚óÄ Prev hole</button>
          <button class="btn" id="s_next" type="button">Next hole ‚ñ∂</button>
        </div>

        <div class="card" id="s_auditCard">
          <div class="label">Last update</div>
          <div class="hint" id="s_audit">‚Äî</div>
        </div>

        <div class="row">
          <button class="btn" id="s_toLB" type="button">View Leaderboard</button>
          <button class="btn btn-danger" id="s_lock" type="button">Lock / Switch Team</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="screen" id="screen-leaderboard">
      <div class="kicker"><span class="dot"></span> Live leaderboard</div>
      <h1 id="lb_title">Leaderboard</h1>
      <p class="lead" id="lb_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Tournament code</div>
          <input class="input" id="lb_code" placeholder="Enter code (e.g., A7K2Q9)" />
          <div class="row">
            <button class="btn btn-primary" id="lb_load" type="button">Load Leaderboard</button>
            <button class="btn" id="lb_refresh" type="button">Refresh</button>
          </div>
          <div class="hint" id="lb_status">‚Äî</div>
        </div>

        <div class="lb" id="lb_list"></div>

        <div class="row">
          <button class="btn" id="backFromLB" type="button">Back</button>
          <button class="btn" id="copyLB" type="button">Copy Leaderboard</button>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Firebase (optional) -->
<script type="module">
  /* ==========================================================
     Charity Tournament App ‚Äî Captain scoring + live leaderboard
     - One thing per screen
     - Shotgun start support (team starting hole)
     - Real-time via Firebase Realtime Database (optional)
     ========================================================== */

  // ========= TO ENABLE REAL-TIME =========
  // 1) Create Firebase project
  // 2) Enable Realtime Database
  // 3) Paste your config below
  // 4) Set RULES (example in comment near the bottom)
  //
  // If you leave FIREBASE_CONFIG null, app runs in local demo mode
  // (single device only).

  const FIREBASE_CONFIG = null;
  // Example:
  // const FIREBASE_CONFIG = {
  //   apiKey: "‚Ä¶",
  //   authDomain: "‚Ä¶",
  //   databaseURL: "https://YOUR-PROJECT-default-rtdb.firebaseio.com",
  //   projectId: "‚Ä¶",
  //   storageBucket: "‚Ä¶",
  //   messagingSenderId: "‚Ä¶",
  //   appId: "‚Ä¶",
  // };

  // ========= Imports only if config exists =========
  let fb = { enabled:false };
  if(FIREBASE_CONFIG){
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
    const {
      getDatabase, ref, set, get, onValue, update, push, child, off
    } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js");

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getDatabase(app);

    fb = { enabled:true, db, ref, set, get, onValue, update, push, child, off };
  }

  // ========= Helpers =========
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  function show(screenId){
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("show"));
    $(screenId).classList.add("show");
  }

  function uid(len=6){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function nowISO(){
    return new Date().toISOString();
  }

  function safeInt(v){
    const n = Number(String(v||"").trim());
    return Number.isFinite(n) ? Math.round(n) : null;
  }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(String(str));
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function deviceLabel(){
    const key = "ct_device_label_v1";
    let v = localStorage.getItem(key);
    if(!v){
      v = "Device-" + uid(4);
      localStorage.setItem(key, v);
    }
    return v;
  }

  // ========= Local fallback storage =========
  const LOCAL_KEY = "ct_local_state_v1";
  function localLoad(){
    function localLoad(){
    try{
      const raw = localStorage.getItem(LOCAL_KEY);
      return raw ? JSON.parse(raw) : { tournaments:{} };
    }catch{
      return { tournaments:{} };
    }
  }
  function localSave(data){
    localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
  }

  function localGetTournament(code){
    const data = localLoad();
    return data.tournaments?.[code] || null;
  }
  function localSetTournament(code, t){
    const data = localLoad();
    data.tournaments = data.tournaments || {};
    data.tournaments[code] = t;
    localSave(data);
  }

  // ========= Tournament model =========
  function blankTournament({ name, holes, shotgun, par, code }){
    const holesN = (Number(holes)===9) ? 9 : 18;
    const parArr = (par && par.length) ? par.slice(0, holesN) : Array(holesN).fill(null);

    return {
      meta:{
        code,
        name: name || "Charity Tournament",
        holes: holesN,
        shotgun: shotgun === "yes",
        par: parArr, // can be nulls
        createdAt: nowISO(),
        updatedAt: nowISO(),
        mode: fb.enabled ? "realtime" : "local"
      },
      teams: [],   // {id, name, startHole, pinHash}
      scores: {},  // teamId -> { holeNumber: strokesInt }
      audit: {}    // teamId -> { updatedAt, captainName, device, hole }
    };
  }

  function teamTemplate(){
    return { id:"t_"+uid(8), name:"Team", startHole:1, pin:"" };
  }

  // ========= Firebase paths =========
  function tPath(code){ return `tournaments/${code}`; }

  async function dbWriteTournament(code, t){
    if(!fb.enabled){
      localSetTournament(code, t);
      return;
    }
    const r = fb.ref(fb.db, tPath(code));
    await fb.set(r, t);
  }

  async function dbReadTournament(code){
    if(!fb.enabled){
      return localGetTournament(code);
    }
    const snap = await fb.get(fb.ref(fb.db, tPath(code)));
    return snap.exists() ? snap.val() : null;
  }

  async function dbPatch(path, obj){
    if(!fb.enabled){
      // local patch: path like tournaments/CODE/scores/teamId/3
      const parts = path.split("/");
      // parts: ["tournaments", code, ...]
      const code = parts[1];
      let t = localGetTournament(code);
      if(!t) return;

      // walk and assign
      let cur = t;
      for(let i=2;i<parts.length-1;i++){
        const k = parts[i];
        if(cur[k] === undefined) cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = obj;
      t.meta.updatedAt = nowISO();
      localSetTournament(code, t);
      return;
    }

    const r = fb.ref(fb.db, path);
    await fb.set(r, obj);
  }

  async function dbUpdate(path, obj){
    if(!fb.enabled){
      // local deep update (merge)
      const parts = path.split("/");
      const code = parts[1];
      let t = localGetTournament(code);
      if(!t) return;

      let cur = t;
      for(let i=2;i<parts.length;i++){
        const k = parts[i];
        if(cur[k] === undefined) cur[k] = {};
        cur = cur[k];
      }
      Object.keys(obj).forEach(k => { cur[k] = obj[k]; });
      t.meta.updatedAt = nowISO();
      localSetTournament(code, t);
      return;
    }

    const r = fb.ref(fb.db, path);
    await fb.update(r, obj);
  }

  // ========= App state =========
  const sessionKey = "ct_session_v1";
  function sessLoad(){
    try{
      const raw = localStorage.getItem(sessionKey);
      return raw ? JSON.parse(raw) : {};
    }catch{
      return {};
    }
  }
  function sessSave(s){
    localStorage.setItem(sessionKey, JSON.stringify(s));
  }

  let session = sessLoad(); // { code, teamId, captainName, unlocked:true/false, hole }
  let liveUnsub = null;

  function setRTStatus(){
    $("rtStatus").textContent = fb.enabled
      ? "Real-time enabled (Firebase). Leaderboard updates automatically."
      : "Local demo mode (single device). Add Firebase config for live updates.";
  }

  // ========= Screen wiring =========
  $("btnHome").addEventListener("click", () => show("screen-home"));
  $("goCreate").addEventListener("click", () => show("screen-create"));
  $("goCaptain").addEventListener("click", () => show("screen-captain-join"));
  $("goLeaderboard").addEventListener("click", () => show("screen-leaderboard"));

  $("backFromCreate").addEventListener("click", () => show("screen-home"));
  $("goLeaderboardFromCreate").addEventListener("click", () => show("screen-leaderboard"));

  $("backFromJoin").addEventListener("click", () => show("screen-home"));
  $("backFromLB").addEventListener("click", () => show("screen-home"));

  $("btnResetLocal").addEventListener("click", () => {
    localStorage.removeItem(LOCAL_KEY);
    localStorage.removeItem(sessionKey);
    session = {};
    toast("Local cache reset.");
    setRTStatus();
    show("screen-home");
  });

  // ========= Create Tournament =========
  function parsePar(input, holes){
    const raw = (input || "").trim();
    if(!raw) return Array(holes).fill(null);
    const parts = raw.split(",").map(s => Number(String(s).trim()));
    const out = Array(holes).fill(null);
    for(let i=0;i<holes;i++){
      const v = parts[i];
      out[i] = Number.isFinite(v) ? Math.round(v) : null;
    }
    return out;
  }

  function regenCode(){
    $("c_code").textContent = uid(6);
  }
  regenCode();

  $("c_regen").addEventListener("click", regenCode);
  $("c_copycode").addEventListener("click", async () => {
    await copyText($("c_code").textContent.trim());
    toast("Code copied.");
  });

  function renderCreateTeams(list){
    const wrap = $("c_teams");
    wrap.innerHTML = "";

    list.forEach((t, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="stack">
          <div class="row stretch">
            <div class="field">
              <div class="label">Team name</div>
              <input class="input" data-tn="${t.id}" value="${escapeAttr(t.name)}" placeholder="Team name" />
            </div>
          </div>

          <div class="row stretch">
            <div class="field">
              <div class="label">Starting hole</div>
              <input class="input" data-ts="${t.id}" inputmode="numeric" value="${t.startHole}" placeholder="1" />
              <div class="hint">Shotgun: teams can start anywhere.</div>
            </div>
            <div class="field">
              <div class="label">Captain PIN</div>
              <input class="input" data-tp="${t.id}" inputmode="numeric" value="${escapeAttr(t.pin)}" placeholder="4‚Äì8 digits" />
              <div class="hint">This is hashed when you publish.</div>
            </div>
          </div>

          <div class="row">
            <button class="btn btn-danger" data-del="${t.id}" type="button">Remove team</button>
          </div>
        </div>
      `;
      wrap.appendChild(card);
    });

    // bind edits
    wrap.querySelectorAll("[data-tn]").forEach(inp => {
      inp.addEventListener("input", () => {
        const id = inp.getAttribute("data-tn");
        const t = list.find(x => x.id === id);
        if(!t) return;
        t.name = (inp.value || "Team").slice(0,40);
      });
    });

    wrap.querySelectorAll("[data-ts]").forEach(inp => {
      inp.addEventListener("input", () => {
        const id = inp.getAttribute("data-ts");
        const t = list.find(x => x.id === id);
        if(!t) return;
        const n = safeInt(inp.value);
        t.startHole = clamp(n || 1, 1, Number($("c_holes").value)===9 ? 9 : 18);
      });
    });

    wrap.querySelectorAll("[data-tp]").forEach(inp => {
      inp.addEventListener("input", () => {
        const id = inp.getAttribute("data-tp");
        const t = list.find(x => x.id === id);
        if(!t) return;
        t.pin = (inp.value || "").replace(/\D/g,"").slice(0,8);
      });
    });

    wrap.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const idx = list.findIndex(x => x.id === id);
        if(idx >= 0) list.splice(idx, 1);
        renderCreateTeams(list);
      });
    });
  }

  // initial create list
  let createTeams = [teamTemplate(), teamTemplate(), teamTemplate(), teamTemplate()];
  createTeams[0].name = "Team 1";
  createTeams[1].name = "Team 2";
  createTeams[2].name = "Team 3";
  createTeams[3].name = "Team 4";
  renderCreateTeams(createTeams);

  $("c_addteam").addEventListener("click", () => {
    createTeams.push(teamTemplate());
    createTeams[createTeams.length-1].name = `Team ${createTeams.length}`;
    renderCreateTeams(createTeams);
  });

  $("c_publish").addEventListener("click", async () => {
    $("c_publishHint").textContent = "";

    const code = $("c_code").textContent.trim().toUpperCase();
    const name = ($("c_name").value || "").trim();
    const holes = (Number($("c_holes").value)===9) ? 9 : 18;
    const shotgun = $("c_shotgun").value;

    // Validate teams
    const teamsClean = createTeams
      .map(t => ({
        id: t.id,
        name: (t.name || "Team").trim(),
        startHole: clamp(safeInt(t.startHole)||1, 1, holes),
        pin: String(t.pin||"").replace(/\D/g,"")
      }))
      .filter(t => t.name.length > 0);

    if(teamsClean.length < 2){
      toast("Add at least 2 teams.");
      return;
    }
    for(const t of teamsClean){
      if(t.pin.length < 4){
        toast(`PIN too short for ${t.name} (min 4 digits).`);
        return;
      }
    }

    // Hash pins
    const teamsHashed = [];
    for(const t of teamsClean){
      const pinHash = await sha256Hex(`${code}:${t.id}:${t.pin}`);
      teamsHashed.push({
        id: t.id,
        name: t.name,
        startHole: (shotgun === "yes") ? t.startHole : 1,
        pinHash
      });
    }

    const par = parsePar($("c_par").value, holes);
    const tourney = blankTournament({ name, holes, shotgun, par, code });
    tourney.teams = teamsHashed;

    // Precreate score objects
    tourney.teams.forEach(tm => {
      tourney.scores[tm.id] = {};
      tourney.audit[tm.id] = { updatedAt: null, captainName: null, device: null, hole: null };
    });

    await dbWriteTournament(code, tourney);
    toast("Tournament published.");
    $("c_publishHint").textContent = fb.enabled
      ? "Published to Firebase. Share the code with captains and participants."
      : "Saved locally (single device). Add Firebase config for true live scoring.";

    // Store last used code
    session.code = code;
    sessSave(session);

    // Prefill leaderboard/captain code boxes
    $("j_code").value = code;
    $("lb_code").value = code;

    await loadTournamentToJoin(code);
    await loadLeaderboard(code, true);
  });

  // ========= Captain Join =========
  async function loadTournamentToJoin(code){
    const c = String(code||"").trim().toUpperCase();
    if(!c) return;
    const t = await dbReadTournament(c);
    const sel = $("j_team");
    sel.innerHTML = "";
    if(!t){
      sel.innerHTML = `<option value="">Tournament not found</option>`;
      return;
    }
    t.teams.forEach(team => {
      const opt = document.createElement("option");
      opt.value = team.id;
      opt.textContent = team.name;
      sel.appendChild(opt);
    });
    toast("Tournament loaded.");
  }

  $("j_code").addEventListener("change", async () => {
    await loadTournamentToJoin($("j_code").value);
  });

  $("j_unlock").addEventListener("click", async () => {
    const code = String($("j_code").value||"").trim().toUpperCase();
    const teamId = $("j_team").value;
    const pin = String($("j_pin").value||"").replace(/\D/g,"");
    const captainName = String($("j_captainName").value||"").trim().slice(0,28) || "Captain";

    if(!code || code.length < 4){
      toast("Enter a tournament code.");
      return;
    }
    if(!teamId){
      toast("Pick your team.");
      return;
    }
    if(pin.length < 4){
      toast("Enter your captain PIN.");
      return;
    }

    const t = await dbReadTournament(code);
    if(!t){
      toast("Tournament not found.");
      return;
    }
    const team = t.teams.find(x => x.id === teamId);
    if(!team){
      toast("Team not found.");
      return;
    }

    const hash = await sha256Hex(`${code}:${teamId}:${pin}`);
    if(hash !== team.pinHash){
      toast("Incorrect PIN.");
      return;
    }

    session = {
      code,
      teamId,
      captainName,
      unlocked: true,
      hole: clamp(Number(session.hole)||team.startHole||1, 1, Number(t.meta?.holes)||18)
    };
    sessSave(session);

    // Initialize hole to starting hole if none set
    if(!session.hole) session.hole = team.startHole || 1;

    await openScoreEntry(code, teamId);
    toast("Unlocked.");
  });

  // ========= Score entry =========
  async function openScoreEntry(code, teamId){
    const t = await dbReadTournament(code);
    if(!t){ toast("Tournament not found."); return; }

    const team = t.teams.find(x => x.id === teamId);
    if(!team){ toast("Team not found."); return; }

    // Determine current hole
    const holes = Number(t.meta.holes)||18;
    session.hole = clamp(Number(session.hole)||team.startHole||1, 1, holes);
    sessSave(session);

    $("s_title").textContent = team.name;
    $("s_sub").textContent = `${t.meta.name} ‚Ä¢ ${holes} holes ‚Ä¢ ${t.meta.shotgun ? "Shotgun start" : "Start on 1"}`;

    $("s_hole").textContent = String(session.hole);
    $("s_holeMeta").textContent = `Starting hole: ${team.startHole || 1} ‚Ä¢ Team ID: ${teamId.slice(0,6)}‚Ä¶`;

    const existing = t.scores?.[teamId]?.[String(session.hole)];
    $("s_score").value = (existing === undefined || existing === null) ? "" : String(existing);

    const audit = t.audit?.[teamId];
    renderAuditLine(audit);

    show("screen-score");
  }

  function renderAuditLine(a){
    if(!a || !a.updatedAt){
      $("s_audit").textContent = "No submissions yet.";
      return;
    }
    const line = `Updated ${a.updatedAt} ‚Ä¢ Hole ${a.hole} ‚Ä¢ ${a.captainName || "Captain"} ‚Ä¢ ${a.device || "Device"}`;
    $("s_audit").textContent = line;
  }

  $("s_prev").addEventListener("click", async () => {
    const code = session.code;
    if(!code || !session.teamId) return;
    const t = await dbReadTournament(code);
    if(!t) return;
    const holes = Number(t.meta.holes)||18;
    session.hole = clamp((Number(session.hole)||1) - 1, 1, holes);
    sessSave(session);
    await openScoreEntry(code, session.teamId);
  });

  $("s_next").addEventListener("click", async () => {
    const code = session.code;
    if(!code || !session.teamId) return;
    const t = await dbReadTournament(code);
    if(!t) return;
    const holes = Number(t.meta.holes)||18;
    session.hole = clamp((Number(session.hole)||1) + 1, 1, holes);
    sessSave(session);
    await openScoreEntry(code, session.teamId);
  });

  $("s_submit").addEventListener("click", async () => {
    if(!session.unlocked){
      toast("Locked. Sign in again.");
      show("screen-captain-join");
      return;
    }

    const code = session.code;
    const teamId = session.teamId;

    const strokes = safeInt($("s_score").value);
    if(strokes === null || strokes < 0 || strokes > 30){
      toast("Enter a valid hole score (0‚Äì30).");
      return;
    }

    // Write score
    const hole = Number(session.hole)||1;

    if(fb.enabled){
      await fb.set(fb.ref(fb.db, `${tPath(code)}/scores/${teamId}/${hole}`), strokes);
      await fb.set(fb.ref(fb.db, `${tPath(code)}/audit/${teamId}`), {
        updatedAt: nowISO(),
        captainName: session.captainName || "Captain",
        device: deviceLabel(),
        hole
      });
      await fb.update(fb.ref(fb.db, `${tPath(code)}/meta`), { updatedAt: nowISO() });
    }else{
      const t = localGetTournament(code);
      if(!t){ toast("Tournament not found."); return; }
      t.scores = t.scores || {};
      t.scores[teamId] = t.scores[teamId] || {};
      t.scores[teamId][String(hole)] = strokes;
      t.audit = t.audit || {};
      t.audit[teamId] = { updatedAt: nowISO(), captainName: session.captainName||"Captain", device: deviceLabel(), hole };
      t.meta.updatedAt = nowISO();
      localSetTournament(code, t);
    }

    toast("Submitted.");
    await openScoreEntry(code, teamId);
    await loadLeaderboard(code, false);
  });

  $("s_toLB").addEventListener("click", async () => {
    $("lb_code").value = session.code || $("lb_code").value;
    await loadLeaderboard($("lb_code").value, true);
    show("screen-leaderboard");
  });

  $("s_lock").addEventListener("click", () => {
    session.unlocked = false;
    session.teamId = null;
    sessSave(session);
    toast("Locked.");
    show("screen-captain-join");
  });

  // ========= Leaderboard =========
  function sumTeamScore(t, teamId){
    const holes = Number(t.meta?.holes)||18;
    const obj = t.scores?.[teamId] || {};
    let sum = 0;
    let played = 0;
    for(let h=1; h<=holes; h++){
      const v = obj[String(h)];
      if(v === undefined || v === null) continue;
      played++;
      sum += Number(v)||0;
    }
    return { sum, played, holes };
  }

  function sumTeamToPar(t, teamId){
    const par = t.meta?.par || [];
    const obj = t.scores?.[teamId] || {};
    let diff = 0;
    let played = 0;
    for(let h=1; h<=Number(t.meta.holes||18); h++){
      const v = obj[String(h)];
      if(v === undefined || v === null) continue;
      const p = Number(par[h-1]);
      if(!Number.isFinite(p)) { played++; continue; }
      diff += (Number(v)||0) - p;
      played++;
    }
    return { diff, played };
  }

  function fmtToPar(n){
    if(n === 0) return "E";
    return n > 0 ? `+${n}` : `${n}`;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;")
      .replaceAll("\n"," ");
  }

  async function loadLeaderboard(code, auto){
    const c = String(code||"").trim().toUpperCase();
    if(!c){
      $("lb_status").textContent = "Enter a tournament code.";
      return;
    }
    $("lb_status").textContent = "Loading‚Ä¶";

    const t = await dbReadTournament(c);
    if(!t){
      $("lb_status").textContent = "Tournament not found.";
      $("lb_list").innerHTML = "";
      return;
    }

    $("lb_title").textContent = t.meta?.name || "Leaderboard";
    $("lb_sub").textContent =
      `${t.meta?.holes || 18} holes ‚Ä¢ ${t.meta?.shotgun ? "Shotgun start" : "Start on 1"} ‚Ä¢ Updated ${t.meta?.updatedAt || "‚Äî"}`;

    // Build entries
    const rows = t.teams.map(team => {
      const tot = sumTeamScore(t, team.id);
      const hasPar = (t.meta?.par || []).some(x => Number.isFinite(Number(x)));
      const toPar = hasPar ? sumTeamToPar(t, team.id) : null;
      const audit = t.audit?.[team.id] || {};
      return {
        teamId: team.id,
        name: team.name,
        startHole: team.startHole || 1,
        sum: tot.sum,
        played: tot.played,
        holes: tot.holes,
        toPar: toPar ? toPar.diff : null,
        audit
      };
    });

    // Sort: lowest strokes first (classic). Ties broken by more holes played (so complete scores rise).
    rows.sort((a,b) => {
      if(a.sum !== b.sum) return a.sum - b.sum;
      return b.played - a.played;
    });

    // Render
    const list = $("lb_list");
    list.innerHTML = "";
    rows.forEach((r, idx) => {
      const div = document.createElement("div");
      div.className = "lb-item";

      const toParText = (r.toPar === null) ? "" : ` ‚Ä¢ To par: ${fmtToPar(r.toPar)}`;
      const auditText = r.audit?.updatedAt
        ? `Last: ${r.audit.updatedAt} ‚Ä¢ Hole ${r.audit.hole} ‚Ä¢ ${r.audit.captainName || "Captain"}`
        : "No submissions yet";

      div.innerHTML = `
        <div class="lb-left">
          <div class="lb-team">${idx+1}. ${escapeHtml(r.name)}</div>
          <div class="lb-meta">
            <span class="pill">Start: ${r.startHole}</span>
            <span class="pill">Played: ${r.played}/${r.holes}</span>
            ${r.toPar === null ? "" : `<span class="pill">To par: ${escapeHtml(fmtToPar(r.toPar))}</span>`}
          </div>
          <div class="hint" style="margin-top:8px;">${escapeHtml(auditText)}</div>
        </div>
        <div class="scorebox">
          <div class="score">${r.sum}</div>
          <div class="small">${r.played ? "gross strokes" : "‚Äî"}</div>
        </div>
      `;
      list.appendChild(div);
    });

    $("lb_status").textContent = fb.enabled
      ? (auto ? "Live updates enabled." : "Updated.")
      : "Local demo mode (no live network).";

    // Live subscribe (Firebase only)
    if(fb.enabled){
      subscribeLeaderboard(c);
    }
  }

  function subscribeLeaderboard(code){
    if(!fb.enabled) return;

    // Unsubscribe existing
    if(liveUnsub){
      try{ liveUnsub(); }catch{}
      liveUnsub = null;
    }

    const r = fb.ref(fb.db, tPath(code));
    const handler = (snap) => {
      if(!snap.exists()) return;
      const t = snap.val();
      // Re-render quickly without re-subscribing
      renderLeaderboardFromTournament(t);
    };

    fb.onValue(r, handler);
    liveUnsub = () => fb.off(r, "value", handler);
  }

  function renderLeaderboardFromTournament(t){
    $("lb_title").textContent = t.meta?.name || "Leaderboard";
    $("lb_sub").textContent =
      `${t.meta?.holes || 18} holes ‚Ä¢ ${t.meta?.shotgun ? "Shotgun start" : "Start on 1"} ‚Ä¢ Updated ${t.meta?.updatedAt || "‚Äî"}`;

    const rows = t.teams.map(team => {
      const tot = sumTeamScore(t, team.id);
      const hasPar = (t.meta?.par || []).some(x => Number.isFinite(Number(x)));
      const toPar = hasPar ? sumTeamToPar(t, team.id) : null;
      const audit = t.audit?.[team.id] || {};
      return {
        teamId: team.id,
        name: team.name,
        startHole: team.startHole || 1,
        sum: tot.sum,
        played: tot.played,
        holes: tot.holes,
        toPar: toPar ? toPar.diff : null,
        audit
      };
    });

    rows.sort((a,b) => {
      if(a.sum !== b.sum) return a.sum - b.sum;
      return b.played - a.played;
    });

    const list = $("lb_list");
    list.innerHTML = "";
    rows.forEach((r, idx) => {
      const div = document.createElement("div");
      div.className = "lb-item";
      const auditText = r.audit?.updatedAt
        ? `Last: ${r.audit.updatedAt} ‚Ä¢ Hole ${r.audit.hole} ‚Ä¢ ${r.audit.captainName || "Captain"}`
        : "No submissions yet";

      div.innerHTML = `
        <div class="lb-left">
          <div class="lb-team">${idx+1}. ${escapeHtml(r.name)}</div>
          <div class="lb-meta">
            <span class="pill">Start: ${r.startHole}</span>
            <span class="pill">Played: ${r.played}/${r.holes}</span>
            ${r.toPar === null ? "" : `<span class="pill">To par: ${escapeHtml(fmtToPar(r.toPar))}</span>`}
          </div>
          <div class="hint" style="margin-top:8px;">${escapeHtml(auditText)}</div>
        </div>
        <div class="scorebox">
          <div class="score">${r.sum}</div>
          <div class="small">${r.played ? "gross strokes" : "‚Äî"}</div>
        </div>
      `;
      list.appendChild(div);
    });

    $("lb_status").textContent = "Live updating‚Ä¶";
  }

  $("lb_load").addEventListener("click", async () => {
    const code = $("lb_code").value;
    session.code = String(code||"").trim().toUpperCase();
    sessSave(session);
    await loadLeaderboard(code, true);
  });

  $("lb_refresh").addEventListener("click", async () => {
    await loadLeaderboard($("lb_code").value, false);
    toast("Refreshed.");
  });

  // ========= Copy helpers =========
  async function copyText(text){
    const t = String(text||"");
    try{
      await navigator.clipboard.writeText(t);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = t;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
  }

  $("copyLB").addEventListener("click", async () => {
    const cards = Array.from(document.querySelectorAll("#lb_list .lb-item"));
    const lines = cards.map(c => c.innerText.replace(/\n+/g," ‚Ä¢ ").trim());
    const title = $("lb_title").textContent || "Leaderboard";
    const sub = $("lb_sub").textContent || "";
    await copyText(`${title}\n${sub}\n\n` + lines.join("\n"));
    toast("Leaderboard copied.");
  });

  // ========= Small utilities =========
  function escapeTextForStatus(s){ return String(s||"").slice(0,160); }

  // ========= Auto-load last code (if any) =========
  setRTStatus();

  if(session.code){
    $("lb_code").value = session.code;
    $("j_code").value = session.code;
    // preload team list for captain join
    await loadTournamentToJoin(session.code);
  }

  // ========= Home buttons =========
  // Let captain enter scores quickly if already unlocked
  $("goCaptain").addEventListener("click", async () => {
    if(session.unlocked && session.code && session.teamId){
      await openScoreEntry(session.code, session.teamId);
    }else{
      show("screen-captain-join");
    }
  });

  // ========= Leaderboard default screen info =========
  $("lb_status").textContent = fb.enabled
    ? "Enter a code to view live leaderboard."
    : "Local demo mode. Enter a code saved on this device.";

  // ========= Create screen default hints =========
  $("c_publishHint").textContent = fb.enabled
    ? "Publish writes to Firebase so everyone sees updates."
    : "Local demo mode stores tournament only on this device.";

  // ========= Firebase Rules (example) =========
  // IMPORTANT: Real security requires auth. This demo uses PIN-hash checks on the client,
  // which deters casual tampering but is not bulletproof against a determined attacker.
  //
  // Recommended: Add Firebase Auth (anonymous) + Cloud Functions to validate PIN on server.
  //
  // Minimal RTDB rules for a public leaderboard (read-only) + write for scores/audit:
  //
  // {
  //   "rules": {
  //     "tournaments": {
  //       "$code": {
  //         ".read": true,
  //         "meta": { ".write": true },
  //         "teams": { ".write": true },
  //         "scores": { ".write": true },
  //         "audit": { ".write": true }
  //       }
  //     }
  //   }
  // }
  //
  // If you want to reduce cheating further without auth:
  // - Make ".write": false globally
  // - Use a small admin-only scoring device with service credentials (Cloud Function endpoint)
  // - Captains submit via a HTTPS endpoint that validates PIN server-side.
</script>
</body>
</html>