<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charity Tournament ‚Äî Live Leaderboard</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Captain-submitted scoring with shotgun starts and a live leaderboard. Mobile-first and simple." />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#556173;
      --hair: rgba(15,23,42,.08);
      --border: rgba(15,23,42,.12);
      --panel: rgba(255,255,255,.86);
      --blue:#1d79c6;
      --green:#2cab4b;
      --danger:#dc2626;
      --warn:#f59e0b;
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --shadow2: 0 10px 30px rgba(15,23,42,.08);
      --radius: 18px;
      --max: 720px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      line-height: 1.35;
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(29,121,198,.14), transparent 60%),
        radial-gradient(1200px 520px at 90% 0%, rgba(44,171,75,.10), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.03), transparent 55%),
        var(--bg);
      min-height: 100vh;
    }

    a{ color:inherit; text-decoration:none; }
    .container{ max-width: var(--max); margin:0 auto; padding: 0 14px; }

    header{
      position: sticky; top:0; z-index:50;
      background: rgba(255,255,255,.90);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--hair);
    }

    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 10px 0;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width: 34px; height: 34px;
      border-radius: 14px;
      border: 1px solid var(--hair);
      background:
        radial-gradient(14px 14px at 30% 35%, rgba(29,121,198,.26), transparent 70%),
        radial-gradient(14px 14px at 68% 58%, rgba(44,171,75,.22), transparent 70%),
        rgba(15,23,42,.02);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
    }
    .brand-title{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .brand-title strong{ font-weight: 950; font-size: 13px; letter-spacing: .1px; }
    .brand-title span{
      font-weight: 800; font-size: 11.5px; color: var(--muted);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 260px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      font-size: 13px;
      min-height: 42px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--green));
      box-shadow: 0 18px 44px rgba(29,121,198,.18);
    }
    .btn-primary:hover{ box-shadow: 0 22px 60px rgba(29,121,198,.22); }

    .btn-danger{
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.30);
      color: rgba(127,29,29,.95);
    }
    .btn-warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.35);
      color: rgba(120,53,15,.95);
    }

    main{ padding: 14px 0 24px; }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 240px at 12% 16%, rgba(29,121,198,.08), transparent 70%),
        radial-gradient(420px 240px at 98% 0%, rgba(44,171,75,.06), transparent 70%);
      pointer-events:none;
    }
    .panel > *{ position: relative; }

    .kicker{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      font-size: 12px;
      font-weight: 900;
      color: rgba(11,18,32,.86);
      width: fit-content;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: linear-gradient(135deg, var(--blue), var(--green));
    }

    h1{
      margin: 10px 0 6px;
      font-size: 22px;
      letter-spacing: -0.5px;
      line-height: 1.08;
      font-weight: 950;
    }
    .lead{
      margin: 0;
      color: rgba(11,18,32,.70);
      font-weight: 850;
      font-size: 13.5px;
      line-height: 1.45;
    }

    .screen{ display:none; }
    .screen.show{ display:block; }

    .stack{ display:flex; flex-direction:column; gap: 10px; }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .row.stretch > *{ flex: 1 1 160px; }

    .field{ display:flex; flex-direction:column; gap: 6px; }
    .label{ font-weight: 950; font-size: 12px; color: rgba(11,18,32,.82); }
    .hint{ font-weight: 800; font-size: 12px; color: rgba(11,18,32,.60); margin-top: -2px; }

    .input, .select{
      width:100%;
      padding: 13px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      color: rgba(11,18,32,.92);
      outline:none;
      font-weight: 900;
      font-size: 15px;
      min-height: 44px;
    }
    .input:focus, .select:focus{
      border-color: rgba(29,121,198,.55);
      box-shadow: 0 0 0 4px rgba(29,121,198,.10);
    }

    .hr{ height:1px; background: rgba(15,23,42,.08); margin: 10px 0; }

    .card{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.86);
      border-radius: 16px;
      padding: 12px;
    }

    .big-num{
      font-size: 40px;
      font-weight: 950;
      letter-spacing: -1px;
      line-height: 1;
      margin: 4px 0 0;
    }
    .sub{
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Leaderboard */
    .lb{ display:flex; flex-direction:column; gap: 10px; }
    .lb-item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.90);
      border-radius: 16px;
      padding: 12px;
    }
    .lb-left{ min-width:0; }
    .lb-team{
      font-weight: 950;
      letter-spacing: -0.2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 58vw;
    }
    .lb-meta{
      margin-top: 6px;
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.86);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,18,32,.78);
    }
    .scorebox{
      text-align:right;
      flex: 0 0 auto;
    }
    .scorebox .score{
      font-weight: 950;
      font-size: 26px;
      letter-spacing: -0.4px;
      line-height: 1.05;
    }
    .scorebox .small{
      font-weight: 850;
      color: rgba(11,18,32,.60);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(640px, calc(100% - 24px));
      z-index: 2000;
      display:none;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.95);
      box-shadow: 0 18px 55px rgba(15,23,42,.18);
      color: rgba(11,18,32,.90);
      font-weight: 900;
      font-size: 13px;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
<header>
  <div class="container nav">
    <a class="brand" href="../../demos.html" aria-label="Back to Demos">
      <div class="badge">üèÜ</div>
      <div class="brand-title">
        <strong>Charity Tournament</strong>
        <span>Captain scoring + live leaderboard</span>
      </div>
    </a>
    <div class="row">
      <button class="btn" id="btnHome" type="button">Home</button>
      <button class="btn btn-warn" id="btnResetLocal" type="button" title="Clears local device cache only">Reset</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="panel">
    <!-- HOME -->
    <div class="screen show" id="screen-home">
      <div class="kicker"><span class="dot"></span> Mobile-first ‚Ä¢ One thing per screen</div>
      <h1>Live Tournament Scoring</h1>
      <p class="lead">
        One captain per team submits hole-by-hole scores. Everyone can open the leaderboard and watch it update.
      </p>

      <div class="hr"></div>

      <div class="stack">
        <button class="btn btn-primary" id="goCreate" type="button">Create Tournament</button>
        <button class="btn" id="goCaptain" type="button">Captain: Enter Scores</button>
        <button class="btn" id="goLeaderboard" type="button">View Leaderboard</button>

        <div class="card">
          <div class="label">Real-time mode</div>
          <div class="hint" id="rtStatus">Initializing‚Ä¶</div>
          <div class="hint" id="rtHint"></div>
        </div>
      </div>
    </div>

    <!-- CREATE -->
    <div class="screen" id="screen-create">
      <div class="kicker"><span class="dot"></span> Setup tournament</div>
      <h1>Create Tournament</h1>
      <p class="lead">Make a tournament code, add teams, set shotgun starts, and assign captain PINs.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament name</div>
          <input class="input" id="c_name" placeholder="e.g., Rotary Charity Scramble" />
        </div>

        <div class="row stretch">
          <div class="field">
            <div class="label">Holes</div>
            <select class="select" id="c_holes">
              <option value="9">9</option>
              <option value="18" selected>18</option>
            </select>
          </div>

          <div class="field">
            <div class="label">Shotgun start?</div>
            <select class="select" id="c_shotgun">
              <option value="yes" selected>Yes</option>
              <option value="no">No (starts on hole 1)</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="label">Optional: course par (comma-separated)</div>
          <input class="input" id="c_par" placeholder="18 numbers (optional). Example: 4,4,3,5,..." />
          <div class="hint">If you include par, leaderboard can show ‚Äúto par‚Äù.</div>
        </div>

        <div class="card">
          <div class="label">Tournament code</div>
          <div class="hint">Share this code with captains and participants.</div>
          <div class="big-num" id="c_code">‚Äî</div>
          <div class="row">
            <button class="btn" id="c_regen" type="button">Regenerate</button>
            <button class="btn" id="c_copycode" type="button">Copy code</button>
          </div>
        </div>

        <div class="card">
          <div class="label">Teams (2‚Äì36 typical)</div>
          <div class="hint">Each team needs: Team name, Starting hole, Captain PIN (4‚Äì8 digits).</div>
          <div class="stack" id="c_teams"></div>
          <div class="row">
            <button class="btn" id="c_addteam" type="button">Add Team</button>
            <button class="btn btn-primary" id="c_publish" type="button">Publish Tournament</button>
          </div>
          <div class="hint" id="c_publishHint"></div>
        </div>

        <div class="row">
          <button class="btn" id="backFromCreate" type="button">Back</button>
          <button class="btn" id="goLeaderboardFromCreate" type="button">View Leaderboard</button>
        </div>
      </div>
    </div>

    <!-- CAPTAIN JOIN -->
    <div class="screen" id="screen-captain-join">
      <div class="kicker"><span class="dot"></span> Captain sign-in</div>
      <h1>Captain: Enter Scores</h1>
      <p class="lead">Enter tournament code, pick your team, then unlock with the captain PIN.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament code</div>
          <input class="input" id="j_code" placeholder="e.g., A7K2Q9" />
        </div>

        <div class="field">
          <div class="label">Team</div>
          <select class="select" id="j_team">
            <option value="">Load tournament first</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Captain PIN</div>
          <input class="input" id="j_pin" inputmode="numeric" placeholder="4‚Äì8 digits" />
        </div>

        <div class="field">
          <div class="label">Captain name (for audit)</div>
          <input class="input" id="j_captainName" placeholder="e.g., Mason" />
        </div>

        <button class="btn btn-primary" id="j_unlock" type="button">Unlock Score Entry</button>
        <button class="btn" id="backFromJoin" type="button">Back</button>

        <div class="card">
          <div class="label">Anti-cheat basics</div>
          <div class="hint">
            Scores require the captain PIN. Each submission records timestamp + captain name + device label.
          </div>
        </div>
      </div>
    </div>

    <!-- SCORE ENTRY -->
    <div class="screen" id="screen-score">
      <div class="kicker"><span class="dot"></span> One hole at a time</div>
      <h1 id="s_title">Score Entry</h1>
      <p class="lead" id="s_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Current hole</div>
          <div class="big-num" id="s_hole">1</div>
          <div class="sub" id="s_holeMeta">‚Äî</div>
        </div>

        <div class="field">
          <div class="label">Team score for this hole</div>
          <input class="input" id="s_score" inputmode="numeric" placeholder="Enter strokes (e.g., 4)" />
          <div class="hint">Enter gross strokes for the team on this hole.</div>
        </div>

        <button class="btn btn-primary" id="s_submit" type="button">Submit Hole Score</button>

        <div class="row">
          <button class="btn" id="s_prev" type="button">‚óÄ Prev</button>
          <button class="btn" id="s_next" type="button">Next ‚ñ∂</button>
        </div>

        <div class="card">
          <div class="label">Last update</div>
          <div class="hint" id="s_audit">‚Äî</div>
        </div>

        <div class="row">
          <button class="btn" id="s_toLB" type="button">View Leaderboard</button>
          <button class="btn btn-danger" id="s_lock" type="button">Lock / Switch Team</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="screen" id="screen-leaderboard">
      <div class="kicker"><span class="dot"></span> Live leaderboard</div>
      <h1 id="lb_title">Leaderboard</h1>
      <p class="lead" id="lb_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Tournament code</div>
          <input class="input" id="lb_code" placeholder="Enter code (e.g., A7K2Q9)" />
          <div class="row">
            <button class="btn btn-primary" id="lb_load" type="button">Load (Live)</button>
            <button class="btn" id="lb_refresh" type="button">Refresh</button>
          </div>
          <div class="hint" id="lb_status">‚Äî</div>
        </div>

        <div class="lb" id="lb_list"></div>

        <div class="row">
          <button class="btn" id="backFromLB" type="button">Back</button>
          <button class="btn" id="copyLB" type="button">Copy Leaderboard</button>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/* ==========================================================
   Charity Tournament App (NO modules)
   - Works on mobile Safari + static hosting
   - Firebase optional (compat scripts)
   ========================================================== */

/* ========= OPTIONAL: Enable Firebase Realtime =========
   Paste your Firebase config into FIREBASE_CONFIG below.

   Example:
   const FIREBASE_CONFIG = {
     apiKey: "‚Ä¶",
     authDomain: "‚Ä¶",
     databaseURL: "https://YOUR-PROJECT-default-rtdb.firebaseio.com",
     projectId: "‚Ä¶",
     storageBucket: "‚Ä¶",
     messagingSenderId: "‚Ä¶",
     appId: "‚Ä¶",
   };
*/
const FIREBASE_CONFIG = null;

/* ========= Helpers ========= */
const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 2200);
}

function show(screenId){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("show"));
  $(screenId).classList.add("show");
}

function uid(len=6){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function nowISO(){ return new Date().toISOString(); }
function safeInt(v){
  const n = Number(String(v||"").trim());
  return Number.isFinite(n) ? Math.round(n) : null;
}
async function sha256Hex(str){
  const enc = new TextEncoder().encode(String(str));
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

function deviceLabel(){
  const key = "ct_device_label_v1";
  let v = localStorage.getItem(key);
  if(!v){
    v = "Device-" + uid(4);
    localStorage.setItem(key, v);
  }
  return v;
}

/* ========= Local storage fallback ========= */
const LOCAL_KEY = "ct_local_state_v2";
function localLoad(){
  try{
    const raw = localStorage.getItem(LOCAL_KEY);
    return raw ? JSON.parse(raw) : { tournaments:{} };
  }catch{
    return { tournaments:{} };
  }
}
function localSave(obj){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(obj));
}

/* ========= Firebase loader (compat) ========= */
let fb = { enabled:false, db:null };

function loadScript(src){
  return new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function initFirebaseIfConfigured(){
  const status = $("rtStatus");
  const hint = $("rtHint");

  if(!FIREBASE_CONFIG){
    fb.enabled = false;
    status.textContent = "Local demo mode (single device)";
    hint.textContent = "Add Firebase config in index.html to enable real-time leaderboard.";
    return;
  }

  try{
    status.textContent = "Loading Firebase‚Ä¶";
    hint.textContent = "";

    await loadScript("https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js");

    firebase.initializeApp(FIREBASE_CONFIG);
    fb.db = firebase.database();
    fb.enabled = true;

    status.textContent = "Real-time enabled (Firebase)";
    hint.textContent = "Leaderboard will update live.";
  }catch(err){
    console.error(err);
    fb.enabled = false;
    status.textContent = "Firebase failed to load";
    hint.textContent = "Check console. Using local demo mode.";
  }
}

/* ========= App state ========= */
const SESSION_KEY = "ct_session_v2";
let activeTournament = null;
let activeCode = "";
let captain = { code:"", teamId:"", captainName:"", unlocked:false };
let scoreCursor = { hole: 1 };

function saveSession(){
  localStorage.setItem(SESSION_KEY, JSON.stringify({ activeCode, captain, scoreCursor }));
}
function loadSession(){
  try{
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}

function defaultTournament(code){
  return {
    code,
    name:"",
    holes:18,
    shotgun:"yes",
    par:[],
    createdAt: nowISO(),
    teams:[],
    scores:{},
    audit:{}
  };
}

function parseParString(str, holes){
  const cleaned = (str||"").trim();
  if(!cleaned) return [];
  const parts = cleaned.split(",").map(x => Number(String(x).trim()));
  const out = [];
  for(let i=0;i<holes;i++){
    const v = parts[i];
    if(Number.isFinite(v) && v>=3 && v<=6) out.push(v);
    else out.push(4);
  }
  return out;
}

/* ========= Storage adapters ========= */
async function loadTournament(code){
  const clean = (code||"").trim().toUpperCase();
  if(!clean) return null;

  if(fb.enabled){
    const snap = await fb.db.ref(`tournaments/${clean}`).get();
    return snap.exists() ? snap.val() : null;
  }else{
    const local = localLoad();
    return local.tournaments[clean] || null;
  }
}

async function saveTournament(code, tour){
  const clean = String(code||"").trim().toUpperCase();
  if(!clean) throw new Error("Missing code");

  if(fb.enabled){
    await fb.db.ref(`tournaments/${clean}`).set(tour);
  }else{
    const local = localLoad();
    local.tournaments[clean] = tour;
    localSave(local);
  }
}

/* ========= UI: Create ========= */
let createDraft = null;

function newTeam(){
  return { id:"T"+uid(5), name:"", startHole:1, pin:"" };
}

function prepCreate(){
  createDraft = {
    code: uid(6),
    name:"",
    holes:18,
    shotgun:"yes",
    par:[],
    teams:[ newTeam(), newTeam() ]
  };

  $("c_name").value = "";
  $("c_holes").value = "18";
  $("c_shotgun").value = "yes";
  $("c_par").value = "";
  $("c_publishHint").textContent = "";

  $("c_code").textContent = createDraft.code;
  renderCreateTeams();
}

function renderCreateTeams(){
  const wrap = $("c_teams");
  wrap.innerHTML = "";

  createDraft.teams.forEach((t, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="stack">
        <div class="field">
          <div class="label">Team ${idx+1} name</div>
          <input class="input" data-tn="${escapeAttr(t.id)}" placeholder="e.g., The Mulligans" value="${escapeAttr(t.name)}" />
        </div>

        <div class="row stretch">
          <div class="field">
            <div class="label">Starting hole</div>
            <input class="input" data-sh="${escapeAttr(t.id)}" inputmode="numeric" placeholder="1-${createDraft.holes}" value="${escapeAttr(String(t.startHole))}" />
            <div class="hint">${createDraft.shotgun==="yes" ? "Shotgun: any hole" : "Non-shotgun: forced to 1"}</div>
          </div>
          <div class="field">
            <div class="label">Captain PIN</div>
            <input class="input" data-pin="${escapeAttr(t.id)}" inputmode="numeric" placeholder="4‚Äì8 digits" value="${escapeAttr(t.pin||"")}" />
          </div>
        </div>

        <div class="row">
          <button class="btn btn-danger" data-del="${escapeAttr(t.id)}" type="button">Remove team</button>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll("[data-tn]").forEach(inp => {
    inp.addEventListener("input", () => {
      const id = inp.getAttribute("data-tn");
      const t = createDraft.teams.find(x => x.id === id);
      if(t) t.name = (inp.value||"").slice(0, 40);
    });
  });

  wrap.querySelectorAll("[data-sh]").forEach(inp => {
    inp.addEventListener("input", () => {
      const id = inp.getAttribute("data-sh");
      const t = createDraft.teams.find(x => x.id === id);
      if(!t) return;
      let v = safeInt(inp.value);
      if(createDraft.shotgun !== "yes") v = 1;
      t.startHole = clamp(v || 1, 1, createDraft.holes);
    });
  });

  wrap.querySelectorAll("[data-pin]").forEach(inp => {
    inp.addEventListener("input", () => {
      const id = inp.getAttribute("data-pin");
      const t = createDraft.teams.find(x => x.id === id);
      if(!t) return;
      t.pin = (inp.value||"").replace(/\D/g,"").slice(0,8);
    });
  });

  wrap.querySelectorAll("[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del");
      createDraft.teams = createDraft.teams.filter(x => x.id !== id);
      renderCreateTeams();
    });
  });
}

async function publishTournament(){
  const name = ($("c_name").value||"").trim();
  const holes = $("c_holes").value === "9" ? 9 : 18;
  const shotgun = $("c_shotgun").value;
  const code = ($("c_code").textContent||"").trim().toUpperCase();
  const par = parseParString($("c_par").value, holes);

  if(!name){ $("c_publishHint").textContent = "Tournament name required."; toast("Add a tournament name."); return; }

  // normalize teams
  const teams = createDraft.teams
    .map(t => ({
      id: t.id,
      name: (t.name||"").trim(),
      startHole: shotgun==="yes" ? clamp(Number(t.startHole)||1, 1, holes) : 1,
      pin: (t.pin||"").replace(/\D/g,"")
    }))
    .filter(t => t.name.length > 0);

  if(teams.length < 2){ $("c_publishHint").textContent = "Add at least 2 teams with names."; toast("Need at least 2 teams."); return; }
  for(const t of teams){
    if(t.pin.length < 4){ $("c_publishHint").textContent = `PIN must be 4‚Äì8 digits for ${t.name}`; toast("Fix captain PINs."); return; }
  }

  const tour = defaultTournament(code);
  tour.name = name;
  tour.holes = holes;
  tour.shotgun = shotgun;
  tour.par = par;
  tour.createdAt = nowISO();

  // hash pin per team (simple client-side check)
  for(const t of teams){
    const pinHash = await sha256Hex(code + ":" + t.id + ":" + t.pin);
    tour.teams.push({ id:t.id, name:t.name, startHole:t.startHole, pinHash, createdAt: nowISO() });
    tour.scores[t.id] = {};
    tour.audit[t.id] = {};
  }

  await saveTournament(code, tour);

  activeTournament = tour;
  activeCode = code;
  saveSession();

  $("c_publishHint").textContent = fb.enabled ? "Published (real-time ON). Share the code!" : "Saved locally (real-time OFF).";
  $("lb_code").value = code;
  $("j_code").value = code;

  toast("Tournament published.");
}

/* ========= UI: Captain ========= */
function fillTeamsSelect(tour){
  const opts = tour.teams
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(t => `<option value="${escapeAttr(t.id)}">${escapeHtml(t.name)} (Start H${t.startHole})</option>`)
    .join("");
  $("j_team").innerHTML = `<option value="">Select team</option>` + opts;
}

async function captainLoadCode(){
  const code = ($("j_code").value||"").trim().toUpperCase();
  const tour = await loadTournament(code);
  if(!tour){ toast("Tournament not found."); $("j_team").innerHTML = `<option value="">Load tournament first</option>`; return; }
  activeTournament = tour;
  activeCode = code;
  fillTeamsSelect(tour);
  saveSession();
  toast("Tournament loaded.");
}

async function captainUnlock(){
  const code = ($("j_code").value||"").trim().toUpperCase();
  const teamId = $("j_team").value;
  const pin = ($("j_pin").value||"").replace(/\D/g,"");
  const cname = ($("j_captainName").value||"").trim().slice(0, 30);

  if(!code || !teamId || pin.length < 4){ toast("Enter code, team, and PIN."); return; }

  const tour = await loadTournament(code);
  if(!tour){ toast("Tournament not found."); return; }

  const team = tour.teams.find(t => t.id === teamId);
  if(!team){ toast("Team not found."); return; }

  const hash = await sha256Hex(code + ":" + teamId + ":" + pin);
  if(hash !== team.pinHash){ toast("Incorrect PIN."); return; }

  captain = { code, teamId, captainName: cname || "Captain", unlocked:true };
  activeTournament = tour;
  activeCode = code;
  scoreCursor.hole = clamp(Number(team.startHole)||1, 1, tour.holes);
  saveSession();

  toast("Unlocked.");
  await renderScoreScreen();
  show("screen-score");
}

/* ========= Score screen ========= */
function latestAuditForHole(tour, teamId, hole){
  return tour.audit?.[teamId]?.[hole] || null;
}

async function renderScoreScreen(){
  const tour = await loadTournament(captain.code);
  if(!tour){ toast("Tournament not found."); show("screen-captain-join"); return; }
  activeTournament = tour;

  const team = tour.teams.find(t => t.id === captain.teamId);
  if(!team){ toast("Team not found."); show("screen-captain-join"); return; }

  const hole = clamp(scoreCursor.hole, 1, tour.holes);
  scoreCursor.hole = hole;

  $("s_title").textContent = team.name;
  $("s_sub").textContent = `${tour.name} ‚Ä¢ Code ${tour.code}`;
  $("s_hole").textContent = String(hole);
  $("s_holeMeta").textContent = `Start H${team.startHole} ‚Ä¢ Holes ${tour.holes} ‚Ä¢ Shotgun ${tour.shotgun==="yes" ? "Yes" : "No"} ‚Ä¢ ${deviceLabel()}`;

  const existing = tour.scores?.[team.id]?.[hole];
  $("s_score").value = (existing === undefined || existing === null) ? "" : String(existing);

  const aud = latestAuditForHole(tour, team.id, hole);
  $("s_audit").textContent = aud
    ? `${aud.by} ‚Ä¢ ${aud.device} ‚Ä¢ ${new Date(aud.at).toLocaleString()}`
    : "No submission yet for this hole.";
}

async function submitHoleScore(){
  if(!captain.unlocked){ toast("Locked."); return; }
  const strokes = safeInt($("s_score").value);
  if(strokes === null || strokes < 1 || strokes > 30){ toast("Enter a valid score (1‚Äì30)."); return; }

  const code = captain.code;
  const teamId = captain.teamId;
  const hole = scoreCursor.hole;

  const tour = await loadTournament(code);
  if(!tour){ toast("Tournament not found."); return; }

  tour.scores[teamId] = tour.scores[teamId] || {};
  tour.audit[teamId] = tour.audit[teamId] || {};

  tour.scores[teamId][hole] = strokes;
  tour.audit[teamId][hole] = {
    by: captain.captainName,
    device: deviceLabel(),
    at: nowISO()
  };

  await saveTournament(code, tour);
  activeTournament = tour;

  toast(`Saved hole ${hole}.`);
  await renderScoreScreen();
}

/* ========= Leaderboard ========= */
let lbUnsub = null;

function sumScores(tour, teamId){
  const scores = tour.scores?.[teamId] || {};
  let sum = 0, thru = 0;
  for(let h=1; h<=tour.holes; h++){
    const v = scores[h];
    if(v === undefined || v === null) continue;
    sum += Number(v) || 0;
    thru++;
  }
  return { sum, thru };
}

function toPar(tour, teamId){
  if(!tour.par || !tour.par.length) return null;
  const scores = tour.scores?.[teamId] || {};
  let sum = 0, parSum = 0, thru = 0;
  for(let h=1; h<=tour.holes; h++){
    const v = scores[h];
    if(v === undefined || v === null) continue;
    sum += Number(v) || 0;
    parSum += Number(tour.par[h-1] || 4);
    thru++;
  }
  return { diff: sum - parSum, thru };
}

function fmtToPar(diff){
  if(diff === 0) return "E";
  return diff > 0 ? `+${diff}` : `${diff}`;
}

function latestAuditLine(tour, teamId){
  const aud = tour.audit?.[teamId] || {};
  let latest = null;
  Object.entries(aud).forEach(([holeStr, rec]) => {
    if(!rec || !rec.at) return;
    const t = new Date(rec.at).getTime();
    if(!latest || t > latest.t){
      latest = { t, hole: holeStr, by: rec.by || "Captain", device: rec.device || "Device", at: rec.at };
    }
  });
  if(!latest) return "No updates yet";
  return `Updated H${latest.hole} ‚Ä¢ ${latest.by} ‚Ä¢ ${new Date(latest.at).toLocaleTimeString()}`;
}

function renderLeaderboard(tour){
  $("lb_title").textContent = "Leaderboard";
  $("lb_sub").textContent = `${tour.name} ‚Ä¢ Code ${tour.code} ‚Ä¢ Holes ${tour.holes} ‚Ä¢ ${tour.shotgun==="yes" ? "Shotgun" : "Start H1"}`;

  const rows = tour.teams.map(team => {
    const totals = sumScores(tour, team.id);
    const tp = toPar(tour, team.id);
    return {
      team,
      sum: totals.sum,
      thru: totals.thru,
      toPar: tp ? tp.diff : null,
      audit: latestAuditLine(tour, team.id)
    };
  });

  rows.sort((a,b) => {
    if(a.thru===0 && b.thru===0) return a.team.name.localeCompare(b.team.name);
    if(a.thru===0) return 1;
    if(b.thru===0) return -1;
    if(a.sum!==b.sum) return a.sum-b.sum;
    if(a.thru!==b.thru) return b.thru-a.thru;
    return a.team.name.localeCompare(b.team.name);
  });

  const list = $("lb_list");
  list.innerHTML = "";
  rows.forEach((r, idx) => {
    const div = document.createElement("div");
    div.className = "lb-item";
    div.innerHTML = `
      <div class="lb-left">
        <div class="lb-team">${idx+1}. ${escapeHtml(r.team.name)}</div>
        <div class="lb-meta">
          <span class="pill">Start H${r.team.startHole}</span>
          <span class="pill">Thru ${r.thru}/${tour.holes}</span>
          ${r.toPar===null ? "" : `<span class="pill">To Par ${escapeHtml(fmtToPar(r.toPar))}</span>`}
        </div>
        <div class="hint" style="margin-top:6px;">${escapeHtml(r.audit)}</div>
      </div>
      <div class="scorebox">
        <div class="score">${r.thru===0 ? "‚Äî" : String(r.sum)}</div>
        <div class="small">${r.thru===0 ? "No scores" : "Total strokes"}</div>
      </div>
    `;
    list.appendChild(div);
  });
}

async function loadLeaderboardOnce(code){
  const c = (code||"").trim().toUpperCase();
  if(!c){ toast("Enter a code."); return; }
  const tour = await loadTournament(c);
  if(!tour){ $("lb_status").textContent = "Tournament not found."; toast("Tournament not found."); return; }
  $("lb_status").textContent = fb.enabled ? "Live available. Tap Load (Live) to subscribe." : "Local demo mode (not live).";
  renderLeaderboard(tour);
}

function startLiveLeaderboard(code){
  if(!fb.enabled) return;
  if(lbUnsub){ try{ lbUnsub(); }catch{} lbUnsub = null; }

  const ref = fb.db.ref(`tournaments/${code}`);
  const cb = (snap) => {
    if(!snap.exists()) return;
    renderLeaderboard(snap.val());
    $("lb_status").textContent = "Live updates ON.";
  };
  ref.on("value", cb);
  lbUnsub = () => ref.off("value", cb);
}

/* ========= Clipboard ========= */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

/* ========= Wire events ========= */
function wireUI(){
  // nav
  $("btnHome").addEventListener("click", () => show("screen-home"));
  $("goCreate").addEventListener("click", () => { prepCreate(); show("screen-create"); });
  $("goCaptain").addEventListener("click", () => { show("screen-captain-join"); });
  $("goLeaderboard").addEventListener("click", () => { show("screen-leaderboard"); });

  $("backFromCreate").addEventListener("click", () => show("screen-home"));
  $("goLeaderboardFromCreate").addEventListener("click", () => show("screen-leaderboard"));
  $("backFromJoin").addEventListener("click", () => show("screen-home"));
  $("backFromLB").addEventListener("click", () => show("screen-home"));
  $("s_toLB").addEventListener("click", () => show("screen-leaderboard"));

  // reset
  $("btnResetLocal").addEventListener("click", () => {
    localStorage.removeItem(LOCAL_KEY);
    localStorage.removeItem(SESSION_KEY);
    toast("Local reset done.");
    activeTournament = null;
    activeCode = "";
    captain = { code:"", teamId:"", captainName:"", unlocked:false };
    scoreCursor = { hole: 1 };
    $("rtStatus").textContent = "Initialized‚Ä¶";
    $("rtHint").textContent = "";
    show("screen-home");
    location.reload(); // simplest clean reset
  });

  // create
  $("c_regen").addEventListener("click", () => { $("c_code").textContent = uid(6); toast("New code generated."); });
  $("c_copycode").addEventListener("click", async () => { await copyText($("c_code").textContent.trim()); toast("Code copied."); });
  $("c_addteam").addEventListener("click", () => { createDraft.teams.push(newTeam()); renderCreateTeams(); toast("Team added."); });
  $("c_holes").addEventListener("change", () => {
    createDraft.holes = $("c_holes").value === "9" ? 9 : 18;
    createDraft.teams.forEach(t => t.startHole = clamp(t.startHole||1,1,createDraft.holes));
    renderCreateTeams();
  });
  $("c_shotgun").addEventListener("change", () => {
    createDraft.shotgun = $("c_shotgun").value;
    if(createDraft.shotgun !== "yes") createDraft.teams.forEach(t => t.startHole = 1);
    renderCreateTeams();
  });
  $("c_publish").addEventListener("click", () => publishTournament().catch(e => { console.error(e); toast("Publish failed."); }));

  // captain
  $("j_code").addEventListener("change", () => captainLoadCode());
  $("j_unlock").addEventListener("click", () => captainUnlock().catch(e => { console.error(e); toast("Unlock failed."); }));

  // score
  $("s_prev").addEventListener("click", async () => { scoreCursor.hole = clamp(scoreCursor.hole-1,1,(activeTournament?.holes||18)); saveSession(); await renderScoreScreen(); });
  $("s_next").addEventListener("click", async () => { scoreCursor.hole = clamp(scoreCursor.hole+1,1,(activeTournament?.holes||18)); saveSession(); await renderScoreScreen(); });
  $("s_submit").addEventListener("click", () => submitHoleScore().catch(e => { console.error(e); toast("Submit failed."); }));
  $("s_lock").addEventListener("click", () => { captain = { code:"", teamId:"", captainName:"", unlocked:false }; saveSession(); toast("Locked."); show("screen-captain-join"); });

  // leaderboard
  $("lb_load").addEventListener("click", async () => {
    const code = ($("lb_code").value||"").trim().toUpperCase();
    await loadLeaderboardOnce(code);
    if(fb.enabled && code){
      startLiveLeaderboard(code);
      $("lb_status").textContent = "Live updates ON.";
    }
  });
  $("lb_refresh").addEventListener("click", async () => {
    const code = ($("lb_code").value||"").trim().toUpperCase();
    await loadLeaderboardOnce(code);
    toast("Refreshed.");
  });
  $("copyLB").addEventListener("click", async () => {
    const code = ($("lb_code").value||"").trim().toUpperCase();
    const tour = await loadTournament(code);
    if(!tour){ toast("Load a tournament first."); return; }
    const rows = tour.teams.map(team => {
      const totals = sumScores(tour, team.id);
      const tp = toPar(tour, team.id);
      return { name: team.name, start: team.startHole, thru: totals.thru, total: totals.thru===0 ? "‚Äî" : String(totals.sum), toPar: tp ? fmtToPar(tp.diff) : "" };
    }).sort((a,b) => (a.total==="‚Äî") - (b.total==="‚Äî") || (Number(a.total||999999) - Number(b.total||999999)));

    let text = `${tour.name}\nCode: ${tour.code}\n\n`;
    rows.forEach((r,i) => {
      text += `${i+1}. ${r.name} ‚Ä¢ Start H${r.start} ‚Ä¢ Thru ${r.thru}/${tour.holes} ‚Ä¢ Total ${r.total}${r.toPar ? " ("+r.toPar+")" : ""}\n`;
    });
    await copyText(text.trim());
    toast("Copied.");
  });
}

/* ========= Boot ========= */
(async function boot(){
  // Make sure JS is definitely running (this fixes your ‚ÄúChecking‚Ä¶‚Äù issue)
  $("rtStatus").textContent = "Booting‚Ä¶";

  wireUI();
  await initFirebaseIfConfigured();

  // restore session
  const sess = loadSession();
  if(sess){
    activeCode = (sess.activeCode||"").toUpperCase();
    captain = sess.captain || captain;
    scoreCursor = sess.scoreCursor || { hole: 1 };

    if(activeCode){
      $("lb_code").value = activeCode;
      $("j_code").value = activeCode;
    }

    if(captain?.unlocked && captain.code && captain.teamId){
      await renderScoreScreen();
      show("screen-score");
      return;
    }
  }

  // default create draft so Create screen works immediately
  prepCreate();
  show("screen-home");
})();
</script>
</body>
</html>