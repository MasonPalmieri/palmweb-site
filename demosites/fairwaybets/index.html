<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charity Tournament ‚Äî Live Leaderboard</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Captain-submitted scoring with shotgun starts and a live leaderboard. Mobile-first and simple." />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#556173;
      --hair: rgba(15,23,42,.08);
      --border: rgba(15,23,42,.12);
      --panel: rgba(255,255,255,.80);
      --blue:#1d79c6;
      --green:#2cab4b;
      --danger:#dc2626;
      --warn:#f59e0b;
      --shadow2: 0 10px 30px rgba(15,23,42,.08);
      --radius: 20px;
      --max: 860px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(29,121,198,.14), transparent 60%),
        radial-gradient(1200px 520px at 90% 0%, rgba(44,171,75,.10), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.03), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    a{ color:inherit; text-decoration:none; }
    .container{ max-width: var(--max); margin:0 auto; padding: 0 16px; }

    header{
      position: sticky; top: 0; z-index: 50;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--hair);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; padding: 12px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width: 36px; height: 36px;
      border-radius: 14px;
      border: 1px solid var(--hair);
      background:
        radial-gradient(14px 14px at 30% 35%, rgba(29,121,198,.26), transparent 70%),
        radial-gradient(14px 14px at 68% 58%, rgba(44,171,75,.22), transparent 70%),
        rgba(15,23,42,.02);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
    }
    .brand-title{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .brand-title strong{ font-weight: 950; font-size: 13.5px; letter-spacing: .1px; }
    .brand-title span{
      font-weight: 800; font-size: 12px; color: var(--muted);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 380px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      white-space: nowrap;
      font-size: 13px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--green));
      box-shadow: 0 18px 44px rgba(29,121,198,.18);
    }
    .btn-danger{
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.30);
      color: rgba(127,29,29,.95);
    }
    .btn-warn{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.35);
      color: rgba(120,53,15,.95);
    }

    main{ padding: 16px 0 32px; }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position: relative;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 240px at 12% 16%, rgba(29,121,198,.08), transparent 70%),
        radial-gradient(420px 240px at 98% 0%, rgba(44,171,75,.06), transparent 70%);
      pointer-events:none;
    }
    .panel > *{ position: relative; }

    .kicker{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 900;
      color: rgba(11,18,32,.86);
      width: fit-content;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: linear-gradient(135deg, var(--blue), var(--green));
    }

    h1{
      margin: 10px 0 6px;
      font-size: 24px;
      letter-spacing: -0.6px;
      line-height: 1.05;
      font-weight: 950;
    }
    .lead{
      margin: 0;
      color: rgba(11,18,32,.70);
      font-weight: 850;
      font-size: 13.5px;
      line-height: 1.45;
    }

    .screen{ display:none; }
    .screen.show{ display:block; }

    .stack{ display:flex; flex-direction:column; gap: 10px; }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .row.stretch > *{ flex: 1 1 180px; }

    .field{ display:flex; flex-direction:column; gap: 6px; }
    .label{ font-weight: 950; font-size: 12px; color: rgba(11,18,32,.82); }
    .hint{ font-weight: 800; font-size: 12px; color: rgba(11,18,32,.60); margin-top: -2px; }
    .input, .select{
      width:100%;
      padding: 13px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      color: rgba(11,18,32,.92);
      outline:none;
      font-weight: 900;
      font-size: 15px;
    }
    .input:focus, .select:focus{
      border-color: rgba(29,121,198,.55);
      box-shadow: 0 0 0 4px rgba(29,121,198,.10);
    }

    .hr{ height:1px; background: rgba(15,23,42,.08); margin: 6px 0; }

    .card{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.80);
      border-radius: 16px;
      padding: 12px;
    }

    .big-num{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: -1px;
      line-height: 1;
      margin: 4px 0 0;
    }
    .sub{
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Leaderboard */
    .lb{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .lb-item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 12px;
    }
    .lb-left{ min-width:0; }
    .lb-team{
      font-weight: 950;
      letter-spacing: -0.2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 52vw;
    }
    .lb-meta{
      margin-top: 4px;
      font-weight: 850;
      color: rgba(11,18,32,.62);
      font-size: 12px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,18,32,.78);
    }
    .scorebox{
      text-align:right;
      flex: 0 0 auto;
    }
    .scorebox .score{
      font-weight: 950;
      font-size: 26px;
      letter-spacing: -0.4px;
      line-height: 1.05;
    }
    .scorebox .small{
      font-weight: 850;
      color: rgba(11,18,32,.60);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(640px, calc(100% - 24px));
      z-index: 2000;
      display:none;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 55px rgba(15,23,42,.18);
      color: rgba(11,18,32,.90);
      font-weight: 900;
      font-size: 13px;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
<header>
  <div class="container nav">
    <a class="brand" href="../../demos.html" aria-label="Back to Demos">
      <div class="badge">üèÜ</div>
      <div class="brand-title">
        <strong>Charity Tournament</strong>
        <span>Captain scoring + live leaderboard</span>
      </div>
    </a>
    <div class="row">
      <button class="btn" id="btnHome" type="button">Home</button>
      <button class="btn btn-warn" id="btnResetLocal" type="button" title="Clears local device cache only">Reset</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="panel">
    <!-- HOME -->
    <div class="screen show" id="screen-home">
      <div class="kicker"><span class="dot"></span> Mobile-first ‚Ä¢ One thing per screen</div>
      <h1>Live Tournament Scoring</h1>
      <p class="lead">
        One captain per team submits hole-by-hole scores. Everyone can open the leaderboard and watch it update.
      </p>

      <div class="hr"></div>

      <div class="stack">
        <button class="btn btn-primary" id="goCreate" type="button">Create Tournament</button>
        <button class="btn" id="goCaptain" type="button">Captain: Enter Scores</button>
        <button class="btn" id="goLeaderboard" type="button">View Leaderboard</button>

        <div class="card">
          <div class="label">Real-time mode</div>
          <div class="hint" id="rtStatus">Checking‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- CREATE -->
    <div class="screen" id="screen-create">
      <div class="kicker"><span class="dot"></span> Setup tournament</div>
      <h1>Create Tournament</h1>
      <p class="lead">Make a tournament code, add teams, set shotgun starts, and assign captain PINs.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament name</div>
          <input class="input" id="c_name" placeholder="e.g., Rotary Charity Scramble" />
        </div>

        <div class="row stretch">
          <div class="field">
            <div class="label">Holes</div>
            <select class="select" id="c_holes">
              <option value="9">9</option>
              <option value="18" selected>18</option>
            </select>
          </div>

          <div class="field">
            <div class="label">Shotgun start?</div>
            <select class="select" id="c_shotgun">
              <option value="yes" selected>Yes</option>
              <option value="no">No (starts on hole 1)</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="label">Optional: course par (comma-separated)</div>
          <input class="input" id="c_par" placeholder="18 numbers (optional). Example: 4,4,3,5,..." />
          <div class="hint">If you include par, leaderboard can show ‚Äúto par‚Äù. Leave blank if not needed.</div>
        </div>

        <div class="card">
          <div class="label">Tournament code</div>
          <div class="hint">Share this code with captains and participants.</div>
          <div class="big-num" id="c_code">‚Äî</div>
          <div class="row">
            <button class="btn" id="c_regen" type="button">Regenerate</button>
            <button class="btn" id="c_copycode" type="button">Copy code</button>
          </div>
        </div>

        <div class="card">
          <div class="label">Teams (2‚Äì36 typical)</div>
          <div class="hint">Each team needs: Team name, Starting hole, Captain PIN (4‚Äì8 digits).</div>
          <div class="stack" id="c_teams"></div>
          <div class="row">
            <button class="btn" id="c_addteam" type="button">Add Team</button>
            <button class="btn btn-primary" id="c_publish" type="button">Publish Tournament</button>
          </div>
          <div class="hint" id="c_publishHint"></div>
        </div>

        <div class="row">
          <button class="btn" id="backFromCreate" type="button">Back</button>
          <button class="btn" id="goLeaderboardFromCreate" type="button">View Leaderboard</button>
        </div>
      </div>
    </div>

    <!-- CAPTAIN JOIN -->
    <div class="screen" id="screen-captain-join">
      <div class="kicker"><span class="dot"></span> Captain sign-in</div>
      <h1>Captain: Enter Scores</h1>
      <p class="lead">Enter tournament code, pick your team, then unlock with the captain PIN.</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="field">
          <div class="label">Tournament code</div>
          <input class="input" id="j_code" placeholder="e.g., A7K2Q9" />
        </div>

        <div class="field">
          <div class="label">Team</div>
          <select class="select" id="j_team">
            <option value="">Load tournament first</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Captain PIN</div>
          <input class="input" id="j_pin" inputmode="numeric" placeholder="4‚Äì8 digits" />
        </div>

        <div class="field">
          <div class="label">Captain name (for audit)</div>
          <input class="input" id="j_captainName" placeholder="e.g., Mason" />
          <div class="hint">Shows on last-updated audit line.</div>
        </div>

        <button class="btn btn-primary" id="j_unlock" type="button">Unlock Score Entry</button>
        <button class="btn" id="backFromJoin" type="button">Back</button>

        <div class="card">
          <div class="label">Anti-cheat basics</div>
          <div class="hint">
            Scores require the captain PIN. Each submission records timestamp + captain name + device label.
            If someone keeps ‚Äúediting‚Äù holes, the update timestamps make it obvious.
          </div>
        </div>
      </div>
    </div>

    <!-- SCORE ENTRY (one hole) -->
    <div class="screen" id="screen-score">
      <div class="kicker"><span class="dot"></span> One hole at a time</div>
      <h1 id="s_title">Score Entry</h1>
      <p class="lead" id="s_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Current hole</div>
          <div class="big-num" id="s_hole">1</div>
          <div class="sub" id="s_holeMeta">Starting hole: ‚Äî</div>
        </div>

        <div class="field">
          <div class="label">Team score for this hole</div>
          <input class="input" id="s_score" inputmode="numeric" placeholder="Enter strokes (e.g., 4)" />
          <div class="hint">Enter gross strokes for the team on this hole.</div>
        </div>

        <button class="btn btn-primary" id="s_submit" type="button">Submit Hole Score</button>

        <div class="row">
          <button class="btn" id="s_prev" type="button">‚óÄ Prev hole</button>
          <button class="btn" id="s_next" type="button">Next hole ‚ñ∂</button>
        </div>

        <div class="card" id="s_auditCard">
          <div class="label">Last update</div>
          <div class="hint" id="s_audit">‚Äî</div>
        </div>

        <div class="row">
          <button class="btn" id="s_toLB" type="button">View Leaderboard</button>
          <button class="btn btn-danger" id="s_lock" type="button">Lock / Switch Team</button>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="screen" id="screen-leaderboard">
      <div class="kicker"><span class="dot"></span> Live leaderboard</div>
      <h1 id="lb_title">Leaderboard</h1>
      <p class="lead" id="lb_sub">‚Äî</p>

      <div class="hr"></div>

      <div class="stack">
        <div class="card">
          <div class="label">Tournament code</div>
          <input class="input" id="lb_code" placeholder="Enter code (e.g., A7K2Q9)" />
          <div class="row">
            <button class="btn btn-primary" id="lb_load" type="button">Load Leaderboard</button>
            <button class="btn" id="lb_refresh" type="button">Refresh</button>
          </div>
          <div class="hint" id="lb_status">‚Äî</div>
        </div>

        <div class="lb" id="lb_list"></div>

        <div class="row">
          <button class="btn" id="backFromLB" type="button">Back</button>
          <button class="btn" id="copyLB" type="button">Copy Leaderboard</button>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Firebase (optional) -->
<script type="module">
  /* ==========================================================
     Charity Tournament App ‚Äî Captain scoring + live leaderboard
     - One thing per screen
     - Shotgun start support (team starting hole)
     - Real-time via Firebase Realtime Database (optional)
     ========================================================== */

  // ========= TO ENABLE REAL-TIME =========
  // 1) Create Firebase project
  // 2) Enable Realtime Database
  // 3) Paste your config below
  // 4) Set RULES (example in comment near the bottom)
  //
  // If you leave FIREBASE_CONFIG null, app runs in local demo mode
  // (single device only).

  const FIREBASE_CONFIG = null;
  // Example:
  // const FIREBASE_CONFIG = {
  //   apiKey: "‚Ä¶",
  //   authDomain: "‚Ä¶",
  //   databaseURL: "https://YOUR-PROJECT-default-rtdb.firebaseio.com",
  //   projectId: "‚Ä¶",
  //   storageBucket: "‚Ä¶",
  //   messagingSenderId: "‚Ä¶",
  //   appId: "‚Ä¶",
  // };

  // ========= Imports only if config exists =========
  let fb = { enabled:false };
  if(FIREBASE_CONFIG){
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
    const {
      getDatabase, ref, set, get, onValue, update, push, child, off
    } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js");

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getDatabase(app);

    fb = { enabled:true, db, ref, set, get, onValue, update, push, child, off };
  }

  // ========= Helpers =========
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  function show(screenId){
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("show"));
    $(screenId).classList.add("show");
  }

  function uid(len=6){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function nowISO(){
    return new Date().toISOString();
  }

  function safeInt(v){
    const n = Number(String(v||"").trim());
    return Number.isFinite(n) ? Math.round(n) : null;
  }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(String(str));
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function deviceLabel(){
    const key = "ct_device_label_v1";
    let v = localStorage.getItem(key);
    if(!v){
      v = "Device-" + uid(4);
      localStorage.setItem(key, v);
    }
    return v;
  }

  // ========= Local fallback storage =========
  const LOCAL_KEY = "ct_local_state_v1";
  function localLoad(){